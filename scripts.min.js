var config={model3d:{sides:{steps:30,thickness:.03,extraLength:.1,minHeight:.015},slats:{defaultLength:.015,thickness:.015,space:.01},struts:{side:.08,smallSide:.04,maximumDistance:.3},surface:{thickness:.015}},units:null,UNIT_METERS:"m",UNIT_FEET:"ft",UNIT_DEGREES:"Â°"};var EditorState=function(e){this.state_=e?EditorState.READ_ONLY:undefined};EditorState.prototype.setState=function(e,t){t=t||{};var r=[];if(this.state_==EditorState.NEW){r=[EditorState.NEW,EditorState.READY]}else if(this.state_==EditorState.READY){r=[EditorState.NEW,EditorState.SAVED]}else if(this.state_==EditorState.SAVED){r=[EditorState.NEW,EditorState.READY,EditorState.READ_ONLY]}else if(this.state_==EditorState.READ_ONLY){r=[EditorState.NEW,EditorState.READY]}if(r.indexOf(e)===-1&&this.state_){throw new Error('Transition to state from state "'+this.state_+'" to "'+e+'" not allowed.')}this.setState_(e,t)};EditorState.prototype.setState_=function(e,t){var r=this.state_;this.state_=e;console.log("New state:",e);var i=new CustomEvent("published-state-change",{detail:{state:e,previousState:r,data:t}});document.body.dispatchEvent(i)};EditorState.prototype.getState=function(){return this.state_};EditorState.NEW="new";EditorState.READY="ready";EditorState.SAVED="saved";EditorState.READ_ONLY="read-only";var ImageList=function(){this.images={side:"./images/textures/wood1_256.jpg",slat:"./images/textures//wood2_256.jpg",strut:"./images/textures//wood3_256.jpg"}};ImageList.prototype.getImageUrl=function(e){return this.images[e]};var Utils={};Utils.setupUVMapping=function(e,t,r){if(typeof t=="undefined"){t="x"}if(typeof r=="undefined"){r="y"}var a=-Infinity,n=Infinity,s=-Infinity,o=Infinity,c=0,h=0;for(i=0,l=e.vertices.length;i<l;i++){if(a<e.vertices[i][t]){a=e.vertices[i][t]}if(s<e.vertices[i][r]){s=e.vertices[i][r]}if(n>e.vertices[i][t]){n=e.vertices[i][t]}if(o>e.vertices[i][r]){o=e.vertices[i][r]}}c=a-n;h=s-o;e.faceVertexUvs=[[]];for(i=0,l=e.faces.length;i<l;i++){var u=e.faces[i];var d=[e.vertices[u.a],e.vertices[u.b],e.vertices[u.c]];var p=d.map(function(e){return new THREE.Vector2((e[t]+c/2)/(2*c),e[r]/h)});e.faceVertexUvs[0].push(p)}};Utils.iterateOverParts=function(e,t){for(var r in e){if(e.hasOwnProperty(r)){if(Array.isArray(e[r])){e[r].forEach(function(e){t(e)})}else{t(e[r],r)}}}};Utils.makeAvailableForDebug=function(e,t){window.debugInfo=window.debugInfo||{};window.debugInfo[e]=t};Utils.createBoxBodyFromMesh=function(e,t){var r=new THREE.BoundingBoxHelper(e,0);r.update();var i=Math.abs((r.box.max.x-r.box.min.x)/2);var a=Math.abs((r.box.max.y-r.box.min.y)/2);var n=Math.abs((r.box.max.z-r.box.min.z)/2);var s=new CANNON.Box(new CANNON.Vec3(i,a,n));var o=new CANNON.RigidBody(t,s);return o};Utils.metersToDumb=function(e){var t=.3048;var r=.0253;var i=Math.floor(e/t);var a=Math.floor(e%t/r);return i+"ft"+a};var KickerIO=function(){this.params=["height","width","angle"];this.results=["arc","radius","length"];this.rep=["repType","textured"];this.context=["annotations","grid","mountainboard","rider"];this.export=["fill","borders"];this.save=["description","title","id"];this.supported=this.params.concat(this.results,this.rep,this.context,this.export,this.save);this.floatValues=["height","width","angle","arc","radius","length"];this.saveValues=this.params.concat(this.save,this.rep,this.context,this.save,this.export)};KickerIO.prototype.init=function(){throw new Error("KickerIO.init not implemented")};KickerIO.prototype.get=function(e){throw new Error("KickerIO.get not implemented")};KickerIO.prototype.set=function(e,t){throw new Error("KickerIO.set not implemented")};KickerIO.prototype.getDataForSaving=function(){var e={};var t=this.get.bind(this);this.saveValues.forEach(function(r){e[r]=t(r)});if(e["id"]){delete e["id"]}return e};var KickerIOFromDOM=function(e,t,r,i,a,n,s){KickerIO.call(this);this.paramsEl=e;this.resultsEl=t;this.repEl=r;this.contextEl=i;this.exportEl=a;this.saveEl=n;this.init(s)};KickerIOFromDOM.prototype=new KickerIO;KickerIOFromDOM.prototype.init=function(e){if(!e){return}for(name in e){this.set(name,e[name])}};KickerIOFromDOM.prototype.get=function(e){switch(e){case"height":case"width":case"angle":return parseFloat(this.paramsEl[e]);case"repType":return this.repEl[e];case"description":case"title":case"id":return this.saveEl[e];case"textured":return!!this.repEl[e];case"fill":case"borders":return!!this.exportEl[e];case"annotations":case"grid":case"mountainboard":case"rider":return!!this.contextEl[e];default:throw new Error("Get not supported:"+e)}};KickerIOFromDOM.prototype.set=function(e,t){if(this.supported.indexOf(e)==-1){throw new Error("Set not supported:"+e)}var r=this.resultsEl;if(this.params.indexOf(e)!==-1){r=this.paramsEl}else if(this.rep.indexOf(e)!==-1){r=this.repEl}else if(this.context.indexOf(e)!==-1){r=this.contextEl}else if(this.export.indexOf(e)!==-1){r=this.exportEl}else if(this.save.indexOf(e)!==-1){r=this.saveEl}if(this.floatValues.indexOf(e)!==-1){r[e]=parseFloat(t,10).toFixed(2)}else{r[e]=t}};var KickerIOFromJSON=function(e){KickerIO.call(this);if(typeof e==="string"){this.storage=JSON.parse(JSONString)}else{this.storage=e}};KickerIOFromJSON.prototype=new KickerIO;KickerIOFromJSON.prototype.get=function(e){switch(e){case"height":case"width":case"angle":return parseFloat(this.storage[e]);case"repType":case"description":case"id":return this.storage[e];case"annotations":case"borders":case"fill":case"grid":case"mountainboard":case"rider":case"textured":return!!this.storage[e];default:throw new Error("Get not supported:"+e)}};KickerIOFromJSON.prototype.set=function(e,t){if(this.supported.indexOf(e)==-1){throw new Error("Set not supported:"+e)}if(this.floatValues.indexOf(e)!==-1){this.storage[e]=t.toFixed(2)}else{this.storage[e]=t}};var KickerModel=function(e){this.data=e;this.processDataParameters()};KickerModel.prototype.processDataParameters=function(){this.readData();this.calculate();this.refreshData()};KickerModel.prototype.readData=function(){this.height=this.data.get("height");this.width=this.data.get("width");this.angle=this.data.get("angle")};KickerModel.prototype.refreshData=function(){this.data.set("radius",this.radius);this.data.set("length",this.length);this.data.set("arc",this.arc)};KickerModel.prototype.calculate=function(){this.radius=this.calculateRadius(this.height,this.angle);this.length=this.calculateLength(this.height,this.angle);this.arc=this.calculateArc(this.radius,this.angle)};KickerModel.prototype.calculateRadius=function(e,t){var r=t*Math.PI/180,i=e/(1-Math.cos(r));return i};KickerModel.prototype.calculateLength=function(e,t){var r=t*Math.PI/180,i=e*Math.sin(r)/(1-Math.cos(r))+config.model3d.sides.extraLength;return i};KickerModel.prototype.calculateArc=function(e,t){var r=e*t*Math.PI/180;return r};KickerModel.prototype.create3dObject=function(e,t,r){var i=this.calculateSidePoints_(this.angle,this.radius,e);var a=this.calculateSurfacePoints_(this.angle,this.radius,e,e.model3d.surface.thickness);this.representation3d=new Representation3D(this.data,i,a,this.length,this.angle,this.arc,this.radius,this.width,this.height,t,e,r);return this.representation3d};KickerModel.prototype.calculateSidePoints_=function(e,t,r){var i=r.model3d.sides.minHeight;var a=Math.acos(1-i/this.radius);var n=this.calculatePoints_(a,i,e,t,r);var s=n[n.length-1];var o=r.model3d.sides.extraLength;n.push([s[0]+o,s[1]]);n.push([s[0]+o,0]);n.unshift([n[0][0],0]);return n};KickerModel.prototype.calculateSurfacePoints_=function(e,t,r,a){var n=this.calculatePoints_(0,0,e,t,r);var s=n.length;var o=e*Math.PI/180;for(l=n.length-1,i=l;i>=0;i--){var c=i/s*o;x=n[i][0]-a*Math.sin(c);y=n[i][1]+a*Math.cos(c);n.push([x,y])}return n};KickerModel.prototype.calculatePoints_=function(e,t,r,i,a,n){var s=r*Math.PI/180;var o=a.model3d.sides.steps;var l,c,h;var u=[];for(var d=0;d<=o;d++){l=d/o*s;c=i*Math.sin(l);h=i*(1-Math.cos(l));if(h<t){continue}u.push([c,h])}return u};KickerModel.prototype.getRepresentation3d=function(){return this.representation3d};var Kicker=function(e){this.model=e};Kicker.prototype.refresh=function(){this.model.processDataParameters()};Kicker.prototype.getRepresentation3d=function(){return this.model.getRepresentation3d()};THREE.ColladaLoader=function(){var e=null;var t=null;var r;var i;var a=null;var n={};var l={};var c={};var h={};var u={};var d={};var p={};var f={};var m={};var E;var g;var y;var b;var T;var x;var R;var k=true;var H=THREE.SmoothShading;var S={centerGeometry:false,convertUpAxis:false,subdivideFaces:true,upAxis:"Y",defaultEnvMap:null};var M=1;var N="Y";var C=null;function O(e,t,r,i){var n=0;if(document.implementation&&document.implementation.createDocument){var s=new XMLHttpRequest;s.onreadystatechange=function(){if(s.readyState===4){if(s.status===0||s.status===200){if(s.responseXML){a=t;A(s.responseXML,undefined,e)}else if(s.responseText){a=t;var o=new DOMParser;var l=o.parseFromString(s.responseText,"application/xml");A(l,undefined,e)}else{if(faillCallback){i()}else{console.error("ColladaLoader: Empty or non-existing file ("+e+")")}}}}else if(s.readyState===3){if(r){if(n===0){n=s.getResponseHeader("Content-Length")}r({total:n,loaded:s.responseText.length})}}};s.open("GET",e,true);s.send(null)}else{alert("Don't know how to parse XML!")}}function A(n,s,o){e=n;s=s||a;if(o!==undefined){var v=o.split("/");v.pop();T=(v.length<1?".":v.join("/"))+"/"}V();st();l=I("library_images image",le,"image");d=I("library_materials material",Me,"material");p=I("library_effects effect",_e,"effect");u=I("library_geometries geometry",ge,"geometry");f=I("library_cameras camera",Pe,"camera");m=I("library_lights light",ze,"light");h=I("library_controllers controller",ce,"controller");c=I("library_animations animation",Ve,"animation");y=I("library_visual_scenes visual_scene",de,"visual_scene");b=I("library_kinematics_models kinematics_model",Fe,"kinematics_model");x=[];R=[];r=L();t=new THREE.Group;for(var w=0;w<r.nodes.length;w++){t.add(Z(r.nodes[w]))}t.scale.multiplyScalar(M);P();i=D();K();var k={scene:t,morphs:x,skins:R,animations:E,kinematics:g,dae:{images:l,materials:d,cameras:f,lights:m,effects:p,geometries:u,controllers:h,animations:c,visualScenes:y,visualScene:r,scene:r,kinematicsModels:b,kinematicsModel:i}};if(s){s(k)}return k}function _(e){H=e}function V(){var t=e.querySelectorAll("asset");var r=t[0];if(r&&r.childNodes){for(var i=0;i<r.childNodes.length;i++){var a=r.childNodes[i];switch(a.nodeName){case"unit":var n=a.getAttribute("meter");if(n){M=parseFloat(n)}break;case"up_axis":N=a.textContent.charAt(0);break}}}}function I(t,r,i){var a=e.querySelectorAll(t);var n={};var s=0;var o=a.length;for(var l=0;l<o;l++){var c=a[l];var h=(new r).parse(c);if(!h.id||h.id.length===0)h.id=i+s++;n[h.id]=h}return n}function L(){var t=e.querySelectorAll("scene instance_visual_scene")[0];if(t){var r=t.getAttribute("url").replace(/^#/,"");return y[r.length>0?r:"visual_scene0"]}else{return null}}function D(){var t=e.querySelectorAll("instance_kinematics_model")[0];if(t){var r=t.getAttribute("url").replace(/^#/,"");return b[r.length>0?r:"kinematics_model0"]}else{return null}}function P(){E=[];B(t)}function B(e){var t=r.getChildById(e.colladaId,true),i=null;if(t&&t.keys){i={fps:60,hierarchy:[{node:t,keys:t.keys,sids:t.sids}],node:e,name:"animation_"+e.name,length:0};E.push(i);for(var a=0,n=t.keys.length;a<n;a++){i.length=Math.max(i.length,t.keys[a].time)}}else{i={hierarchy:[{keys:[],sids:[]}]}}for(var a=0,n=e.children.length;a<n;a++){var s=B(e.children[a]);for(var o=0,l=s.hierarchy.length;o<l;o++){i.hierarchy.push({keys:[],sids:[]})}}return i}function z(){var e=1e6;var t=-e;var r=0;var i;for(var a in c){var n=c[a];i=i||n.id;for(var s=0;s<n.sampler.length;s++){var o=n.sampler[s];o.create();e=Math.min(e,o.startTime);t=Math.max(t,o.endTime);r=Math.max(r,o.input.length)}}return{start:e,end:t,frames:r,ID:i}}function U(e,t){var r=t instanceof ve?h[t.url]:t;if(!r||!r.morph){console.log("could not find morph controller!");return}var i=r.morph;for(var a=0;a<i.targets.length;a++){var n=i.targets[a];var s=u[n];if(!s.mesh||!s.mesh.primitives||!s.mesh.primitives.length){continue}var o=s.mesh.primitives[0].geometry;if(o.vertices.length===e.vertices.length){e.morphTargets.push({name:"target_1",vertices:o.vertices})}}e.morphTargets.push({name:"target_Z",vertices:e.vertices})}function F(e,t,i){var a=h[t.url];if(!a||!a.skin){console.log("could not find skin controller!");return}if(!t.skeleton||!t.skeleton.length){console.log("could not find the skeleton for the skin!");return}var n=a.skin;var s=r.getChildById(t.skeleton[0]);var o=[];i=i!==undefined?i:true;var l=[];e.skinWeights=[];e.skinIndices=[];if(i){for(var c=0;c<e.vertices.length;c++){e.vertices[c].applyMatrix4(n.bindShapeMatrix)}}}function G(e,t,r,i){e.world=e.world||new THREE.Matrix4;e.localworld=e.localworld||new THREE.Matrix4;e.world.copy(e.matrix);e.localworld.copy(e.matrix);if(e.channels&&e.channels.length){var a=e.channels[0];var n=a.sampler.output[r];if(n instanceof THREE.Matrix4){e.world.copy(n);e.localworld.copy(n);if(r===0)e.matrix.copy(n)}}if(i){e.world.multiplyMatrices(i,e.world)}t.push(e);for(var s=0;s<e.nodes.length;s++){G(e.nodes[s],t,r,e.world)}}function q(e,t){for(var r=0;r<e.length;r++){var i=e[r];var a=-1;if(i.type!="JOINT")continue;for(var n=0;n<t.joints.length;n++){if(i.sid===t.joints[n]){a=n;break}}if(a>=0){var s=t.invBindMatrices[a];i.invBindMatrix=s;i.skinningMatrix=new THREE.Matrix4;i.skinningMatrix.multiplyMatrices(i.world,s);i.animatrix=new THREE.Matrix4;i.animatrix.copy(i.localworld);i.weights=[];for(var n=0;n<t.weights.length;n++){for(var o=0;o<t.weights[n].length;o++){var l=t.weights[n][o];if(l.joint===a){i.weights.push(l)}}}}else{console.warn("ColladaLoader: Could not find joint '"+i.sid+"'.");i.skinningMatrix=new THREE.Matrix4;i.weights=[]}}}function Y(e){var t=[];var r=function(e,t,i){var a={};a.name=t.sid;a.parent=e;a.matrix=t.matrix;var n=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];a.matrix.decompose(n[0],n[1],n[2]);a.pos=[n[0].x,n[0].y,n[0].z];a.scl=[n[2].x,n[2].y,n[2].z];a.rotq=[n[1].x,n[1].y,n[1].z,n[1].w];i.push(a);for(var s in t.nodes){r(t.sid,t.nodes[s],i)}};r(-1,e,t);return t}function X(e,t,r){var i=[];G(t,i,-1);q(i,r.skin);v=new THREE.Vector3;var a=[];for(var n=0;n<e.vertices.length;n++){a.push(new THREE.Vector3)}for(n=0;n<i.length;n++){if(i[n].type!="JOINT")continue;for(j=0;j<i[n].weights.length;j++){w=i[n].weights[j];vidx=w.index;weight=w.weight;o=e.vertices[vidx];s=a[vidx];v.x=o.x;v.y=o.y;v.z=o.z;v.applyMatrix4(i[n].skinningMatrix);s.x+=v.x*weight;s.y+=v.y*weight;s.z+=v.z*weight}}for(var n=0;n<e.vertices.length;n++){e.vertices[n]=a[n]}}function W(e,t,i){var a=h[t.url];i=i!==undefined?i:40;if(!a||!a.skin){console.log("ColladaLoader: Could not find skin controller.");return}if(!t.skeleton||!t.skeleton.length){console.log("ColladaLoader: Could not find the skeleton for the skin. ");return}var n=z();var s=r.getChildById(t.skeleton[0],true)||r.getChildBySid(t.skeleton[0],true);var o=Y(s);var l=a.skin.joints;var c=[];for(var u=0;u<l.length;u++){for(var d=0;d<o.length;d++){if(o[d].name===l[u]){c[u]=o[d]}}}for(var u=0;u<c.length;u++){for(var d=0;d<c.length;d++){if(c[u].parent===c[d].name){c[u].parent=d}}}var u,d,p,f,v;var m=new THREE.Vector3,E,g;for(u=0;u<e.vertices.length;u++){e.vertices[u].applyMatrix4(a.skin.bindShapeMatrix)}var y=[];var b=[];var T=a.skin.weights;for(var u=0;u<T.length;u++){var w=new THREE.Vector4(T[u][0]?T[u][0].joint:0,T[u][1]?T[u][1].joint:0,T[u][2]?T[u][2].joint:0,T[u][3]?T[u][3].joint:0);var v=new THREE.Vector4(T[u][0]?T[u][0].weight:0,T[u][1]?T[u][1].weight:0,T[u][2]?T[u][2].weight:0,T[u][3]?T[u][3].weight:0);y.push(w);b.push(v)}e.skinIndices=y;e.skinWeights=b;e.bones=c;var x={name:n.ID,fps:30,length:n.frames/30,hierarchy:[]};for(var d=0;d<c.length;d++){x.hierarchy.push({parent:c[d].parent,name:c[d].name,keys:[]})}console.log("ColladaLoader:",n.ID+" has "+c.length+" bones.");X(e,s,a);for(i=0;i<n.frames;i++){var R=[];var k=[];G(s,R,i);q(R,a.skin);for(var u=0;u<R.length;u++){for(var d=0;d<x.hierarchy.length;d++){if(x.hierarchy[d].name===R[u].sid){var H={};H.time=i/30;H.matrix=R[u].animatrix;if(i===0)R[u].matrix=H.matrix;var S=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];H.matrix.decompose(S[0],S[1],S[2]);H.pos=[S[0].x,S[0].y,S[0].z];H.scl=[S[2].x,S[2].y,S[2].z];H.rot=S[1];x.hierarchy[d].keys.push(H)}}}e.animation=x}}function K(){if(i&&i.joints.length===0){g=undefined;return}var a={};var n=function(e,n){var s=n.getAttribute("id");var o=r.getChildById(s,true);var l=i.joints[e];t.traverse(function(t){if(t.colladaId==s){a[e]={node:t,transforms:o.transforms,joint:l,position:l.zeroPosition}}})};g={joints:i&&i.joints,getJointValue:function(e){var t=a[e];if(t){return t.position}else{console.log("getJointValue: joint "+e+" doesn't exist")}},setJointValue:function(e,t){var r=a[e];if(r){var i=r.joint;if(t>i.limits.max||t<i.limits.min){console.log("setJointValue: joint "+e+" value "+t+" outside of limits (min: "+i.limits.min+", max: "+i.limits.max+")")}else if(i.static){console.log("setJointValue: joint "+e+" is static")}else{var n=r.node;var s=i.axis;var l=r.transforms;var c=new THREE.Matrix4;for(o=0;o<l.length;o++){var h=l[o];if(h.sid&&h.sid.indexOf("joint"+e)!==-1){switch(i.type){case"revolute":c.multiply(u.makeRotationAxis(s,THREE.Math.degToRad(t)));break;case"prismatic":c.multiply(u.makeTranslation(s.x*t,s.y*t,s.z*t));break;default:console.warn("setJointValue: unknown joint type: "+i.type);break}}else{var u=new THREE.Matrix4;switch(h.type){case"matrix":c.multiply(h.obj);break;case"translate":c.multiply(u.makeTranslation(h.obj.x,h.obj.y,h.obj.z));break;case"rotate":c.multiply(u.makeRotationAxis(h.obj,h.angle));break}}}var d=c.elements;var p=Array.prototype.slice.call(d);var f=[p[0],p[4],p[8],p[12],p[1],p[5],p[9],p[13],p[2],p[6],p[10],p[14],p[3],p[7],p[11],p[15]];n.matrix.set.apply(n.matrix,f);n.matrix.decompose(n.position,n.quaternion,n.scale)}}else{console.log("setJointValue: joint "+e+" doesn't exist")}}};var s=e.querySelector("scene instance_kinematics_scene");if(s){for(var o=0;o<s.childNodes.length;o++){var l=s.childNodes[o];if(l.nodeType!=1)continue;switch(l.nodeName){case"bind_joint_axis":var c=l.getAttribute("target").split("/").pop();var h=l.querySelector("axis param").textContent;var u=parseInt(h.split("joint").pop().split(".")[0]);var d=e.querySelector('[sid="'+c+'"]');if(d){var p=d.parentElement;n(u,p)}break;default:break}}}}function Z(e,t){var r=new THREE.Object3D;var i=false;var a;var n;var s,o;for(s=0;s<e.controllers.length;s++){var l=h[e.controllers[s].url];switch(l.type){case"skin":if(u[l.skin.source]){var c=new Ee;c.url=l.skin.source;c.instance_material=e.controllers[s].instance_material;e.geometries.push(c);i=true;a=e.controllers[s]}else if(h[l.skin.source]){var v=h[l.skin.source];n=v;if(v.morph&&u[v.morph.source]){var c=new Ee;c.url=v.morph.source;c.instance_material=e.controllers[s].instance_material;e.geometries.push(c)}}break;case"morph":if(u[l.morph.source]){var c=new Ee;c.url=l.morph.source;c.instance_material=e.controllers[s].instance_material;e.geometries.push(c);n=e.controllers[s]}console.log("ColladaLoader: Morph-controller partially supported.");default:break}}var E={};for(s=0;s<e.geometries.length;s++){var g=e.geometries[s];var y=g.instance_material;var b=u[g.url];var T={};var w=[];var k=0;var H;if(b){if(!b.mesh||!b.mesh.primitives)continue;if(r.name.length===0){r.name=b.id}if(y){for(o=0;o<y.length;o++){var M=y[o];var N=d[M.target];var C=N.instance_effect.url;var O=p[C].shader;var A=O.material;if(b.doubleSided){if(!(M.symbol in E)){var _=A.clone();_.side=THREE.DoubleSide;E[M.symbol]=_}A=E[M.symbol]}A.opacity=!A.opacity?1:A.opacity;T[M.symbol]=k;w.push(A);H=A;H.name=N.name===null||N.name===""?N.id:N.name;k++}}var j;var V=H||new THREE.MeshLambertMaterial({color:14540253,side:b.doubleSided?THREE.DoubleSide:THREE.FrontSide});var I=b.mesh.geometry3js;if(k>1){V=new THREE.MeshFaceMaterial(w);for(o=0;o<I.faces.length;o++){var L=I.faces[o];L.materialIndex=T[L.daeMaterial]}}if(a!==undefined){W(I,a);if(I.morphTargets.length>0){V.morphTargets=true;V.skinning=false}else{V.morphTargets=false;V.skinning=true}j=new THREE.SkinnedMesh(I,V,false);j.name="skin_"+R.length;R.push(j)}else if(n!==undefined){U(I,n);V.morphTargets=true;j=new THREE.Mesh(I,V);j.name="morph_"+x.length;x.push(j)}else{if(I.isLineStrip===true){j=new THREE.Line(I)}else{j=new THREE.Mesh(I,V)}}r.add(j)}}for(s=0;s<e.cameras.length;s++){var D=e.cameras[s];var P=f[D.url];var B=new THREE.PerspectiveCamera(P.yfov,parseFloat(P.aspect_ratio),parseFloat(P.znear),parseFloat(P.zfar));r.add(B)}for(s=0;s<e.lights.length;s++){var z=null;var F=e.lights[s];var G=m[F.url];if(G&&G.technique){var q=G.color.getHex();var Y=G.intensity;var X=G.distance;var K=G.falloff_angle;var J;switch(G.technique){case"directional":z=new THREE.DirectionalLight(q,Y,X);z.position.set(0,0,1);break;case"point":z=new THREE.PointLight(q,Y,X);break;case"spot":z=new THREE.SpotLight(q,Y,X,K,J);z.position.set(0,0,1);break;case"ambient":z=new THREE.AmbientLight(q);break}}if(z){r.add(z)}}r.name=e.name||e.id||"";r.colladaId=e.id||"";r.layer=e.layer||"";r.matrix=e.matrix;r.matrix.decompose(r.position,r.quaternion,r.scale);if(S.centerGeometry&&r.geometry){var Q=r.geometry.center();Q.multiply(r.scale);Q.applyQuaternion(r.quaternion);r.position.sub(Q)}for(s=0;s<e.nodes.length;s++){r.add(Z(e.nodes[s],e))}return r}function J(e,t){for(var r=0;r<e.joints.length;r++){if(e.joints[r]===t){return r}}}function Q(t){var r=e.querySelectorAll("library_nodes node");for(var i=0;i<r.length;i++){var a=r[i].attributes.getNamedItem("id");if(a&&a.value===t){return r[i]}}return undefined}function $(e){var t=[];var r=1e6;var i=-1e6;for(var a in c){var n=c[a];for(var s=0;s<n.channel.length;s++){var o=n.channel[s];var l=n.sampler[s];var a=o.target.split("/")[0];if(a==e.id){l.create();o.sampler=l;r=Math.min(r,l.startTime);i=Math.max(i,l.endTime);t.push(o)}}}if(t.length){e.startTime=r;e.endTime=i}return t}function ee(e){var t=1e7;for(var r=0;r<e.channels.length;r++){var i=e.channels[r].sampler;for(var a=0;a<i.input.length-1;a++){var n=i.input[a];var s=i.input[a+1];t=Math.min(t,s-n)}}return t}function te(e,t){var r={};var i,a;for(i=0;i<e.channels.length;i++){var n=e.channels[i];r[n.sid]=n}var s=new THREE.Matrix4;for(i=0;i<e.transforms.length;i++){var o=e.transforms[i];var n=r[o.sid];if(n!==undefined){var l=n.sampler;var c;for(a=0;a<l.input.length-1;a++){if(l.input[a+1]>t){c=l.output[a];break}}if(c!==undefined){if(c instanceof THREE.Matrix4){s.multiplyMatrices(s,c)}else{s.multiplyMatrices(s,o.matrix)}}else{s.multiplyMatrices(s,o.matrix)}}else{s.multiplyMatrices(s,o.matrix)}}return s}function re(e){if(e.channels&&e.channels.length){var t=[],r=[];for(var i=0,a=e.channels.length;i<a;i++){var n=e.channels[i],s=n.fullSid,o=n.sampler,l=o.input,c=e.getTransformBySid(n.sid),h;if(n.arrIndices){h=[];for(var u=0,d=n.arrIndices.length;u<d;u++){h[u]=ut(n.arrIndices[u])}}else{h=dt(n.member)}if(c){if(r.indexOf(s)===-1){r.push(s)}for(var u=0,d=l.length;u<d;u++){var p=l[u],f=o.getData(c.type,u,h),v=ie(t,p);if(!v){v=new De(p);var m=ae(t,p);t.splice(m===-1?t.length:m,0,v)}v.addTarget(s,c,h,f)}}else{console.log('Could not find transform "'+n.sid+'" in node '+e.id)}}for(var i=0;i<r.length;i++){var E=r[i];for(var u=0;u<t.length;u++){var v=t[u];if(!v.hasTarget(E)){ne(t,v,u,E)}}}e.keys=t;e.sids=r}}function ie(e,t){var r=null;for(var i=0,a=e.length;i<a&&r===null;i++){var n=e[i];if(n.time===t){r=n}else if(n.time>t){break}}return r}function ae(e,t){var r=-1;for(var i=0,a=e.length;i<a&&r===-1;i++){var n=e[i];if(n.time>=t){r=i}}return r}function ne(e,t,r,i){var a=oe(e,i,r?r-1:0),n=se(e,i,r+1);if(a&&n){var s=(t.time-a.time)/(n.time-a.time),o=a.getTarget(i),l=n.getTarget(i).data,c=o.data,h;if(o.type==="matrix"){h=c}else if(c.length){h=[];for(var u=0;u<c.length;++u){h[u]=c[u]+(l[u]-c[u])*s}}else{h=c+(l-c)*s}t.addTarget(i,o.transform,o.member,h)}}function se(e,t,r){for(;r<e.length;r++){var i=e[r];if(i.hasTarget(t)){return i}}return null}function oe(e,t,r){r=r>=0?r:r+e.length;for(;r>=0;r--){var i=e[r];if(i.hasTarget(t)){return i}}return null}function le(){this.id="";this.init_from=""}le.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeName==="init_from"){this.init_from=r.textContent}}return this};function ce(){this.id="";this.name="";this.type="";this.skin=null;this.morph=null}ce.prototype.parse=function(e){this.id=e.getAttribute("id");this.name=e.getAttribute("name");this.type="none";for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"skin":this.skin=(new ue).parse(r);this.type=r.nodeName;break;case"morph":this.morph=(new he).parse(r);this.type=r.nodeName;break;default:break}}return this};function he(){this.method=null;this.source=null;this.targets=null;this.weights=null}he.prototype.parse=function(e){var t={};var r=[];var i;this.method=e.getAttribute("method");this.source=e.getAttribute("source").replace(/^#/,"");for(i=0;i<e.childNodes.length;i++){var a=e.childNodes[i];if(a.nodeType!=1)continue;switch(a.nodeName){case"source":var n=(new Se).parse(a);t[n.id]=n;break;case"targets":r=this.parseInputs(a);break;default:console.log(a.nodeName);break}}for(i=0;i<r.length;i++){var s=r[i];var n=t[s.source];switch(s.semantic){case"MORPH_TARGET":this.targets=n.read();break;case"MORPH_WEIGHT":this.weights=n.read();break;default:break}}return this};he.prototype.parseInputs=function(e){var t=[];for(var r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(i.nodeType!=1)continue;switch(i.nodeName){case"input":t.push((new He).parse(i));break;default:break}}return t};function ue(){this.source="";this.bindShapeMatrix=null;this.invBindMatrices=[];this.joints=[];this.weights=[]}ue.prototype.parse=function(e){var t={};var r,i;this.source=e.getAttribute("source").replace(/^#/,"");this.invBindMatrices=[];this.joints=[];this.weights=[];for(var a=0;a<e.childNodes.length;a++){var n=e.childNodes[a];if(n.nodeType!=1)continue;switch(n.nodeName){case"bind_shape_matrix":var s=Ze(n.textContent);this.bindShapeMatrix=ht(s);break;case"source":var o=(new Se).parse(n);t[o.id]=o;break;case"joints":r=n;break;case"vertex_weights":i=n;break;default:console.log(n.nodeName);break}}this.parseJoints(r,t);this.parseWeights(i,t);return this};ue.prototype.parseJoints=function(e,t){for(var r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(i.nodeType!=1)continue;switch(i.nodeName){case"input":var a=(new He).parse(i);var n=t[a.source];if(a.semantic==="JOINT"){this.joints=n.read()}else if(a.semantic==="INV_BIND_MATRIX"){this.invBindMatrices=n.read()}break;default:break}}};ue.prototype.parseWeights=function(e,t){var r,i,a=[];for(var n=0;n<e.childNodes.length;n++){var s=e.childNodes[n];if(s.nodeType!=1)continue;switch(s.nodeName){case"input":a.push((new He).parse(s));break;case"v":r=Je(s.textContent);break;case"vcount":i=Je(s.textContent);break;default:break}}var o=0;for(var n=0;n<i.length;n++){var l=i[n];var c=[];for(var h=0;h<l;h++){var u={};for(var d=0;d<a.length;d++){var p=a[d];var f=r[o+p.offset];switch(p.semantic){case"JOINT":u.joint=f;break;case"WEIGHT":u.weight=t[p.source].data[f];break;default:break}}c.push(u);o+=a.length}for(var h=0;h<c.length;h++){c[h].index=n}this.weights.push(c)}};function de(){this.id="";this.name="";this.nodes=[];this.scene=new THREE.Group}de.prototype.getChildById=function(e,t){for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildById(e,t);if(i){return i}}return null};de.prototype.getChildBySid=function(e,t){for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildBySid(e,t);if(i){return i}}return null};de.prototype.parse=function(e){this.id=e.getAttribute("id");this.name=e.getAttribute("name");this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"node":this.nodes.push((new pe).parse(r));break;default:break}}return this};function pe(){this.id="";this.name="";this.sid="";this.nodes=[];this.controllers=[];this.transforms=[];this.geometries=[];this.channels=[];this.matrix=new THREE.Matrix4}pe.prototype.getChannelForTransform=function(e){for(var t=0;t<this.channels.length;t++){var r=this.channels[t];var i=r.target.split("/");var a=i.shift();var n=i.shift();var s=n.indexOf(".")>=0;var o=n.indexOf("(")>=0;var l;var c;if(s){i=n.split(".");n=i.shift();c=i.shift()}else if(o){l=n.split("(");n=l.shift();for(var h=0;h<l.length;h++){l[h]=parseInt(l[h].replace(/\)/,""))}}if(n===e){r.info={sid:n,dotSyntax:s,arrSyntax:o,arrIndices:l};return r}}return null};pe.prototype.getChildById=function(e,t){if(this.id===e){return this}if(t){for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildById(e,t);if(i){return i}}}return null};pe.prototype.getChildBySid=function(e,t){if(this.sid===e){return this}if(t){for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildBySid(e,t);if(i){return i}}}return null};pe.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++){if(this.transforms[t].sid===e)return this.transforms[t]}return null};pe.prototype.parse=function(e){var t;this.id=e.getAttribute("id");this.sid=e.getAttribute("sid");this.name=e.getAttribute("name");this.type=e.getAttribute("type");this.layer=e.getAttribute("layer");this.type=this.type==="JOINT"?this.type:"NODE";this.nodes=[];this.transforms=[];this.geometries=[];this.cameras=[];this.lights=[];this.controllers=[];this.matrix=new THREE.Matrix4;for(var r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(i.nodeType!=1)continue;switch(i.nodeName){case"node":this.nodes.push((new pe).parse(i));break;case"instance_camera":this.cameras.push((new Be).parse(i));break;case"instance_controller":this.controllers.push((new ve).parse(i));break;case"instance_geometry":this.geometries.push((new Ee).parse(i));break;case"instance_light":this.lights.push((new Ue).parse(i));break;case"instance_node":t=i.getAttribute("url").replace(/^#/,"");var a=Q(t);if(a){this.nodes.push((new pe).parse(a))}break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new fe).parse(i));break;case"extra":break;default:console.log(i.nodeName);break}}this.channels=$(this);re(this);this.updateMatrix();return this};pe.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++){this.transforms[e].apply(this.matrix)}};function fe(){this.sid="";this.type="";this.data=[];this.obj=null}fe.prototype.parse=function(e){this.sid=e.getAttribute("sid");this.type=e.nodeName;this.data=Ze(e.textContent);this.convert();return this};fe.prototype.convert=function(){switch(this.type){case"matrix":this.obj=ht(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);case"translate":ot(this.data,-1);this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":ot(this.data,1);this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type);break}};fe.prototype.apply=function(){var e=new THREE.Matrix4;return function(t){switch(this.type){case"matrix":t.multiply(this.obj);break;case"translate":t.multiply(e.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":t.multiply(e.makeRotationAxis(this.obj,this.angle));break;case"scale":t.scale(this.obj);break}}}();fe.prototype.update=function(e,t){var r=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(!t){this.obj.copy(e)}else if(t.length===1){switch(t[0]){case 0:this.obj.n11=e[0];this.obj.n21=e[1];this.obj.n31=e[2];this.obj.n41=e[3];break;case 1:this.obj.n12=e[0];this.obj.n22=e[1];this.obj.n32=e[2];this.obj.n42=e[3];break;case 2:this.obj.n13=e[0];this.obj.n23=e[1];this.obj.n33=e[2];this.obj.n43=e[3];break;case 3:this.obj.n14=e[0];this.obj.n24=e[1];this.obj.n34=e[2];this.obj.n44=e[3];break}}else if(t.length===2){var i="n"+(t[0]+1)+(t[1]+1);this.obj[i]=e}else{console.log("Incorrect addressing of matrix in transform.")}break;case"translate":case"scale":if(Object.prototype.toString.call(t)==="[object Array]"){
t=r[t[0]]}switch(t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0];this.obj.y=e[1];this.obj.z=e[2];break}break;case"rotate":if(Object.prototype.toString.call(t)==="[object Array]"){t=r[t[0]]}switch(t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=THREE.Math.degToRad(e);break;default:this.obj.x=e[0];this.obj.y=e[1];this.obj.z=e[2];this.angle=THREE.Math.degToRad(e[3]);break}break}};function ve(){this.url="";this.skeleton=[];this.instance_material=[]}ve.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,"");this.skeleton=[];this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!==1)continue;switch(r.nodeName){case"skeleton":this.skeleton.push(r.textContent.replace(/^#/,""));break;case"bind_material":var i=r.querySelectorAll("instance_material");for(var a=0;a<i.length;a++){var n=i[a];this.instance_material.push((new me).parse(n))}break;case"extra":break;default:break}}return this};function me(){this.symbol="";this.target=""}me.prototype.parse=function(e){this.symbol=e.getAttribute("symbol");this.target=e.getAttribute("target").replace(/^#/,"");return this};function Ee(){this.url="";this.instance_material=[]}Ee.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,"");this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;if(r.nodeName==="bind_material"){var i=r.querySelectorAll("instance_material");for(var a=0;a<i.length;a++){var n=i[a];this.instance_material.push((new me).parse(n))}break}}return this};function ge(){this.id="";this.mesh=null}ge.prototype.parse=function(e){this.id=e.getAttribute("id");nt(this,e);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"mesh":this.mesh=new ye(this).parse(r);break;case"extra":break;default:break}}return this};function ye(e){this.geometry=e.id;this.primitives=[];this.vertices=null;this.geometry3js=null}ye.prototype.parse=function(e){this.primitives=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"source":Xe(r);break;case"vertices":this.vertices=(new ke).parse(r);break;case"linestrips":this.primitives.push((new we).parse(r));break;case"triangles":this.primitives.push((new xe).parse(r));break;case"polygons":this.primitives.push((new be).parse(r));break;case"polylist":this.primitives.push((new Te).parse(r));break;default:break}}this.geometry3js=new THREE.Geometry;if(this.vertices===null){return this}var i=n[this.vertices.input["POSITION"].source].data;for(var t=0;t<i.length;t+=3){this.geometry3js.vertices.push(ct(i,t).clone())}for(var t=0;t<this.primitives.length;t++){var a=this.primitives[t];a.setVertices(this.vertices);this.handlePrimitive(a,this.geometry3js)}if(this.geometry3js.calcNormals){this.geometry3js.computeVertexNormals();delete this.geometry3js.calcNormals}return this};ye.prototype.handlePrimitive=function(e,t){if(e instanceof we){t.isLineStrip=true;return}var r,i,a=e.p,s=e.inputs;var o,l,c;var h,u;var d=0,p=3,f=0;var v=[];for(r=0;r<s.length;r++){o=s[r];var m=o.offset+1;f=f<m?m:f;switch(o.semantic){case"TEXCOORD":v.push(o.set);break}}for(var E=0;E<a.length;++E){var g=a[E],y=0;while(y<g.length){var b=[];var T=[];var w=null;var x=[];if(e.vcount){p=e.vcount.length?e.vcount[d++]:e.vcount}else{p=g.length/f}for(r=0;r<p;r++){for(i=0;i<s.length;i++){o=s[i];h=n[o.source];l=g[y+r*f+o.offset];u=h.accessor.params.length;c=l*u;switch(o.semantic){case"VERTEX":b.push(l);break;case"NORMAL":T.push(ct(h.data,c));break;case"TEXCOORD":w=w||{};if(w[o.set]===undefined)w[o.set]=[];w[o.set].push(new THREE.Vector2(h.data[c],h.data[c+1]));break;case"COLOR":x.push((new THREE.Color).setRGB(h.data[c],h.data[c+1],h.data[c+2]));break;default:break}}}if(T.length===0){o=this.vertices.input.NORMAL;if(o){h=n[o.source];u=h.accessor.params.length;for(var R=0,k=b.length;R<k;R++){T.push(ct(h.data,b[R]*u))}}else{t.calcNormals=true}}if(!w){w={};o=this.vertices.input.TEXCOORD;if(o){v.push(o.set);h=n[o.source];u=h.accessor.params.length;for(var R=0,k=b.length;R<k;R++){c=b[R]*u;if(w[o.set]===undefined)w[o.set]=[];w[o.set].push(new THREE.Vector2(h.data[c],1-h.data[c+1]))}}}if(x.length===0){o=this.vertices.input.COLOR;if(o){h=n[o.source];u=h.accessor.params.length;for(var R=0,k=b.length;R<k;R++){c=b[R]*u;x.push((new THREE.Color).setRGB(h.data[c],h.data[c+1],h.data[c+2]))}}}var H=null,M=[],N,C;if(p===3){M.push(new THREE.Face3(b[0],b[1],b[2],T,x.length?x:new THREE.Color))}else if(p===4){M.push(new THREE.Face3(b[0],b[1],b[3],[T[0].clone(),T[1].clone(),T[3].clone()],x.length?[x[0],x[1],x[3]]:new THREE.Color));M.push(new THREE.Face3(b[1],b[2],b[3],[T[1].clone(),T[2].clone(),T[3].clone()],x.length?[x[1],x[2],x[3]]:new THREE.Color))}else if(p>4&&S.subdivideFaces){var O=x.length?x:new THREE.Color,A,_,j,V,I,L;for(i=1;i<p-1;){M.push(new THREE.Face3(b[0],b[i],b[i+1],[T[0].clone(),T[i++].clone(),T[i].clone()],O))}}if(M.length){for(var R=0,k=M.length;R<k;R++){H=M[R];H.daeMaterial=e.material;t.faces.push(H);for(i=0;i<v.length;i++){N=w[v[i]];if(p>4){C=[N[0],N[R+1],N[R+2]]}else if(p===4){if(R===0){C=[N[0],N[1],N[3]]}else{C=[N[1].clone(),N[2],N[3].clone()]}}else{C=[N[0],N[1],N[2]]}if(t.faceVertexUvs[i]===undefined){t.faceVertexUvs[i]=[]}t.faceVertexUvs[i].push(C)}}}else{console.log("dropped face with vcount "+p+" for geometry with id: "+t.id)}y+=f*p}}};function be(){this.material="";this.count=0;this.inputs=[];this.vcount=null;this.p=[];this.geometry=new THREE.Geometry}be.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++){if(this.inputs[t].source===e.id){this.inputs[t].source=e.input["POSITION"].source}}};be.prototype.parse=function(e){this.material=e.getAttribute("material");this.count=tt(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"input":this.inputs.push((new He).parse(e.childNodes[t]));break;case"vcount":this.vcount=Je(r.textContent);break;case"p":this.p.push(Je(r.textContent));break;case"ph":console.warn("polygon holes not yet supported!");break;default:break}}return this};function Te(){be.call(this);this.vcount=[]}Te.prototype=Object.create(be.prototype);Te.prototype.constructor=Te;function we(){be.call(this);this.vcount=1}we.prototype=Object.create(be.prototype);we.prototype.constructor=we;function xe(){be.call(this);this.vcount=3}xe.prototype=Object.create(be.prototype);xe.prototype.constructor=xe;function Re(){this.source="";this.count=0;this.stride=0;this.params=[]}Re.prototype.parse=function(e){this.params=[];this.source=e.getAttribute("source");this.count=tt(e,"count",0);this.stride=tt(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeName==="param"){var i={};i["name"]=r.getAttribute("name");i["type"]=r.getAttribute("type");this.params.push(i)}}return this};function ke(){this.input={}}ke.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){if(e.childNodes[t].nodeName==="input"){var r=(new He).parse(e.childNodes[t]);this.input[r.semantic]=r}}return this};function He(){this.semantic="";this.offset=0;this.source="";this.set=0}He.prototype.parse=function(e){this.semantic=e.getAttribute("semantic");this.source=e.getAttribute("source").replace(/^#/,"");this.set=tt(e,"set",-1);this.offset=tt(e,"offset",0);if(this.semantic==="TEXCOORD"&&this.set<0){this.set=0}return this};function Se(e){this.id=e;this.type=null}Se.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"bool_array":this.data=Ke(r.textContent);this.type=r.nodeName;break;case"float_array":this.data=Ze(r.textContent);this.type=r.nodeName;break;case"int_array":this.data=Je(r.textContent);this.type=r.nodeName;break;case"IDREF_array":case"Name_array":this.data=Qe(r.textContent);this.type=r.nodeName;break;case"technique_common":for(var i=0;i<r.childNodes.length;i++){if(r.childNodes[i].nodeName==="accessor"){this.accessor=(new Re).parse(r.childNodes[i]);break}}break;default:break}}return this};Se.prototype.read=function(){var e=[];var t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var r=0;r<this.data.length;r+=16){var i=this.data.slice(r,r+16);var a=ht(i);e.push(a)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".");break}return e};function Me(){this.id="";this.name="";this.instance_effect=null}Me.prototype.parse=function(e){this.id=e.getAttribute("id");this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){if(e.childNodes[t].nodeName==="instance_effect"){this.instance_effect=(new je).parse(e.childNodes[t]);break}}return this};function Ne(){this.color=new THREE.Color;this.color.setRGB(Math.random(),Math.random(),Math.random());this.color.a=1;this.texture=null;this.texcoord=null;this.texOpts=null}Ne.prototype.isColor=function(){return this.texture===null};Ne.prototype.isTexture=function(){return this.texture!=null};Ne.prototype.parse=function(e){if(e.nodeName==="transparent"){this.opaque=e.getAttribute("opaque")}for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"color":var i=Ze(r.textContent);this.color=new THREE.Color;this.color.setRGB(i[0],i[1],i[2]);this.color.a=i[3];break;case"texture":this.texture=r.getAttribute("texture");this.texcoord=r.getAttribute("texcoord");this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1};this.parseTexture(r);break;default:break}}return this};Ne.prototype.parseTexture=function(e){if(!e.childNodes)return this;if(e.childNodes[1]&&e.childNodes[1].nodeName==="extra"){e=e.childNodes[1];if(e.childNodes[1]&&e.childNodes[1].nodeName==="technique"){e=e.childNodes[1]}}for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[r.nodeName]=parseFloat(r.textContent);break;case"wrapU":case"wrapV":if(r.textContent.toUpperCase()==="TRUE"){this.texOpts[r.nodeName]=1}else{this.texOpts[r.nodeName]=parseInt(r.textContent)}break;default:this.texOpts[r.nodeName]=r.textContent;break}}return this};function Ce(e,t){this.type=e;this.effect=t;this.material=null}Ce.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[r.nodeName]=(new Ne).parse(r);break;case"bump":var i=r.getAttribute("bumptype");if(i){if(i.toLowerCase()==="heightfield"){this["bump"]=(new Ne).parse(r)}else if(i.toLowerCase()==="normalmap"){this["normal"]=(new Ne).parse(r)}else{console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+i+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'");this["bump"]=(new Ne).parse(r)}}else{console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'");this["bump"]=(new Ne).parse(r)}break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var a=r.querySelectorAll("float");if(a.length>0)this[r.nodeName]=parseFloat(a[0].textContent);break;default:break}}this.create();return this};Ce.prototype.create=function(){var e={};var t=false;if(this["transparency"]!==undefined&&this["transparent"]!==undefined){var r=this["transparent"];var i=(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency;if(i>0){t=true;e["transparent"]=true;e["opacity"]=1-i}}var a={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var n in this){switch(n){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var s=this[n];if(s instanceof Ne){if(s.isTexture()){var o=s.texture;var c=this.effect.sampler[o];if(c!==undefined&&c.source!==undefined){var h=this.effect.surface[c.source];if(h!==undefined){var u=l[h.init_from];if(u){var d=T+u.init_from;var p;var f=THREE.Loader.Handlers.get(d);if(f!==null){p=f.load(d)}else{p=new THREE.Texture;at(p,d)}p.wrapS=s.texOpts.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;p.wrapT=s.texOpts.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;p.offset.x=s.texOpts.offsetU;p.offset.y=s.texOpts.offsetV;p.repeat.x=s.texOpts.repeatU;p.repeat.y=s.texOpts.repeatV;e[a[n]]=p;if(n==="emission")e["emissive"]=16777215}}}}else if(n==="diffuse"||!t){if(n==="emission"){e["emissive"]=s.color.getHex()}else{e[n]=s.color.getHex()}}}break;case"shininess":e[n]=this[n];break;case"reflectivity":e[n]=this[n];if(e[n]>0)e["envMap"]=S.defaultEnvMap;e["combine"]=THREE.MixOperation;break;case"index_of_refraction":e["refractionRatio"]=this[n];if(this[n]!==1)e["envMap"]=S.defaultEnvMap;break;case"transparency":break;default:break}}e["shading"]=H;e["side"]=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide;switch(this.type){case"constant":if(e.emissive!=undefined)e.color=e.emissive;this.material=new THREE.MeshBasicMaterial(e);break;case"phong":case"blinn":if(e.diffuse!=undefined)e.color=e.diffuse;this.material=new THREE.MeshPhongMaterial(e);break;case"lambert":default:if(e.diffuse!=undefined)e.color=e.diffuse;this.material=new THREE.MeshLambertMaterial(e);break}return this.material};function Oe(e){this.effect=e;this.init_from=null;this.format=null}Oe.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"init_from":this.init_from=r.textContent;break;case"format":this.format=r.textContent;break;default:console.log("unhandled Surface prop: "+r.nodeName);break}}return this};function Ae(e){this.effect=e;this.source=null;this.wrap_s=null;this.wrap_t=null;this.minfilter=null;this.magfilter=null;this.mipfilter=null}Ae.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"source":this.source=r.textContent;break;case"minfilter":this.minfilter=r.textContent;break;case"magfilter":this.magfilter=r.textContent;break;case"mipfilter":this.mipfilter=r.textContent;break;case"wrap_s":this.wrap_s=r.textContent;break;case"wrap_t":this.wrap_t=r.textContent;break;default:console.log("unhandled Sampler2D prop: "+r.nodeName);break}}return this};function _e(){this.id="";this.name="";this.shader=null;this.surface={};this.sampler={}}_e.prototype.create=function(){if(this.shader===null){return null}};_e.prototype.parse=function(e){this.id=e.getAttribute("id");this.name=e.getAttribute("name");nt(this,e);this.shader=null;for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(r));break;default:break}}return this};_e.prototype.parseNewparam=function(e){var t=e.getAttribute("sid");for(var r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(i.nodeType!=1)continue;switch(i.nodeName){case"surface":this.surface[t]=new Oe(this).parse(i);break;case"sampler2D":this.sampler[t]=new Ae(this).parse(i);break;case"extra":break;default:console.log(i.nodeName);break}}};_e.prototype.parseProfileCOMMON=function(e){var t;for(var r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(i.nodeType!=1)continue;switch(i.nodeName){case"profile_COMMON":this.parseProfileCOMMON(i);break;case"technique":t=i;break;case"newparam":this.parseNewparam(i);break;case"image":var a=(new le).parse(i);l[a.id]=a;break;case"extra":break;default:console.log(i.nodeName);break}}return t};_e.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new Ce(r.nodeName,this).parse(r);break;case"extra":this.parseExtra(r);break;default:break}}};_e.prototype.parseExtra=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"technique":this.parseExtraTechnique(r);break;default:break}}};_e.prototype.parseExtraTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"bump":this.shader.parse(e);break;default:break}}};function je(){this.url=""}je.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,"");return this};function Ve(){this.id="";this.name="";this.source={};this.sampler=[];this.channel=[]}Ve.prototype.parse=function(e){this.id=e.getAttribute("id");this.name=e.getAttribute("name");this.source={};for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"animation":var i=(new Ve).parse(r);for(var a in i.source){this.source[a]=i.source[a]}for(var n=0;n<i.channel.length;n++){this.channel.push(i.channel[n]);this.sampler.push(i.sampler[n])}break;case"source":var a=(new Se).parse(r);this.source[a.id]=a;break;case"sampler":this.sampler.push(new Le(this).parse(r));break;case"channel":this.channel.push(new Ie(this).parse(r));break;default:break}}return this};function Ie(e){this.animation=e;this.source="";this.target="";this.fullSid=null;this.sid=null;this.dotSyntax=null;this.arrSyntax=null;this.arrIndices=null;this.member=null}Ie.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,"");this.target=e.getAttribute("target");var t=this.target.split("/");var r=t.shift();var i=t.shift();var a=i.indexOf(".")>=0;var n=i.indexOf("(")>=0;if(a){t=i.split(".");this.sid=t.shift();this.member=t.shift()}else if(n){var s=i.split("(");this.sid=s.shift();for(var o=0;o<s.length;o++){s[o]=parseInt(s[o].replace(/\)/,""))}this.arrIndices=s}else{this.sid=i}this.fullSid=i;this.dotSyntax=a;this.arrSyntax=n;return this};function Le(e){this.id="";this.animation=e;this.inputs=[];this.input=null;this.output=null;this.strideOut=null;this.interpolation=null;this.startTime=null;this.endTime=null;this.duration=0}Le.prototype.parse=function(e){this.id=e.getAttribute("id");this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"input":this.inputs.push((new He).parse(r));break;default:break}}return this};Le.prototype.create=function(){for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e];var r=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=r.read();break;case"OUTPUT":this.output=r.read();this.strideOut=r.accessor.stride;break;case"INTERPOLATION":this.interpolation=r.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(t.semantic);break}}this.startTime=0;this.endTime=0;this.duration=0;if(this.input.length){this.startTime=1e8;this.endTime=-1e8;for(var e=0;e<this.input.length;e++){this.startTime=Math.min(this.startTime,this.input[e]);this.endTime=Math.max(this.endTime,this.input[e])}this.duration=this.endTime-this.startTime}};Le.prototype.getData=function(e,t,r){var i;if(e==="matrix"&&this.strideOut===16){i=this.output[t]}else if(this.strideOut>1){i=[];t*=this.strideOut;for(var a=0;a<this.strideOut;++a){i[a]=this.output[t+a]}if(this.strideOut===3){switch(e){case"rotate":case"translate":ot(i,-1);break;case"scale":ot(i,1);break}}else if(this.strideOut===4&&e==="matrix"){ot(i,-1)}}else{i=this.output[t];if(r&&e==="translate"){i=lt(r,i)}}return i};function De(e){this.targets=[];this.time=e}De.prototype.addTarget=function(e,t,r,i){this.targets.push({sid:e,member:r,transform:t,data:i})};De.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var r=this.targets[t];if(!e||r.sid===e){r.transform.update(r.data,r.member)}}};De.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t){if(this.targets[t].sid===e){return this.targets[t]}}return null};De.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t){if(this.targets[t].sid===e){return true}}return false};De.prototype.interpolate=function(e,t){for(var r=0,i=this.targets.length;r<i;r++){var a=this.targets[r],n=e.getTarget(a.sid),s;if(a.transform.type!=="matrix"&&n){var o=(t-this.time)/(e.time-this.time),l=n.data,c=a.data;if(o<0)o=0;if(o>1)o=1;if(c.length){s=[];for(var h=0;h<c.length;++h){s[h]=c[h]+(l[h]-c[h])*o}}else{s=c+(l-c)*o}}else{s=a.data}a.transform.update(s,a.member)}};function Pe(){this.id="";this.name="";this.technique=""}Pe.prototype.parse=function(e){this.id=e.getAttribute("id");this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"optics":this.parseOptics(r);break;default:break}}return this};Pe.prototype.parseOptics=function(e){for(var t=0;t<e.childNodes.length;t++){if(e.childNodes[t].nodeName==="technique_common"){var r=e.childNodes[t];for(var i=0;i<r.childNodes.length;i++){this.technique=r.childNodes[i].nodeName;if(this.technique==="perspective"){var a=r.childNodes[i];for(var n=0;n<a.childNodes.length;n++){var s=a.childNodes[n];switch(s.nodeName){case"yfov":this.yfov=s.textContent;break;case"xfov":this.xfov=s.textContent;break;case"znear":this.znear=s.textContent;break;case"zfar":this.zfar=s.textContent;break;case"aspect_ratio":this.aspect_ratio=s.textContent;break}}}else if(this.technique==="orthographic"){var o=r.childNodes[i];for(var n=0;n<o.childNodes.length;n++){var s=o.childNodes[n];switch(s.nodeName){case"xmag":this.xmag=s.textContent;break;case"ymag":this.ymag=s.textContent;break;case"znear":this.znear=s.textContent;break;case"zfar":this.zfar=s.textContent;break;case"aspect_ratio":this.aspect_ratio=s.textContent;break}}}}}}return this};function Be(){this.url=""}Be.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,"");return this};function ze(){this.id="";this.name="";this.technique=""}ze.prototype.parse=function(e){this.id=e.getAttribute("id");this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"technique_common":this.parseCommon(r);break;case"technique":this.parseTechnique(r);break;default:break}}return this};ze.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++){switch(e.childNodes[t].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[t].nodeName;var r=e.childNodes[t];for(var i=0;i<r.childNodes.length;i++){var a=r.childNodes[i];switch(a.nodeName){case"color":var n=Ze(a.textContent);this.color=new THREE.Color(0);this.color.setRGB(n[0],n[1],n[2]);this.color.a=n[3];break;case"falloff_angle":this.falloff_angle=parseFloat(a.textContent);break;case"quadratic_attenuation":var s=parseFloat(a.textContent);this.distance=s?Math.sqrt(1/s):0}}}}return this};ze.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"intensity":this.intensity=parseFloat(r.textContent);break}}return this};function Ue(){this.url=""}Ue.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,"");return this};function Fe(){this.id="";this.name="";this.joints=[];this.links=[]}Fe.prototype.parse=function(e){this.id=e.getAttribute("id");this.name=e.getAttribute("name");this.joints=[];this.links=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"technique_common":this.parseCommon(r);break;default:break}}return this};Fe.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(e.childNodes[t].nodeName){case"joint":this.joints.push((new Ge).parse(r));break;case"link":this.links.push((new qe).parse(r));break;default:break}}return this};function Ge(){this.sid="";this.name="";this.axis=new THREE.Vector3;this.limits={min:0,max:0};this.type="";this.static=false;this.zeroPosition=0;this.middlePosition=0}Ge.prototype.parse=function(e){this.sid=e.getAttribute("sid");this.name=e.getAttribute("name");this.axis=new THREE.Vector3;this.limits={min:0,max:0};this.type="";this.static=false;this.zeroPosition=0;this.middlePosition=0;var t=e.querySelector("axis");var r=Ze(t.textContent);this.axis=ct(r,0);var i=e.querySelector("limits min")?parseFloat(e.querySelector("limits min").textContent):-360;var a=e.querySelector("limits max")?parseFloat(e.querySelector("limits max").textContent):360;this.limits={min:i,max:a};var n=["prismatic","revolute"];for(var s=0;s<n.length;s++){var o=n[s];var l=e.querySelector(o);if(l){this.type=o}}if(this.limits.min>=this.limits.max){this.static=true}this.middlePosition=(this.limits.min+this.limits.max)/2;return this};function qe(){this.sid="";this.name="";this.transforms=[];this.attachments=[]}qe.prototype.parse=function(e){this.sid=e.getAttribute("sid");this.name=e.getAttribute("name");this.transforms=[];this.attachments=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"attachment_full":this.attachments.push((new Ye).parse(r));break;case"rotate":case"translate":case"matrix":this.transforms.push((new fe).parse(r));break;default:break}}return this};function Ye(){this.joint="";this.transforms=[];this.links=[]}Ye.prototype.parse=function(e){this.joint=e.getAttribute("joint").split("/").pop();this.links=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=1)continue;switch(r.nodeName){case"link":this.links.push((new qe).parse(r));break;case"rotate":case"translate":case"matrix":this.transforms.push((new fe).parse(r));break;default:break}}return this};function Xe(e){var t=e.getAttribute("id");if(n[t]!=undefined){return n[t]}n[t]=new Se(t).parse(e);return n[t]}function We(e){if(e==="dae"){return"http://www.collada.org/2005/11/COLLADASchema"}return null}function Ke(e){var t=Qe(e);var r=[];for(var i=0,a=t.length;i<a;i++){r.push(t[i]==="true"||t[i]==="1"?true:false)}return r}function Ze(e){var t=Qe(e);var r=[];for(var i=0,a=t.length;i<a;i++){r.push(parseFloat(t[i]))}return r}function Je(e){var t=Qe(e);var r=[];for(var i=0,a=t.length;i<a;i++){r.push(parseInt(t[i],10))}return r}function Qe(e){return e.length>0?$e(e).split(/\s+/):[]}function $e(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}function et(e,t,r){if(e.hasAttribute(t)){return parseFloat(e.getAttribute(t))}else{return r}}function tt(e,t,r){if(e.hasAttribute(t)){return parseInt(e.getAttribute(t),10)}else{return r}}function rt(e,t,r){if(e.hasAttribute(t)){return e.getAttribute(t)}else{return r}}function it(e,t){if(e===undefined){var r="0.";while(r.length<t+2){r+="0"}return r}t=t||2;var i=e.toString().split(".");i[1]=i.length>1?i[1].substr(0,t):"0";while(i[1].length<t){i[1]+="0"}return i.join(".")}function at(e,t){loader=new THREE.ImageLoader;loader.load(t,function(t){e.image=t;e.needsUpdate=true})}function nt(e,t){e.doubleSided=false;var r=t.querySelectorAll("extra double_sided")[0];if(r){if(r&&parseInt(r.textContent,10)===1){e.doubleSided=true}}}function st(){if(S.convertUpAxis!==true||N===S.upAxis){C=null}else{switch(N){case"X":C=S.upAxis==="Y"?"XtoY":"XtoZ";break;case"Y":C=S.upAxis==="X"?"YtoX":"YtoZ";break;case"Z":C=S.upAxis==="X"?"ZtoX":"ZtoY";break}}}function ot(e,t){if(S.convertUpAxis!==true||N===S.upAxis){return}switch(C){case"XtoY":var r=e[0];e[0]=t*e[1];e[1]=r;break;case"XtoZ":var r=e[2];e[2]=e[1];e[1]=e[0];e[0]=r;break;case"YtoX":var r=e[0];e[0]=e[1];e[1]=t*r;break;case"YtoZ":var r=e[1];e[1]=t*e[2];e[2]=r;break;case"ZtoX":var r=e[0];e[0]=e[1];e[1]=e[2];e[2]=r;break;case"ZtoY":var r=e[1];e[1]=e[2];e[2]=t*r;break}}function lt(e,t){if(S.convertUpAxis!==true||N===S.upAxis){return t}switch(e){case"X":t=C==="XtoY"?t*-1:t;break;case"Y":t=C==="YtoZ"||C==="YtoX"?t*-1:t;break;case"Z":t=C==="ZtoY"?t*-1:t;break;default:break}return t}function ct(e,t){var r=[e[t],e[t+1],e[t+2]];ot(r,-1);return new THREE.Vector3(r[0],r[1],r[2])}function ht(e){if(S.convertUpAxis){var t=[e[0],e[4],e[8]];ot(t,-1);e[0]=t[0];e[4]=t[1];e[8]=t[2];t=[e[1],e[5],e[9]];ot(t,-1);e[1]=t[0];e[5]=t[1];e[9]=t[2];t=[e[2],e[6],e[10]];ot(t,-1);e[2]=t[0];e[6]=t[1];e[10]=t[2];t=[e[0],e[1],e[2]];ot(t,-1);e[0]=t[0];e[1]=t[1];e[2]=t[2];t=[e[4],e[5],e[6]];ot(t,-1);e[4]=t[0];e[5]=t[1];e[6]=t[2];t=[e[8],e[9],e[10]];ot(t,-1);e[8]=t[0];e[9]=t[1];e[10]=t[2];t=[e[3],e[7],e[11]];ot(t,-1);e[3]=t[0];e[7]=t[1];e[11]=t[2]}return(new THREE.Matrix4).set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function ut(e){if(e>-1&&e<3){var t=["X","Y","Z"],r={X:0,Y:1,Z:2};e=dt(t[e]);e=r[e]}return e}function dt(e){if(S.convertUpAxis){switch(e){case"X":switch(C){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z";break}break;case"Y":switch(C){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z";break}break;case"Z":switch(C){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y";break}break}}return e}return{load:O,parse:A,setPreferredShading:_,applySkin:W,geometries:u,options:S}};var THREEx=THREEx||{};THREEx.GeometryUtils=THREEx.GeometryUtils||{};THREEx.GeometryUtils.scale=function(e,t){for(var r=0;r<e.vertices.length;r++){var i=e.vertices[r];i.position.multiplySelf(t)}e.__dirtyVertices=true;return this};THREEx.GeometryUtils.translate=function(e,t){for(var r=0;r<e.vertices.length;r++){var i=e.vertices[r];i.position.addSelf(t)}e.__dirtyVertices=true;return this};THREEx.GeometryUtils.middlePoint=function(e){e.computeBoundingBox();var t=new THREE.Vector3;t.x=(e.boundingBox.x[1]+e.boundingBox.x[0])/2;t.y=(e.boundingBox.y[1]+e.boundingBox.y[0])/2;t.z=(e.boundingBox.z[1]+e.boundingBox.z[0])/2;return t};THREEx.GeometryUtils.center=function(e,t,r,i){var a=this.middlePoint(e).negate();if(t)a.x=0;if(r)a.y=0;if(i)a.z=0;return this.translate(e,a)};THREEx.GeometryUtils.attachRightLeft=function(e,t,r){if(r===undefined)r=0;e.computeBoundingBox();t.computeBoundingBox();var i=e.boundingBox.x[1];var a=t.boundingBox.x[0];var n=new THREE.Vector3;n.x=i+-a+r;this.translate(t,n);return this};var Representation3D=function(e,t,r,i,a,n,s,o,l,c,h,u){var d=new THREE.Vector3(0,0,o/2);this.data=e;this.parts={};this.imageList=c;this.sidePoints=t;this.surfaceSidePoints=r;this.renderer=u;this.config=h;this.parts.grid=this.buildGrid();this.parts.sideR=this.buildSide(this.sidePoints,d,c);this.parts.sideL=this.buildSide(this.sidePoints,d.negate(),c);this.parts.struts=this.buildStruts(i,o,a,n,s);this.parts.surface=this.buildSurface(this.surfaceSidePoints,o);this.parts.board=this.buildBoard(i,o,l);var p=t.slice(0);p.splice(p.length-2);var f=this.buildAnnotations(i,o,s,l,n,a,p);for(key in f){this.parts[key]=f[key]}Utils.makeAvailableForDebug("parts",this.parts)};Representation3D.prototype.getParts=function(){return this.parts};Representation3D.prototype.buildGrid=function(){return new Grid};Representation3D.prototype.buildSide=function(e,t,r){var i=new Side(e,t,r);return i};Representation3D.prototype.buildStruts=function(e,t,r,i,a){var n=this.config;var s=[];var o=t;var l=Math.ceil(i/n.model3d.struts.maximumDistance);var c=l;var h=n.model3d.struts.side,u=n.model3d.sides.extraLength;var d=n.model3d.sides.minHeight;var p=Math.acos(1-d/a);var f=h/(2*a);var v,m;while(c){var E=r*c/l;var g=E*Math.PI/180-f;var y=a*(1-Math.cos(g));if(y<h){h=n.model3d.struts.smallSide}if(y<h){break}m=new THREE.Vector3(0,0,0);v=new Strut(o,h,a,g,m,this.imageList);s.push(v);c--}h=n.model3d.struts.side;m=new THREE.Vector3(e-h,h,0);v=new Strut(o,h,null,null,m,this.imageList);s.push(v);m=new THREE.Vector3(e*2/3,h,0);v=new Strut(o,h,null,null,m,this.imageList);s.push(v);return s};Representation3D.prototype.buildSurface=function(e,t){var r=t+2*this.config.model3d.sides.thickness/60;var i=new Surface(e,r,this.imageList);return i};Representation3D.prototype.buildSlats=function(e,t,r,i){var a=this.config;var n=a.model3d.slats.defaultLength;var s=a.model3d.slats.thickness;var o=[];var l=0;var c;var h=r;var u=Math.ceil(h/n);var d;var p=0,f,v;var m;var E=[];p=u;while(p){
l=t*p/u;c=l*Math.PI/180;E.push(l);d=n;h-=d;f=i*Math.sin(c);v=i*(1-Math.cos(c));m=new THREE.Vector3(f,v,0);o.push(new Slat(e+.125,d,s,l,m,this.imageList));p--}return o};Representation3D.prototype.buildAnnotations=function(e,t,r,i,a,n,s){var o=this.config,l=.2,c=l,h=new THREE.MeshBasicMaterial({color:16777215}),u=new THREE.LineBasicMaterial({color:16777215,linewidth:2}),d=n*Math.PI/180,p=2,f=e+l*Math.cos(d)-o.model3d.sides.extraLength,v=i+l*Math.sin(d);return{length:new Annotation(Annotation.types.STRAIGHT,{name:"length",origin:new THREE.Vector3(0,-l,t/2),length:e,text:this.getHumanReadableDimension_(e,o.units),textDistance:c,rotation:new THREE.Euler(0,0,0,"XYZ"),material:h,lineMaterial:u,hasStartTip:true,hasEndTip:true,switchTextPosition:false}),width:new Annotation(Annotation.types.STRAIGHT,{name:"width",origin:new THREE.Vector3(f-.02,v,-t/2),length:t,text:this.getHumanReadableDimension_(t,o.units),textDistance:c,rotation:new THREE.Euler(0,-Math.PI/2,0,"XYZ"),material:h,lineMaterial:u,hasStartTip:true,hasEndTip:true,switchTextPosition:true,visibilityFunction:function(e){return e.get("repType")=="3d"&&e.get("annotations")}}),height:new Annotation(Annotation.types.STRAIGHT,{name:"height",origin:new THREE.Vector3(e+l,0,t/2),length:i,text:this.getHumanReadableDimension_(i,o.units),textDistance:c,rotation:new THREE.Euler(0,0,Math.PI/2,"XYZ"),material:h,lineMaterial:u,hasStartTip:true,hasEndTip:true,switchTextPosition:false}),radius:new Annotation(Annotation.types.STRAIGHT,{name:"radius",origin:new THREE.Vector3(0,l,-t/2),length:p-l,text:this.getHumanReadableDimension_(r,o.units),textDistance:c,rotation:new THREE.Euler(0,0,Math.PI/2,"XYZ"),material:h,lineMaterial:u,hasStartTip:true,hasEndTip:false,switchTextPosition:false}),arc:new Annotation(Annotation.types.CURVED,{name:"arc",origin:new THREE.Vector3(0,0,-t/2),arc:a,angle:n,radius:r,text:this.getHumanReadableDimension_(a,o.units),distance:l,textDistance:c,material:h,lineMaterial:u}),angle:new Annotation(Annotation.types.ANGLE,{name:"angle",origin:new THREE.Vector3(f,v,t/2),angle:n,text:this.getHumanReadableDimension_(n,o.UNIT_DEGREES),cornerSide:.25,textDistance:.1,material:h,lineMaterial:u})}};Representation3D.prototype.getHumanReadableDimension_=function(e,t){if(t==config.UNIT_METERS){return e.toFixed(2)+"m"}if(t==config.UNIT_DEGREES){return e.toFixed(0)+"Â°"}if(t==config.UNIT_FEET){return Utils.metersToDumb(e)}throw new Error("Unit '"+t+"' not supported")};Representation3D.prototype.buildBoard=function(e,t,r){var i=new Board(e,t,r,this.renderer);return i};Representation3D.prototype.setConfig=function(e){this.config=e};var EditorScene=function(){};EditorScene.createCameras=function(e,t){var r=e.parentElement;var i=EditorScene.createPerspectiveCamera_(r);var a=EditorScene.createOrthoCamera_(r,t);return{perspective:i,ortho:a}};EditorScene.createPerspectiveCamera_=function(e){var t=e.clientWidth/e.clientHeight;var r=new THREE.PerspectiveCamera(50,t,1,1e3);r.position.copy(new THREE.Vector3(-.95,2.64,3.85));return r};EditorScene.createOrthoCamera_=function(e,t){var r=e.clientWidth/e.clientHeight,i=new BoundingBoxHelper(t),a=.1,n,s;i.update(true);var o=(1+a)*Math.ceil(i.box.max.x-i.box.min.x),l=(1+a)*Math.ceil(i.box.max.y-i.box.min.y);var c=(i.box.max.x+i.box.min.x)/2,h=(i.box.max.y+i.box.min.y)/2;if(o>l){n=o;s=n/r}else{s=l;n=s*r}var u=s;var d={viewSize:u,aspectRatio:r,left:c-n/2,right:c+n/2,top:h+s/2,bottom:h-s/2,near:-10,far:10};var p=new THREE.OrthographicCamera(d.left,d.right,d.top,d.bottom,d.near,d.far);return p};EditorScene.getScene=function(){var e=new THREE.Scene;var t=new THREE.DirectionalLight(16777215);t.position.set(300,10,300);e.add(t);var r=new THREE.DirectionalLight(16777215);r.position.set(-100,200,-120);e.add(r);return e};EditorScene.createKicker=function(e,t,r,i){var a=new THREE.Object3D;var n=e.model.create3dObject(t,r,i);Utils.iterateOverParts(n.parts,function(e){for(n in e.meshes){if(!e.meshes[n]){continue}a.add(e.meshes[n])}});return a};EditorScene.getRenderer=function(e){var t={antialias:true,canvas:e,alpha:true,preserveDrawingBuffer:true};if(!window.WebGLRenderingContext){return new THREE.CanvasRenderer(t)}else{return threeRenderer=new THREE.WebGLRenderer(t)}};THREE.OrbitControls=function(e,t){this.object=e;this.domElement=t!==undefined?t:document;this.enabled=true;this.target=new THREE.Vector3;this.center=this.target;this.noZoom=false;this.zoomSpeed=1;this.minDistance=0;this.maxDistance=Infinity;this.noRotate=false;this.rotateSpeed=1;this.noPan=false;this.keyPanSpeed=7;this.autoRotate=false;this.autoRotateSpeed=2;this.minPolarAngle=0;this.maxPolarAngle=Math.PI;this.noKeys=false;this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var r=this;var i=1e-6;var a=new THREE.Vector2;var n=new THREE.Vector2;var s=new THREE.Vector2;var o=new THREE.Vector2;var l=new THREE.Vector2;var c=new THREE.Vector2;var h=new THREE.Vector3;var u=new THREE.Vector3;var d=new THREE.Vector2;var p=new THREE.Vector2;var f=new THREE.Vector2;var v=0;var m=0;var E=1;var g=new THREE.Vector3;var y=new THREE.Vector3;var b={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5};var T=b.NONE;this.target0=this.target.clone();this.position0=this.object.position.clone();var w=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0));var x=w.clone().inverse();var R={type:"change"};var k={type:"start"};var H={type:"end"};this.rotateLeft=function(e){if(e===undefined){e=S()}m-=e};this.rotateUp=function(e){if(e===undefined){e=S()}v-=e};this.panLeft=function(e){var t=this.object.matrix.elements;h.set(t[0],t[1],t[2]);h.multiplyScalar(-e);g.add(h)};this.panUp=function(e){var t=this.object.matrix.elements;h.set(t[4],t[5],t[6]);h.multiplyScalar(e);g.add(h)};this.pan=function(e,t){var i=r.domElement===document?r.domElement.body:r.domElement;if(r.object.fov!==undefined){var a=r.object.position;var n=a.clone().sub(r.target);var s=n.length();s*=Math.tan(r.object.fov/2*Math.PI/180);r.panLeft(2*e*s/i.clientHeight);r.panUp(2*t*s/i.clientHeight)}else if(r.object.top!==undefined){r.panLeft(e*(r.object.right-r.object.left)/i.clientWidth);r.panUp(t*(r.object.top-r.object.bottom)/i.clientHeight)}else{console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")}};this.dollyIn=function(e){if(e===undefined){e=M()}E/=e};this.dollyOut=function(e){if(e===undefined){e=M()}E*=e};this.update=function(){var e=this.object.position;u.copy(e).sub(this.target);u.applyQuaternion(w);var t=Math.atan2(u.x,u.z);var r=Math.atan2(Math.sqrt(u.x*u.x+u.z*u.z),u.y);if(this.autoRotate){this.rotateLeft(S())}t+=m;r+=v;r=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,r));r=Math.max(i,Math.min(Math.PI-i,r));var a=u.length()*E;a=Math.max(this.minDistance,Math.min(this.maxDistance,a));this.target.add(g);u.x=a*Math.sin(r)*Math.sin(t);u.y=a*Math.cos(r);u.z=a*Math.sin(r)*Math.cos(t);u.applyQuaternion(x);e.copy(this.target).add(u);this.object.lookAt(this.target);m=0;v=0;E=1;g.set(0,0,0);if(y.distanceToSquared(this.object.position)>i){this.dispatchEvent(R);y.copy(this.object.position)}};this.reset=function(){T=b.NONE;this.target.copy(this.target0);this.object.position.copy(this.position0);this.update()};function S(){return 2*Math.PI/60/60*r.autoRotateSpeed}function M(){return Math.pow(.95,r.zoomSpeed)}function N(e){if(r.enabled===false)return;e.preventDefault();if(e.button===0){if(r.noRotate===true)return;T=b.ROTATE;a.set(e.clientX,e.clientY)}else if(e.button===1){if(r.noZoom===true)return;T=b.DOLLY;d.set(e.clientX,e.clientY)}else if(e.button===2){if(r.noPan===true)return;T=b.PAN;o.set(e.clientX,e.clientY)}r.domElement.addEventListener("mousemove",C,false);r.domElement.addEventListener("mouseup",O,false);r.dispatchEvent(k)}function C(e){if(r.enabled===false)return;e.preventDefault();var t=r.domElement===document?r.domElement.body:r.domElement;if(T===b.ROTATE){if(r.noRotate===true)return;n.set(e.clientX,e.clientY);s.subVectors(n,a);r.rotateLeft(2*Math.PI*s.x/t.clientWidth*r.rotateSpeed);r.rotateUp(2*Math.PI*s.y/t.clientHeight*r.rotateSpeed);a.copy(n)}else if(T===b.DOLLY){if(r.noZoom===true)return;p.set(e.clientX,e.clientY);f.subVectors(p,d);if(f.y>0){r.dollyIn()}else{r.dollyOut()}d.copy(p)}else if(T===b.PAN){if(r.noPan===true)return;l.set(e.clientX,e.clientY);c.subVectors(l,o);r.pan(c.x,c.y);o.copy(l)}r.update()}function O(){if(r.enabled===false)return;r.domElement.removeEventListener("mousemove",C,false);r.domElement.removeEventListener("mouseup",O,false);r.dispatchEvent(H);T=b.NONE}function A(e){if(r.enabled===false||r.noZoom===true)return;e.preventDefault();e.stopPropagation();var t=0;if(e.wheelDelta!==undefined){t=e.wheelDelta}else if(e.detail!==undefined){t=-e.detail}if(t>0){r.dollyOut()}else{r.dollyIn()}r.update();r.dispatchEvent(k);r.dispatchEvent(H)}function _(e){if(r.enabled===false||r.noKeys===true||r.noPan===true)return;switch(e.keyCode){case r.keys.UP:r.pan(0,r.keyPanSpeed);r.update();break;case r.keys.BOTTOM:r.pan(0,-r.keyPanSpeed);r.update();break;case r.keys.LEFT:r.pan(r.keyPanSpeed,0);r.update();break;case r.keys.RIGHT:r.pan(-r.keyPanSpeed,0);r.update();break}}function j(e){if(r.enabled===false)return;switch(e.touches.length){case 1:if(r.noRotate===true)return;T=b.TOUCH_ROTATE;a.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(r.noZoom===true)return;T=b.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX;var i=e.touches[0].pageY-e.touches[1].pageY;var n=Math.sqrt(t*t+i*i);d.set(0,n);break;case 3:if(r.noPan===true)return;T=b.TOUCH_PAN;o.set(e.touches[0].pageX,e.touches[0].pageY);break;default:T=b.NONE}r.dispatchEvent(k)}function V(e){if(r.enabled===false)return;e.preventDefault();e.stopPropagation();var t=r.domElement===document?r.domElement.body:r.domElement;switch(e.touches.length){case 1:if(r.noRotate===true)return;if(T!==b.TOUCH_ROTATE)return;n.set(e.touches[0].pageX,e.touches[0].pageY);s.subVectors(n,a);r.rotateLeft(2*Math.PI*s.x/t.clientWidth*r.rotateSpeed);r.rotateUp(2*Math.PI*s.y/t.clientHeight*r.rotateSpeed);a.copy(n);r.update();break;case 2:if(r.noZoom===true)return;if(T!==b.TOUCH_DOLLY)return;var i=e.touches[0].pageX-e.touches[1].pageX;var h=e.touches[0].pageY-e.touches[1].pageY;var u=Math.sqrt(i*i+h*h);p.set(0,u);f.subVectors(p,d);if(f.y>0){r.dollyOut()}else{r.dollyIn()}d.copy(p);r.update();break;case 3:if(r.noPan===true)return;if(T!==b.TOUCH_PAN)return;l.set(e.touches[0].pageX,e.touches[0].pageY);c.subVectors(l,o);r.pan(c.x,c.y);o.copy(l);r.update();break;default:T=b.NONE}}function I(){if(r.enabled===false)return;r.dispatchEvent(H);T=b.NONE}this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},false);this.domElement.addEventListener("mousedown",N,false);this.domElement.addEventListener("mousewheel",A,false);this.domElement.addEventListener("DOMMouseScroll",A,false);this.domElement.addEventListener("touchstart",j,false);this.domElement.addEventListener("touchend",I,false);this.domElement.addEventListener("touchmove",V,false);window.addEventListener("keydown",_,false);this.update()};THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype);var Part=function(){this.meshes={"2d":null,"3d":null}};Part.prototype.setMeshVisibilityForDisplay=function(e){var t=e.get("repType");for(rep in this.meshes){if(!this.meshes[rep]){continue}this.meshes[rep].visible=false}if(t=="2d"||!e.get("textured")){if(this.meshes["2d"]){this.meshes["2d"].visible=true}}else{if(this.meshes["3d"]){this.meshes["3d"].visible=true}}if(this.edges){this.edges.material.linewidth=t=="2d"?2:1}};Part.prototype.createGhostFor=function(e){var t=Math.PI,r=new THREE.Object3D;this.edges=new THREE.EdgesHelper(e,16317183,t);r.add(this.edges);return r};Part.prototype.getTexture=function(e){return THREE.ImageUtils.loadTexture(e,undefined,this.requestRedraw_.bind(this))};Part.prototype.requestRedraw_=function(){var e=new CustomEvent("renderer-event",{detail:{type:"redraw"}});document.body.dispatchEvent(e)};var Angle=function(e,t,r,i){this.origin=e;this.angleDeg=t;this.angleRad=t*Math.PI/180;this.material=i;var a=new THREE.Object3D;a.add(this.createCorner_(r));var n=r*.6;a.add(this.createArc_(n,12));this.mesh=a};Angle.prototype.createCorner_=function(e){var t=new THREE.Geometry;t.vertices=[new THREE.Vector3(e,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(e*Math.cos(this.angleRad),e*Math.sin(this.angleRad),0)];var r=new THREE.Line(t,this.material);r.name="angleCorner";return r};Angle.prototype.createArc_=function(e,t){var r=new THREE.Geometry;for(var i=0;i<=t;i++){r.vertices.push(new THREE.Vector3(e*Math.cos(this.angleRad*i/t),e*Math.sin(this.angleRad*i/t),0))}var a=new THREE.Line(r,this.material);a.name="angleArc";return a};var Annotation=function(e,t){Part.call(this);var r;if(t.visibilityFunction){this.visibilityFunction_=t.visibilityFunction}else{this.visibilityFunction_=null}switch(e){case Annotation.types.STRAIGHT:r=this.getStraight_(t);break;case Annotation.types.CURVED:r=this.getCurved_(t);break;case Annotation.types.ANGLE:r=this.getAngle_(t);break;default:throw new Error("Annotation type not supported: "+e)}this.meshes["3d"]=null;this.meshes["2d"]=r};Annotation.prototype=new Part;Annotation.prototype.setMeshVisibilityForDisplay=function(e){var t;if(this.visibilityFunction_){t=this.visibilityFunction_(e)}else{t=e.get("annotations")}this.meshes["2d"].visible=t};Annotation.prototype.getStraight_=function(e){var t=new THREE.Object3D;t.name=e.name;var r=new Arrow(e.length,e.lineMaterial,e.hasStartTip,e.hasEndTip);var i=new Text(e.text,e.material);var a=(e.switchTextPosition?1:-1)*e.textDistance;i.mesh.position.copy(new THREE.Vector3(e.length/2+i.offsetX,a,0));t.add(r.mesh);t.add(i.mesh);t.position.copy(e.origin);t.rotation.copy(e.rotation);return t};Annotation.prototype.getCurved_=function(e){var t=new THREE.Object3D;t.name=e.name;var r=new CurvedArrow(e.arc,e.angle,e.radius,e.distance,e.lineMaterial);var i=r.points;t.add(r.mesh);var a=new Text(e.text,e.material);t.add(a.mesh);var n=e.angle*Math.PI/180;a.mesh.rotation.z=n/2;a.mesh.position.x=(i[0][0]+i[i.length-1][0])/2+a.offsetX/2;a.mesh.position.y=(i[0][1]+i[i.length-1][1])/2-.15;t.position.copy(e.origin);return t};Annotation.prototype.getAngle_=function(e){var t=new THREE.Object3D;t.name=e.name;var r=new Angle(e.origin,e.angle,e.cornerSide,e.lineMaterial);t.add(r.mesh);var i=new Text(e.text,e.material);i.mesh.position.copy(new THREE.Vector3(e.cornerSide,e.textDistance,0));t.add(i.mesh);t.position.copy(e.origin);return t};Annotation.types={STRAIGHT:"STRAIGHT",CURVED:"CURVED",ANGLE:"ANGLE"};var Arrow=function(e,t,r,i){this.start=new THREE.Vector3(0,0,0);this.end=new THREE.Vector3(e,0,0);this.material=t;var a=new THREE.Object3D;var n=.1;if(r){var s=this.createStartTip(n,t);a.add(s)}var o=this.createLine();a.add(o);if(i){var l=this.createEndTip(n,e,t);a.add(l)}this.mesh=a};Arrow.prototype.createLine=function(){var e=new THREE.Geometry;e.vertices.push(this.start);e.vertices.push(this.end);var t=new THREE.Line(e,this.material);return t};Arrow.prototype.createStartTip=function(e,t){var r=new THREE.Vector3(e,-e/2,0);var i=new THREE.Vector3(0,0,0);var a=new THREE.Vector3(e,e/2,0);var n=new THREE.Geometry;n.vertices.push(r);n.vertices.push(i);n.vertices.push(a);var s=new THREE.Line(n,t);return s};Arrow.prototype.createEndTip=function(e,t,r){var i=new THREE.Vector3(-e+t,-e/2,0);var a=new THREE.Vector3(t,0,0);var n=new THREE.Vector3(-e+t,e/2,0);var s=new THREE.Geometry;s.vertices.push(i);s.vertices.push(a);s.vertices.push(n);var o=new THREE.Line(s,r);return o};var Board=function(e,t,r,i){Part.call(this);this.length=e;this.width=t;this.height=r;this.renderer=i;this.createMeshes()};Board.prototype=new Part;Board.prototype.createMeshes=function(){var e=this.renderer.getModel("board");if(!e.name){var t=new THREE.ColladaLoader;t.options.convertUpAxis=true;t.load("./models/board.dae",this.onBoardLoaded.bind(this))}var r=.5,i=.1;z=this.width/2+1;e.position.set(r,i,z);e.scale.set(.5,.5,.5);e.rotation.set(0,10*Math.PI/64,0);this.meshes["3d"]=e;this.meshes["2d"]=e};Board.prototype.onBoardLoaded=function(e){var t=e.scene;t.name="mountainboard";this.renderer.replaceModel("board",t);this.createMeshes()};Board.prototype.setMeshVisibilityForDisplay=function(e){var t=e.get("repType");this.meshes["2d"].visible=false;this.meshes["3d"].visible=t=="3d"&&e.get("mountainboard")};var CurvedArrow=function(e,t,r,i,a){var n=5;var s=this.calculatePoints(n,t,r,i);var o=new THREE.Object3D;var l=.05;var c=this.createStartTip(s[0],l,a);o.add(c);var h=this.createLine(s,a);o.add(h);var u=this.createEndTip(s[s.length-1],l,e-.05,t+n,a);o.add(u);this.mesh=o;this.points=s};CurvedArrow.prototype.createLine=function(e,t){var r=new THREE.Geometry;e.forEach(function(e){r.vertices.push(new THREE.Vector3(e[0],e[1],0))});var i=new THREE.Line(r,t);return i};CurvedArrow.prototype.createStartTip=function(e,t,r){var i=new THREE.Vector3(t+e[0],-t/2+e[1],0);var a=new THREE.Vector3(0+e[0],0+e[1],0);var n=new THREE.Vector3(t+e[0],t/2+e[1],0);var s=new THREE.Geometry;s.vertices.push(i);s.vertices.push(a);s.vertices.push(n);var o=new THREE.Line(s,r);return o};CurvedArrow.prototype.createEndTip=function(e,t,r,i,a){var n=i*Math.PI/180;var s=new THREE.Euler(0,0,n,"XYZ");var o=new THREE.Geometry;o.vertices.push(new THREE.Vector3(-t,-t/2,0));o.vertices.push(new THREE.Vector3(0,0,0));o.vertices.push(new THREE.Vector3(-t,+t/2,0));o.vertices.forEach(function(t){t.applyEuler(s);t.add(new THREE.Vector3(e[0],e[1]))});var l=new THREE.Line(o,a);return l};CurvedArrow.prototype.calculatePoints=function(e,t,r,i){var a=[];var n=r-i,s=config.model3d.sides.extraLength;var o=e*Math.PI/180;var l=t*Math.PI/180;var c=20;var h,u,d;for(var p=0;p<=c;p++){h=p/c*(l-o)+o;u=n*Math.sin(h);d=n*(1-Math.cos(h));a.push([u,d])}a.forEach(function(e){e[0]-=s;e[1]+=i});return a};var Grid=function(e,t){Part.call(this);this.meshes["2d"]=null;this.meshes["3d"]=this.createGrid_()};Grid.prototype=new Part;Grid.prototype.setMeshVisibilityForDisplay=function(e){this.meshes["3d"].visible=e.get("grid")&&e.get("repType")=="3d"};Grid.prototype.createGrid_=function(){var e=new THREE.GridHelper(100,1);e.setColors(16317183,67653);e.name="grid";return e};var Side=function(e,t,r){Part.call(this);this.points=e;this.imageList=r;var i=this.createMesh(e,t);this.meshes["3d"]=i;this.meshes["2d"]=this.createGhostFor(i)};Side.prototype=new Part;Side.prototype.createMesh=function(e,t){var r=this.buildGeometry(e,t);var i=this.getTexture(this.imageList.getImageUrl("side"));var a=new THREE.MeshLambertMaterial({map:i});var n=new THREE.Mesh(r,a);n.name="Side";n.randomId=Math.random()*100;return n};Side.prototype.buildGeometry=function(e,t){var r,i;var a=new THREE.Shape;a.moveTo(e[0][0],e[0][1]);for(r=1,i=e.length;r<i;r++){a.lineTo(e[r][0],e[r][1])}var n={amount:config.model3d.sides.thickness,bevelSize:0,bevelSegments:1,bevelThickness:0};var s=new THREE.ExtrudeGeometry(a,n);Utils.setupUVMapping(s);var o=new THREE.Vector3;o.z=-config.model3d.sides.thickness/2;o=o.add(t);s.vertices.forEach(function(e){e.add(o)});return s};var Slat=function(e,t,r,i,a,n){this.length=t;this.thickness=r;this.imageList=n;this.mesh=this.createMesh(e,t,r,60);var s=Math.PI*i/180;this.mesh.rotateOnAxis(new THREE.Vector3(0,0,1),s);this.mesh.position=a};Slat.prototype.createMesh=function(e,t,r,i){var a=this.buildGeometry(e,t,r,i);var n=new THREE.MeshLambertMaterial({map:this.getTexture(this.imageList.getImageUrl("slat"))});var s=new THREE.Mesh(a,n);s.name="Slat";return s};Slat.prototype.buildGeometry=function(e,t,r,i){var a=config.model3d.slats.space;var n=(t-a)*i,s=r*i;z=e*i;var o=new THREE.BoxGeometry(n,s,z);var l=new THREE.Vector3(-n/2,s/2,0);o.vertices.forEach(function(e){e.add(l)});return o};var Strut=function(e,t,r,i,a,n){Part.call(this);this.thickness=t;this.imageList=n;var s=this.createMesh(e,t,r,i,a);this.meshes["3d"]=s;this.meshes["2d"]=this.createGhostFor(s)};Strut.prototype=new Part;Strut.prototype.createMesh=function(e,t,r,i,a){var n=this.buildGeometry(e,t);var s=new THREE.MeshLambertMaterial({map:this.getTexture(this.imageList.getImageUrl("strut"))});var o=new THREE.Mesh(n,s);o.name="Strut";if(r){this.positionByAngle(o,r,i)}if(a){this.applyOffset(o,a)}return o};Strut.prototype.buildGeometry=function(e,t){var r=new THREE.BoxGeometry(t,t,e);return r};Strut.prototype.positionByAngle=function(e,t,r){var i=new THREE.Vector3(0,-t-this.thickness/2,0);var a=new THREE.Vector3(0,t,0);e.geometry.vertices.forEach(function(e){e.add(i);var t=new THREE.Matrix4;t.set(Math.cos(-r),Math.sin(-r),0,0,-Math.sin(-r),Math.cos(-r),0,0,0,0,1,0,0,0,0,1);e.applyMatrix4(t);e.add(a)})};Strut.prototype.applyOffset=function(e,t){e.geometry.vertices.forEach(function(e){e.add(t)})};var Surface=function(e,t,r){Part.call(this);this.points=e.slice(0);this.width=t;this.imageList=r;var i=this.createMesh(this.points,t+config.model3d.sides.thickness*2);this.meshes["3d"]=i;this.meshes["2d"]=this.createGhostFor(i)};Surface.prototype=new Part;Surface.prototype.createMesh=function(e,t){var r=this.buildGeometry(e,t);var i=this.getTexture(this.imageList.getImageUrl("side"));var a=new THREE.MeshLambertMaterial({map:i});var n=new THREE.Mesh(r,a);n.name="Surface";return n};Surface.prototype.buildGeometry=function(e,t){var r=new THREE.Shape;r.moveTo(e[0][0],e[0][1]);for(var i=1,a=e.length;i<a;i++){r.lineTo(e[i][0],e[i][1])}var n={amount:t,bevelSize:0,bevelSegments:1,bevelThickness:0};var s=new THREE.ExtrudeGeometry(r,n);var o=new THREE.Vector3(0,0,-t/2);s.vertices.forEach(function(e){e.add(o)});Utils.setupUVMapping(s,"z","y");return s};var Text=function(e,t){this.mesh=this.createMesh(e,t)};Text.prototype.createMesh=function(e,t){var r=this.buildGeometry(e);var i=new THREE.Mesh(r,t);i.name="Text - "+" - "+e;var a=r.boundingBox;var n=a.max.sub(a.min);this.offsetX=-n.x/2;this.offsetY=-n.y/2;return i};Text.prototype.buildGeometry=function(e){var t=new THREE.TextGeometry(e,{size:.15,height:0,font:"archer medium"});t.computeBoundingBox();return t};Box=function(e,t){THREE.Box3.call(this,e,t)};Box.prototype=Object.create(THREE.Box3.prototype);Box.prototype.constructor=Box;Box.prototype.setFromObject=function(){var e=new THREE.Vector3;return function(t,r){var i=this;t.updateMatrixWorld(true);this.makeEmpty();t.traverse(function(t){if(r&&!t.visible){return}var a=t.geometry;if(a!==undefined){if(a instanceof THREE.Geometry){var n=a.vertices;for(var s=0,o=n.length;s<o;s++){e.copy(n[s]);e.applyMatrix4(t.matrixWorld);i.expandByPoint(e)}}else if(a instanceof THREE.BufferGeometry&&a.attributes["position"]!==undefined){var l=a.attributes["position"].array;for(var s=0,o=l.length;s<o;s+=3){e.set(l[s],l[s+1],l[s+2]);e.applyMatrix4(t.matrixWorld);i.expandByPoint(e)}}}});return this}}();BoundingBoxHelper=function(e,t){var r=t!==undefined?t:8947848;this.object=e;this.box=new Box;THREE.Mesh.call(this,new THREE.BoxGeometry(1,1,1),new THREE.MeshBasicMaterial({color:r,wireframe:true}))};BoundingBoxHelper.prototype=Object.create(THREE.Mesh.prototype);BoundingBoxHelper.prototype.constructor=THREE.BoundingBoxHelper;BoundingBoxHelper.prototype.update=function(e){this.box.setFromObject(this.object,e);this.box.size(this.scale);this.box.center(this.position)};THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this);this.type="SpriteCanvasMaterial";this.color=new THREE.Color(16777215);this.program=function(e,t){};this.setValues(e)};THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype);THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial;THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;THREE.Material.prototype.clone.call(this,e);e.color.copy(this.color);e.program=this.program;return e};THREE.CanvasRenderer=function(e){console.log("THREE.CanvasRenderer",THREE.REVISION);var t=THREE.Math.smoothstep;e=e||{};var r=this,i,a,n,s=new THREE.Projector,o=e.canvas!==undefined?e.canvas:document.createElement("canvas"),l=o.width,c=o.height,h=Math.floor(l/2),u=Math.floor(c/2),d=0,p=0,f=l,v=c,m=1,E=o.getContext("2d",{alpha:e.alpha===true}),g=new THREE.Color(0),y=e.alpha===true?0:1,b=1,T=0,w=null,x=null,R=null,k=null,H=null,S=[],M,N,C,O,A,_=new THREE.RenderableVertex,j=new THREE.RenderableVertex,V,I,L,D,P,B,z,U,F,G,q,Y,X=new THREE.Color,W=new THREE.Color,K=new THREE.Color,Z=new THREE.Color,J=new THREE.Color,Q=new THREE.Color,$=new THREE.Color,ee=new THREE.Color,te={},re,ie,ae,ne,se,oe,le,ce,he=new THREE.Box2,ue=new THREE.Box2,de=new THREE.Box2,pe=new THREE.Color,fe=new THREE.Color,ve=new THREE.Color,me=new THREE.Vector3,Ee=new THREE.Vector3,ge=new THREE.Vector3,ye=new THREE.Matrix3;if(E.setLineDash===undefined){E.setLineDash=function(){}}this.domElement=o;this.autoClear=true;this.sortObjects=true;this.sortElements=true;this.info={render:{vertices:0,faces:0}};this.supportsVertexTextures=function(){};this.setFaceCulling=function(){};this.getPixelRatio=function(){return m};this.setPixelRatio=function(e){m=e};this.setSize=function(e,t,r){l=e*m;c=t*m;o.width=l;o.height=c;h=Math.floor(l/2);u=Math.floor(c/2);if(r!==false){o.style.width=e+"px";o.style.height=t+"px"}he.min.set(-h,-u),he.max.set(h,u);ue.min.set(-h,-u);ue.max.set(h,u);b=1;T=0;w=null;x=null;R=null;k=null;H=null;this.setViewport(0,0,e,t)};this.setViewport=function(e,t,r,i){d=e*m;p=t*m;f=r*m;v=i*m};this.setScissor=function(){};this.enableScissorTest=function(){};this.setClearColor=function(e,t){g.set(e);y=t!==undefined?t:1;ue.min.set(-h,-u);ue.max.set(h,u)};this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead.");this.setClearColor(e,t)};this.getClearColor=function(){return g};this.getClearAlpha=function(){return y};this.getMaxAnisotropy=function(){return 0};this.clear=function(){if(ue.empty()===false){ue.intersect(he);ue.expandByScalar(2);ue.min.x=ue.min.x+h;ue.min.y=-ue.min.y+u;ue.max.x=ue.max.x+h;ue.max.y=-ue.max.y+u;if(y<1){E.clearRect(ue.min.x|0,ue.max.y|0,ue.max.x-ue.min.x|0,ue.min.y-ue.max.y|0)}if(y>0){je(THREE.NormalBlending);_e(1);Pe("rgba("+Math.floor(g.r*255)+","+Math.floor(g.g*255)+","+Math.floor(g.b*255)+","+y+")");E.fillRect(ue.min.x|0,ue.max.y|0,ue.max.x-ue.min.x|0,ue.min.y-ue.max.y|0)}ue.makeEmpty()}};this.clearColor=function(){};this.clearDepth=function(){};this.clearStencil=function(){};this.render=function(e,t){if(t instanceof THREE.Camera===false){console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");return}if(this.autoClear===true)this.clear();r.info.render.vertices=0;r.info.render.faces=0;E.setTransform(f/l,0,0,-v/c,d,c-p);E.translate(h,u);i=s.projectScene(e,t,this.sortObjects,this.sortElements);a=i.elements;n=i.lights;M=t;ye.getNormalMatrix(t.matrixWorldInverse);be();for(var o=0,m=a.length;o<m;o++){var g=a[o];var y=g.material;if(y===undefined||y.opacity===0)continue;de.makeEmpty();if(g instanceof THREE.RenderableSprite){N=g;N.x*=h;N.y*=u;we(N,g,y)}else if(g instanceof THREE.RenderableLine){N=g.v1;C=g.v2;N.positionScreen.x*=h;N.positionScreen.y*=u;C.positionScreen.x*=h;C.positionScreen.y*=u;de.setFromPoints([N.positionScreen,C.positionScreen]);if(he.isIntersectionBox(de)===true){xe(N,C,g,y)}}else if(g instanceof THREE.RenderableFace){N=g.v1;C=g.v2;O=g.v3;if(N.positionScreen.z<-1||N.positionScreen.z>1)continue;if(C.positionScreen.z<-1||C.positionScreen.z>1)continue;if(O.positionScreen.z<-1||O.positionScreen.z>1)continue;N.positionScreen.x*=h;N.positionScreen.y*=u;C.positionScreen.x*=h;C.positionScreen.y*=u;O.positionScreen.x*=h;O.positionScreen.y*=u;if(y.overdraw>0){Ae(N.positionScreen,C.positionScreen,y.overdraw);Ae(C.positionScreen,O.positionScreen,y.overdraw);Ae(O.positionScreen,N.positionScreen,y.overdraw)}de.setFromPoints([N.positionScreen,C.positionScreen,O.positionScreen]);if(he.isIntersectionBox(de)===true){Re(N,C,O,0,1,2,g,y)}}ue.union(de)}E.setTransform(1,0,0,1,0,0)};function be(){pe.setRGB(0,0,0);fe.setRGB(0,0,0);ve.setRGB(0,0,0);for(var e=0,t=n.length;e<t;e++){var r=n[e];var i=r.color;if(r instanceof THREE.AmbientLight){pe.add(i)}else if(r instanceof THREE.DirectionalLight){fe.add(i)}else if(r instanceof THREE.PointLight){ve.add(i)}}}function Te(e,t,r){for(var i=0,a=n.length;i<a;i++){var s=n[i];ee.copy(s.color);if(s instanceof THREE.DirectionalLight){var o=me.setFromMatrixPosition(s.matrixWorld).normalize();var l=t.dot(o);if(l<=0)continue;l*=s.intensity;r.add(ee.multiplyScalar(l))}else if(s instanceof THREE.PointLight){var o=me.setFromMatrixPosition(s.matrixWorld);var l=t.dot(me.subVectors(o,e).normalize());if(l<=0)continue;l*=s.distance==0?1:1-Math.min(e.distanceTo(o)/s.distance,1);if(l==0)continue;l*=s.intensity;r.add(ee.multiplyScalar(l))}}}function we(e,t,r){_e(r.opacity);je(r.blending);var i=t.scale.x*h;var a=t.scale.y*u;var n=.5*Math.sqrt(i*i+a*a);de.min.set(e.x-n,e.y-n);de.max.set(e.x+n,e.y+n);if(r instanceof THREE.SpriteMaterial){var s=r.map;if(s!==null&&s.image!==undefined){if(s.hasEventListener("update",Me)===false){if(s.image.width>0){Ne(s)}s.addEventListener("update",Me)}var o=te[s.id];if(o!==undefined){Pe(o)}else{Pe("rgba( 0, 0, 0, 1 )")}var l=s.image;var c=l.width*s.offset.x;var d=l.height*s.offset.y;var p=l.width*s.repeat.x;var f=l.height*s.repeat.y;var v=i/p;var m=a/f;E.save();E.translate(e.x,e.y);if(r.rotation!==0)E.rotate(r.rotation);E.translate(-i/2,-a/2);E.scale(v,m);E.translate(-c,-d);E.fillRect(c,d,p,f);E.restore()}else{Pe(r.color.getStyle());E.save();E.translate(e.x,e.y);if(r.rotation!==0)E.rotate(r.rotation);E.scale(i,-a);E.fillRect(-.5,-.5,1,1);E.restore()}}else if(r instanceof THREE.SpriteCanvasMaterial){De(r.color.getStyle());Pe(r.color.getStyle());E.save();E.translate(e.x,e.y);if(r.rotation!==0)E.rotate(r.rotation);E.scale(i,a);r.program(E);E.restore()}}function xe(e,t,r,i){_e(i.opacity);je(i.blending);E.beginPath();E.moveTo(e.positionScreen.x,e.positionScreen.y);E.lineTo(t.positionScreen.x,t.positionScreen.y);if(i instanceof THREE.LineBasicMaterial){Ve(i.linewidth);Ie(i.linecap);Le(i.linejoin);if(i.vertexColors!==THREE.VertexColors){De(i.color.getStyle())}else{var a=r.vertexColors[0].getStyle();var n=r.vertexColors[1].getStyle();if(a===n){De(a)}else{try{var s=E.createLinearGradient(e.positionScreen.x,e.positionScreen.y,t.positionScreen.x,t.positionScreen.y);s.addColorStop(0,a);s.addColorStop(1,n)}catch(o){s=a}De(s)}}E.stroke();de.expandByScalar(i.linewidth*2)}else if(i instanceof THREE.LineDashedMaterial){Ve(i.linewidth);Ie(i.linecap);Le(i.linejoin);De(i.color.getStyle());Be([i.dashSize,i.gapSize]);E.stroke();de.expandByScalar(i.linewidth*2);Be([])}}function Re(e,i,a,n,s,o,l,c){r.info.render.vertices+=3;r.info.render.faces++;_e(c.opacity);je(c.blending);V=e.positionScreen.x;I=e.positionScreen.y;L=i.positionScreen.x;D=i.positionScreen.y;P=a.positionScreen.x;B=a.positionScreen.y;ke(V,I,L,D,P,B);if((c instanceof THREE.MeshLambertMaterial||c instanceof THREE.MeshPhongMaterial)&&c.map===null){Q.copy(c.color);$.copy(c.emissive);if(c.vertexColors===THREE.FaceColors){Q.multiply(l.color)}X.copy(pe);Ee.copy(e.positionWorld).add(i.positionWorld).add(a.positionWorld).divideScalar(3);Te(Ee,l.normalModel,X);X.multiply(Q).add($);c.wireframe===true?He(X,c.wireframeLinewidth,c.wireframeLinecap,c.wireframeLinejoin):Se(X)}else if(c instanceof THREE.MeshBasicMaterial||c instanceof THREE.MeshLambertMaterial||c instanceof THREE.MeshPhongMaterial){if(c.map!==null){var h=c.map.mapping;if(h===THREE.UVMapping){ie=l.uvs;Ce(V,I,L,D,P,B,ie[n].x,ie[n].y,ie[s].x,ie[s].y,ie[o].x,ie[o].y,c.map)}}else if(c.envMap!==null){if(c.envMap.mapping===THREE.SphericalReflectionMapping){ge.copy(l.vertexNormalsModel[n]).applyMatrix3(ye);ae=.5*ge.x+.5;ne=.5*ge.y+.5;ge.copy(l.vertexNormalsModel[s]).applyMatrix3(ye);se=.5*ge.x+.5;oe=.5*ge.y+.5;ge.copy(l.vertexNormalsModel[o]).applyMatrix3(ye);le=.5*ge.x+.5;ce=.5*ge.y+.5;Ce(V,I,L,D,P,B,ae,ne,se,oe,le,ce,c.envMap)}}else{X.copy(c.color);if(c.vertexColors===THREE.FaceColors){X.multiply(l.color)}c.wireframe===true?He(X,c.wireframeLinewidth,c.wireframeLinecap,c.wireframeLinejoin):Se(X)}}else if(c instanceof THREE.MeshDepthMaterial){X.r=X.g=X.b=1-t(e.positionScreen.z*e.positionScreen.w,M.near,M.far);
c.wireframe===true?He(X,c.wireframeLinewidth,c.wireframeLinecap,c.wireframeLinejoin):Se(X)}else if(c instanceof THREE.MeshNormalMaterial){ge.copy(l.normalModel).applyMatrix3(ye);X.setRGB(ge.x,ge.y,ge.z).multiplyScalar(.5).addScalar(.5);c.wireframe===true?He(X,c.wireframeLinewidth,c.wireframeLinecap,c.wireframeLinejoin):Se(X)}else{X.setRGB(1,1,1);c.wireframe===true?He(X,c.wireframeLinewidth,c.wireframeLinecap,c.wireframeLinejoin):Se(X)}}function ke(e,t,r,i,a,n){E.beginPath();E.moveTo(e,t);E.lineTo(r,i);E.lineTo(a,n);E.closePath()}function He(e,t,r,i){Ve(t);Ie(r);Le(i);De(e.getStyle());E.stroke();de.expandByScalar(t*2)}function Se(e){Pe(e.getStyle());E.fill()}function Me(e){Ne(e.target)}function Ne(e){if(e instanceof THREE.CompressedTexture)return;var t=e.wrapS===THREE.RepeatWrapping;var r=e.wrapT===THREE.RepeatWrapping;var i=e.image;var a=document.createElement("canvas");a.width=i.width;a.height=i.height;var n=a.getContext("2d");n.setTransform(1,0,0,-1,0,i.height);n.drawImage(i,0,0);te[e.id]=E.createPattern(a,t===true&&r===true?"repeat":t===true&&r===false?"repeat-x":t===false&&r===true?"repeat-y":"no-repeat")}function Ce(e,t,r,i,a,n,s,o,l,c,h,u,d){if(d instanceof THREE.DataTexture)return;if(d.hasEventListener("update",Me)===false){if(d.image!==undefined&&d.image.width>0){Ne(d)}d.addEventListener("update",Me)}var p=te[d.id];if(p!==undefined){Pe(p)}else{Pe("rgba(0,0,0,1)");E.fill();return}var f,v,m,g,y,b,T,w,x=d.offset.x/d.repeat.x,R=d.offset.y/d.repeat.y,k=d.image.width*d.repeat.x,H=d.image.height*d.repeat.y;s=(s+x)*k;o=(o+R)*H;l=(l+x)*k;c=(c+R)*H;h=(h+x)*k;u=(u+R)*H;r-=e;i-=t;a-=e;n-=t;l-=s;c-=o;h-=s;u-=o;T=l*u-h*c;if(T===0)return;w=1/T;f=(u*r-c*a)*w;v=(u*i-c*n)*w;m=(l*a-h*r)*w;g=(l*n-h*i)*w;y=e-f*s-m*o;b=t-v*s-g*o;E.save();E.transform(f,v,m,g,y,b);E.fill();E.restore()}function Oe(e,t,r,i,a,n,s,o,l,c,h,u,d){var p,f,v,m,g,y,b,T,w=d.width-1,x=d.height-1;s*=w;o*=x;l*=w;c*=x;h*=w;u*=x;r-=e;i-=t;a-=e;n-=t;l-=s;c-=o;h-=s;u-=o;b=l*u-h*c;T=1/b;p=(u*r-c*a)*T;f=(u*i-c*n)*T;v=(l*a-h*r)*T;m=(l*n-h*i)*T;g=e-p*s-v*o;y=t-f*s-m*o;E.save();E.transform(p,f,v,m,g,y);E.clip();E.drawImage(d,0,0);E.restore()}function Ae(e,t,r){var i=t.x-e.x,a=t.y-e.y,n=i*i+a*a,s;if(n===0)return;s=r/Math.sqrt(n);i*=s;a*=s;t.x+=i;t.y+=a;e.x-=i;e.y-=a}function _e(e){if(b!==e){E.globalAlpha=e;b=e}}function je(e){if(T!==e){if(e===THREE.NormalBlending){E.globalCompositeOperation="source-over"}else if(e===THREE.AdditiveBlending){E.globalCompositeOperation="lighter"}else if(e===THREE.SubtractiveBlending){E.globalCompositeOperation="darker"}T=e}}function Ve(e){if(R!==e){E.lineWidth=e;R=e}}function Ie(e){if(k!==e){E.lineCap=e;k=e}}function Le(e){if(H!==e){E.lineJoin=e;H=e}}function De(e){if(w!==e){E.strokeStyle=e;w=e}}function Pe(e){if(x!==e){E.fillStyle=e;x=e}}function Be(e){if(S.length!==e.length){E.setLineDash(e);S=e}}};THREE.SoftwareRenderer=function(e){console.log("THREE.SoftwareRenderer",THREE.REVISION);e=e||{};var t=e.canvas!==undefined?e.canvas:document.createElement("canvas");var r=t.getContext("2d",{alpha:e.alpha===true});var i={};var a={};var n,s;var o,l;var c,h,u;var d,p,f;var v=new THREE.Color(0);var m,E,g;var y,b,T;var w=1<<0;var x=1<<1;var R=4;var k=(1<<R)-1;var H=3;var S=1<<H;var M=1<<24;var N=Infinity,C=Infinity;var O=0,A=0;var _=Infinity,j=Infinity;var V=0,I=0;var L=new THREE.Projector;var D=new THREE.Vector3;var P=new THREE.Vector3;var B=new THREE.Vector3;var z=new THREE.Vector2;var U=new THREE.Vector2;var F=new THREE.Vector2;this.domElement=t;this.autoClear=true;this.supportsVertexTextures=function(){};this.setFaceCulling=function(){};this.setClearColor=function(e,t){v.set(e);G()};this.setPixelRatio=function(){};this.setSize=function(e,i){o=Math.floor(e/S);l=Math.floor(i/S);n=o*S;s=l*S;var a=1<<R;c=a*n/2;h=-a*s/2;u=M/2;d=a*n/2+.5;p=a*s/2+.5;f=M/2+.5;t.width=n;t.height=s;r.fillStyle=v.getStyle();r.fillRect(0,0,n,s);m=r.getImageData(0,0,n,s);E=m.data;g=new Int32Array(E.length/4);y=o*l;b=new Int32Array(y);T=new Uint8Array(y);for(var x=0,k=g.length;x<k;x++){g[x]=M}for(var x=0;x<y;x++){T[x]=w}G()};this.setSize(t.width,t.height);this.clear=function(){N=Infinity;C=Infinity;O=0;A=0;for(var e=0;e<y;e++){b[e]=M;T[e]=T[e]&w?w:x}};this.render=function(e,t){if(this.autoClear===true)this.clear();var i=L.projectScene(e,t,false,false);var a=i.elements;for(var n=0,s=a.length;n<s;n++){var o=a[n];var l=o.material;var c=K(l);if(o instanceof THREE.RenderableFace){if(!o.uvs){J(o.v1.positionScreen,o.v2.positionScreen,o.v3.positionScreen,null,null,null,c,o,l)}else{J(o.v1.positionScreen,o.v2.positionScreen,o.v3.positionScreen,o.uvs[0],o.uvs[1],o.uvs[2],c,o,l)}}else if(o instanceof THREE.RenderableSprite){var h=o.scale.x*.5;var u=o.scale.y*.5;D.copy(o);D.x-=h;D.y+=u;P.copy(o);P.x-=h;P.y-=u;B.copy(o);B.x+=h;B.y+=u;if(l.map){z.set(0,1);U.set(0,0);F.set(1,1);J(D,P,B,z,U,F,c,o,l)}else{J(D,P,B,null,null,null,c,o,l)}D.copy(o);D.x+=h;D.y+=u;P.copy(o);P.x-=h;P.y-=u;B.copy(o);B.x+=h;B.y-=u;if(l.map){z.set(1,1);U.set(0,0);F.set(1,0);J(D,P,B,z,U,F,c,o,l)}else{J(D,P,B,null,null,null,c,o,l)}}}$();var d=Math.min(N,_);var p=Math.min(C,j);var f=Math.max(O,V)-d;var v=Math.max(A,I)-p;if(d!==Infinity){r.putImageData(m,0,0,d,p,f,v)}_=N;j=C;V=O;I=A};function G(){var e=n*s*4;for(var t=0;t<e;t+=4){E[t]=v.r*255|0;E[t+1]=v.g*255|0;E[t+2]=v.b*255|0;E[t+3]=255}r.fillStyle=v.getStyle();r.fillRect(0,0,n,s)}function q(e,t){var r=0,i=0;var a=e.color.r*255;var n=e.color.g*255;var s=e.color.b*255;var o=new Uint8Array(256*3);if(t){while(r<204){o[i++]=Math.min(r*a/204,255);o[i++]=Math.min(r*n/204,255);o[i++]=Math.min(r*s/204,255);++r}while(r<256){o[i++]=Math.min(a+(r-204)*(255-a)/82,255);o[i++]=Math.min(n+(r-204)*(255-n)/82,255);o[i++]=Math.min(s+(r-204)*(255-s)/82,255);++r}}else{while(r<256){o[i++]=Math.min(r*a/255,255);o[i++]=Math.min(r*n/255,255);o[i++]=Math.min(r*s/255,255);++r}}return o}function Y(e,t,r,i,n,s,o,l,c){var h=r*4;var u=a[c.map.id];if(!u.data)return;var d=u.width;var p=c.transparent;var f=d-1;var v=u.data;var m=((s*d&f)*d+(n*d&f))*4;if(!p){e[h]=v[m];e[h+1]=v[m+1];e[h+2]=v[m+2];e[h+3]=c.opacity*255;t[r]=i}else{var E=v[m+3]*c.opacity;var g=(v[m]<<16)+(v[m+1]<<8)+v[m+2];if(E<250){var y=(e[h]<<16)+(e[h+1]<<8)+e[h+2];g=g*E+y*(1-E)}e[h]=(g&16711680)>>16;e[h+1]=(g&65280)>>8;e[h+2]=g&255;e[h+3]=c.opacity*255}}function X(e,t,r,i,n,s,o,l,c){var h=r*4;var u=a[c.map.id];if(!u.data)return;var d=u.width;var p=c.transparent;var f=(o>0?~~o:0)*3;var v=d-1;var m=u.data;var E=((s*d&v)*d+(n*d&v))*4;if(!p){e[h]=c.palette[f]*m[E]>>8;e[h+1]=c.palette[f+1]*m[E+1]>>8;e[h+2]=c.palette[f+2]*m[E+2]>>8;e[h+3]=c.opacity*255;t[r]=i}else{var g=m[E+3]*c.opacity;var y=(c.palette[f]*m[E]<<16)+(c.palette[f+1]*m[E+1]<<8)+c.palette[f+2]*m[E+2];if(g<250){var b=e[h]<<24+e[h+1]<<16+e[h+2]<<8;y=y*g+b*(1-g)}e[h]=(y&16711680)>>16;e[h+1]=(y&65280)>>8;e[h+2]=y&255;e[h+3]=c.opacity*255}}function W(e){var t=e.target;t.removeEventListener("update",W);delete i[t.id]}function K(e){var t=e.id;var r=i[t];if(i[t]===undefined){e.addEventListener("update",W);if(e instanceof THREE.MeshBasicMaterial||e instanceof THREE.MeshLambertMaterial||e instanceof THREE.MeshPhongMaterial||e instanceof THREE.SpriteMaterial){if(e instanceof THREE.MeshLambertMaterial){if(!e.palette){e.palette=q(e,false)}}else if(e instanceof THREE.MeshPhongMaterial){if(!e.palette){e.palette=q(e,true)}}var n;if(e.map){var s=new THREE.SoftwareRenderer.Texture;s.fromImage(e.map.image);e.map.addEventListener("update",function(e){s.fromImage(e.target.image)});a[e.map.id]=s;if(e instanceof THREE.MeshBasicMaterial||e instanceof THREE.SpriteMaterial){r=Y}else{r=X}}else{if(e.vertexColors===THREE.FaceColors){n=["var colorOffset = offset * 4;","buffer[ colorOffset ] = face.color.r * 255;","buffer[ colorOffset + 1 ] = face.color.g * 255;","buffer[ colorOffset + 2 ] = face.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n")}else{n=["var colorOffset = offset * 4;","buffer[ colorOffset ] = material.color.r * 255;","buffer[ colorOffset + 1 ] = material.color.g * 255;","buffer[ colorOffset + 2 ] = material.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n")}r=new Function("buffer, depthBuf, offset, depth, u, v, n, face, material",n)}}else{var n=["var colorOffset = offset * 4;","buffer[ colorOffset ] = u * 255;","buffer[ colorOffset + 1 ] = v * 255;","buffer[ colorOffset + 2 ] = 0;","buffer[ colorOffset + 3 ] = 255;","depthBuf[ offset ] = depth;"].join("\n");r=new Function("buffer, depthBuf, offset, depth, u, v",n)}i[t]=r}return r}function Z(e,t,r,i){var a=Math.max(Math.min(e,r),0);var o=Math.min(Math.max(e,r),n);var l=Math.max(Math.min(t,i),0);var c=Math.min(Math.max(t,i),s);var h=(a+l*n)*4+3;var u=(n-(o-a))*4;for(var d=l;d<c;d++){for(var p=a;p<o;p++){E[h+=4]=0}h+=u}}function J(e,t,r,i,a,l,v,m,y){if(e.z<-1||e.z>1||t.z<-1||t.z>1||r.z<-1||r.z>1)return;var M=e.x*c+d|0;var _=t.x*c+d|0;var j=r.x*c+d|0;var V=e.y*h+p|0;var I=t.y*h+p|0;var L=r.y*h+p|0;var D=e.z*u+f|0;var P=t.z*u+f|0;var B=r.z*u+f|0;var z=false;var U,F,G,q,Y,X;if(i&&a&&l){z=true;U=i.x;F=1-i.y;G=a.x;q=1-a.y;Y=l.x;X=1-l.y}var W=false;var K,Z,J,$,ee,te;if(m.vertexNormalsModel){W=true;K=m.vertexNormalsModel[0];Z=m.vertexNormalsModel[1];J=m.vertexNormalsModel[2];$=K.z*255;ee=Z.z*255;te=J.z*255}var re=M-_,ie=I-V;var ae=_-j,ne=L-I;var se=j-M,oe=V-L;var le=Math.max(Math.min(M,_,j)+k>>R,0);var ce=Math.min(Math.max(M,_,j)+k>>R,n);var he=Math.max(Math.min(V,I,L)+k>>R,0);var ue=Math.min(Math.max(V,I,L)+k>>R,s);N=Math.min(le,N);O=Math.max(ce,O);C=Math.min(he,C);A=Math.max(ue,A);var de=S;le&=~(de-1);he&=~(de-1);var pe=le<<R;var fe=he<<R;var ve=ie*(pe-M)+re*(fe-V);var me=ne*(pe-_)+ae*(fe-I);var Ee=oe*(pe-j)+se*(fe-L);if(ie>0||ie==0&&re>0)ve++;if(ne>0||ne==0&&ae>0)me++;if(oe>0||oe==0&&se>0)Ee++;ve=ve-1>>R;me=me-1>>R;Ee=Ee-1>>R;var ge=D-P,ye=B-D;var be=1/(re*oe-se*ie);var Te=be*(ge*oe-ye*ie);var we=be*(ge*se-re*ye);var xe=D+(pe-M)*Te+(fe-V)*we|0;var Re=1<<R;Te=Te*Re|0;we=we*Re|0;var ke,He,Se,Me;if(z){var Ne=U-G,Ce=Y-U;var Oe=be*(Ne*oe-Ce*ie);var Ae=be*(Ne*se-re*Ce);var _e=F-q,je=X-F;ke=be*(_e*oe-je*ie);He=be*(_e*se-re*je);Se=U+(pe-M)*Oe+(fe-V)*Ae;Me=F+(pe-M)*ke+(fe-V)*He;Oe=Oe*Re;Ae=Ae*Re;ke=ke*Re;He=He*Re}var Ve,Ie,Le;if(W){var De=$-ee,Pe=te-$;var Be=be*(De*oe-Pe*ie);var Ie=be*(De*se-re*Pe);Le=$+(pe-M)*Be+(fe-V)*Ie;Be=Be*Re;Ie=Ie*Re}var ze=de-1;var Ue=0,Fe=0;var Ge=0,qe=0;var Ye=0,Xe=0;var We=0,Ke=0;if(re>=0)Fe-=ze*re;else Ue-=ze*re;if(ie>=0)Fe-=ze*ie;else Ue-=ze*ie;if(ae>=0)qe-=ze*ae;else Ge-=ze*ae;if(ne>=0)qe-=ze*ne;else Ge-=ze*ne;if(se>=0)Xe-=ze*se;else Ye-=ze*se;if(oe>=0)Xe-=ze*oe;else Ye-=ze*oe;if(Te>=0)Ke+=ze*Te;else We+=ze*Te;if(we>=0)Ke+=ze*we;else We+=ze*we;var Ze=n-de;var Je=1/(ve+me+Ee);var Qe=ve;var $e=me;var et=Ee;var tt=xe;var rt=-de;var it=rt*ie;var at=rt*ne;var nt=rt*oe;var st=rt*Te;var ot,lt;if(z){ot=rt*Oe;lt=rt*ke}var ct;if(W){ct=rt*Be}var ht=le;for(var ut=he;ut<ue;ut+=de){while(ht>=le&&ht<ce&&Qe>=Fe&&$e>=qe&&et>=Xe){ht+=rt;Qe+=it;$e+=at;et+=nt;tt+=st;if(z){Se+=ot;Me+=lt}if(W){Le+=ct}}rt=-rt;it=-it;at=-at;nt=-nt;st=-st;if(z){ot=-ot;lt=-lt}if(W){ct=-ct}while(1){ht+=rt;Qe+=it;$e+=at;et+=nt;tt+=st;if(z){Se+=ot;Me+=lt}if(W){Le+=ct}if(ht<le||ht>=ce)break;if(Qe<Fe)if(it<0)break;else continue;if($e<qe)if(at<0)break;else continue;if(et<Xe)if(nt<0)break;else continue;var dt=ht>>H;var pt=ut>>H;var ft=dt+pt*o;var vt=tt+We;if(b[ft]<vt)continue;var mt=T[ft];if(mt&x)Q(dt,pt);T[ft]=mt&~(w|x);var Et=ht+ut*n;if(Qe>=Ue&&$e>=Ge&&et>=Ye){var gt=tt+Ke;b[ft]=Math.min(b[ft],gt);var yt=Qe;var bt=$e;var Tt=tt;var wt,xt;if(z){wt=Se;xt=Me}var Rt;if(W){Rt=Le}for(var kt=0;kt<de;kt++){var Ht=yt;var St=bt;var Mt=Tt;var Nt;var Ct;if(z){Nt=wt;Ct=xt}var Ot;if(W){Ot=Rt}for(var At=0;At<de;At++){var _t=Mt;if(_t<g[Et]){v(E,g,Et,_t,Nt,Ct,Ot,m,y)}Ht+=ie;St+=ne;Mt+=Te;if(z){Nt+=Oe;Ct+=ke}if(W){Ot+=Be}Et++}yt+=re;bt+=ae;Tt+=we;if(z){wt+=Ae;xt+=He}if(W){Rt+=Ie}Et+=Ze}}else{var yt=Qe;var bt=$e;var jt=et;var Tt=tt;var wt,xt;if(z){wt=Se;xt=Me}var Rt;if(W){Rt=Le}for(var kt=0;kt<de;kt++){var Ht=yt;var St=bt;var Vt=jt;var Mt=Tt;var Nt;var Ct;if(z){Nt=wt;Ct=xt}var Ot;if(W){Ot=Rt}for(var At=0;At<de;At++){if((Ht|St|Vt)>=0){var _t=Mt;if(_t<g[Et]){v(E,g,Et,_t,Nt,Ct,Ot,m,y)}}Ht+=ie;St+=ne;Vt+=oe;Mt+=Te;if(z){Nt+=Oe;Ct+=ke}if(W){Ot+=Be}Et++}yt+=re;bt+=ae;jt+=se;Tt+=we;if(z){wt+=Ae;xt+=He}if(W){Rt+=Ie}Et+=Ze}}}Qe+=de*re;$e+=de*ae;et+=de*se;tt+=de*we;if(z){Se+=de*Ae;Me+=de*He}if(W){Le+=de*Ie}}}function Q(e,t){var r=e*S+t*S*n;var i=r*4;var a=n-S;var s=a*4;for(var o=0;o<S;o++){for(var l=0;l<S;l++){g[r++]=M;E[i++]=v.r*255|0;E[i++]=v.g*255|0;E[i++]=v.b*255|0;E[i++]=255}r+=a;i+=s}}function $(){var e=0;for(var t=0;t<l;t++){for(var r=0;r<o;r++){if(T[e]&x){Q(r,t);T[e]=w}e++}}}};THREE.SoftwareRenderer.Texture=function(){var e;this.fromImage=function(t){if(!t||t.width<=0||t.height<=0)return;if(e===undefined){e=document.createElement("canvas")}var r=t.width>t.height?t.width:t.height;r=THREE.Math.nextPowerOfTwo(r);if(e.width!=r||e.height!=r){e.width=r;e.height=r}var i=e.getContext("2d");i.clearRect(0,0,r,r);i.drawImage(t,0,0,r,r);var a=i.getImageData(0,0,r,r);this.data=a.data;this.width=r;this.height=r;this.srcUrl=t.src}};THREE.RenderableObject=function(){this.id=0;this.object=null;this.z=0};THREE.RenderableFace=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.v3=new THREE.RenderableVertex;this.normalModel=new THREE.Vector3;this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.vertexNormalsLength=0;this.color=new THREE.Color;this.material=null;this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2];this.z=0};THREE.RenderableVertex=function(){this.position=new THREE.Vector3;this.positionWorld=new THREE.Vector3;this.positionScreen=new THREE.Vector4;this.visible=true};THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld);this.positionScreen.copy(e.positionScreen)};THREE.RenderableLine=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.vertexColors=[new THREE.Color,new THREE.Color];this.material=null;this.z=0};THREE.RenderableSprite=function(){this.id=0;this.object=null;this.x=0;this.y=0;this.z=0;this.rotation=0;this.scale=new THREE.Vector2;this.material=null};THREE.Projector=function(){var e,t,r=[],i=0,a,n,s=[],o=0,l,c,h=[],u=0,d,p,f=[],v=0,m,E,g=[],y=0,b={objects:[],lights:[],elements:[]},T=new THREE.Vector3,w=new THREE.Vector4,x=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),R=new THREE.Box3,k=new Array(3),H=new Array(4),S=new THREE.Matrix4,M=new THREE.Matrix4,N,C=new THREE.Matrix4,O=new THREE.Matrix3,A=new THREE.Frustum,_=new THREE.Vector4,j=new THREE.Vector4;this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project().");e.project(t)};this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject().");e.unproject(t)};this.pickingRay=function(e,t){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var V=function(){var e=[];var t=[];var r=null;var i=null;var n=new THREE.Matrix3;var o=function(a){r=a;i=r.material;n.getNormalMatrix(r.matrixWorld);e.length=0;t.length=0};var c=function(e){var t=e.position;var r=e.positionWorld;var i=e.positionScreen;r.copy(t).applyMatrix4(N);i.copy(r).applyMatrix4(M);var a=1/i.w;i.x*=a;i.y*=a;i.z*=a;e.visible=i.x>=-1&&i.x<=1&&i.y>=-1&&i.y<=1&&i.z>=-1&&i.z<=1};var h=function(e,t,r){a=D();a.position.set(e,t,r);c(a)};var u=function(t,r,i){e.push(t,r,i)};var p=function(e,r){t.push(e,r)};var f=function(e,t,r){if(e.visible===true||t.visible===true||r.visible===true)return true;k[0]=e.positionScreen;k[1]=t.positionScreen;k[2]=r.positionScreen;return x.isIntersectionBox(R.setFromPoints(k))};var v=function(e,t,r){return(r.positionScreen.x-e.positionScreen.x)*(t.positionScreen.y-e.positionScreen.y)-(r.positionScreen.y-e.positionScreen.y)*(t.positionScreen.x-e.positionScreen.x)<0};var m=function(e,t){var i=s[e];var a=s[t];d=B();d.id=r.id;d.v1.copy(i);d.v2.copy(a);d.z=(i.positionScreen.z+a.positionScreen.z)/2;d.material=r.material;b.elements.push(d)};var E=function(a,o,c){var h=s[a];var u=s[o];var d=s[c];if(f(h,u,d)===false)return;if(i.side===THREE.DoubleSide||v(h,u,d)===true){l=P();l.id=r.id;l.v1.copy(h);l.v2.copy(u);l.v3.copy(d);l.z=(h.positionScreen.z+u.positionScreen.z+d.positionScreen.z)/3;for(var p=0;p<3;p++){var m=arguments[p]*3;var E=l.vertexNormalsModel[p];E.set(e[m],e[m+1],e[m+2]);E.applyMatrix3(n).normalize();var g=arguments[p]*2;var y=l.uvs[p];y.set(t[g],t[g+1])}l.vertexNormalsLength=3;l.material=r.material;b.elements.push(l)}};return{setObject:o,projectVertex:c,checkTriangleVisibility:f,checkBackfaceCulling:v,pushVertex:h,pushNormal:u,pushUv:p,pushLine:m,pushTriangle:E}};var I=new V;this.projectScene=function(r,i,a,o){c=0;p=0;E=0;b.elements.length=0;if(r.autoUpdate===true)r.updateMatrixWorld();if(i.parent===undefined)i.updateMatrixWorld();S.copy(i.matrixWorldInverse.getInverse(i.matrixWorld));M.multiplyMatrices(i.projectionMatrix,S);A.setFromMatrix(M);t=0;b.objects.length=0;b.lights.length=0;r.traverseVisible(function(t){if(t instanceof THREE.Light){b.lights.push(t)}else if(t instanceof THREE.Mesh||t instanceof THREE.Line||t instanceof THREE.Sprite){if(t.material.visible===false)return;if(t.frustumCulled===false||A.intersectsObject(t)===true){e=L();e.id=t.id;e.object=t;T.setFromMatrixPosition(t.matrixWorld);T.applyProjection(M);e.z=T.z;b.objects.push(e)}}});if(a===true){b.objects.sort(U)}for(var h=0,u=b.objects.length;h<u;h++){var f=b.objects[h].object;var v=f.geometry;I.setObject(f);N=f.matrixWorld;n=0;if(f instanceof THREE.Mesh){if(v instanceof THREE.BufferGeometry){var g=v.attributes;var y=v.offsets;if(g.position===undefined)continue;var x=g.position.array;for(var R=0,k=x.length;R<k;R+=3){I.pushVertex(x[R],x[R+1],x[R+2])}if(g.normal!==undefined){var H=g.normal.array;for(var R=0,k=H.length;R<k;R+=3){I.pushNormal(H[R],H[R+1],H[R+2])}}if(g.uv!==undefined){var V=g.uv.array;for(var R=0,k=V.length;R<k;R+=2){I.pushUv(V[R],V[R+1])}}if(g.index!==undefined){var G=g.index.array;if(y.length>0){for(var h=0;h<y.length;h++){var q=y[h];var Y=q.index;for(var R=q.start,k=q.start+q.count;R<k;R+=3){I.pushTriangle(G[R]+Y,G[R+1]+Y,G[R+2]+Y)}}}else{for(var R=0,k=G.length;R<k;R+=3){I.pushTriangle(G[R],G[R+1],G[R+2])}}}else{for(var R=0,k=x.length/3;R<k;R+=3){I.pushTriangle(R,R+1,R+2)}}}else if(v instanceof THREE.Geometry){var X=v.vertices;var W=v.faces;var K=v.faceVertexUvs[0];O.getNormalMatrix(N);var Z=f.material;var J=Z instanceof THREE.MeshFaceMaterial;var Q=J===true?f.material:null;for(var $=0,ee=X.length;$<ee;$++){var te=X[$];T.copy(te);if(Z.morphTargets===true){var re=v.morphTargets;var ie=f.morphTargetInfluences;for(var ae=0,ne=re.length;ae<ne;ae++){var se=ie[ae];if(se===0)continue;var oe=re[ae];var le=oe.vertices[$];T.x+=(le.x-te.x)*se;T.y+=(le.y-te.y)*se;T.z+=(le.z-te.z)*se}}I.pushVertex(T.x,T.y,T.z)}for(var ce=0,he=W.length;ce<he;ce++){var ue=W[ce];var Z=J===true?Q.materials[ue.materialIndex]:f.material;if(Z===undefined)continue;var de=Z.side;var pe=s[ue.a];var fe=s[ue.b];var ve=s[ue.c];if(I.checkTriangleVisibility(pe,fe,ve)===false)continue;var me=I.checkBackfaceCulling(pe,fe,ve);if(de!==THREE.DoubleSide){if(de===THREE.FrontSide&&me===false)continue;if(de===THREE.BackSide&&me===true)continue}l=P();l.id=f.id;l.v1.copy(pe);l.v2.copy(fe);l.v3.copy(ve);l.normalModel.copy(ue.normal);if(me===false&&(de===THREE.BackSide||de===THREE.DoubleSide)){l.normalModel.negate()}l.normalModel.applyMatrix3(O).normalize();var Ee=ue.vertexNormals;for(var ge=0,ye=Math.min(Ee.length,3);ge<ye;ge++){var be=l.vertexNormalsModel[ge];be.copy(Ee[ge]);if(me===false&&(de===THREE.BackSide||de===THREE.DoubleSide)){be.negate()}be.applyMatrix3(O).normalize()}l.vertexNormalsLength=Ee.length;var Te=K[ce];if(Te!==undefined){for(var we=0;we<3;we++){l.uvs[we].copy(Te[we])}}l.color=ue.color;l.material=Z;l.z=(pe.positionScreen.z+fe.positionScreen.z+ve.positionScreen.z)/3;b.elements.push(l)}}}else if(f instanceof THREE.Line){if(v instanceof THREE.BufferGeometry){var g=v.attributes;if(g.position!==undefined){var x=g.position.array;for(var R=0,k=x.length;R<k;R+=3){I.pushVertex(x[R],x[R+1],x[R+2])}if(g.index!==undefined){var G=g.index.array;for(var R=0,k=G.length;R<k;R+=2){I.pushLine(G[R],G[R+1])}}else{var xe=f.mode===THREE.LinePieces?2:1;for(var R=0,k=x.length/3-1;R<k;R+=xe){I.pushLine(R,R+1)}}}}else if(v instanceof THREE.Geometry){C.multiplyMatrices(M,N);var X=f.geometry.vertices;if(X.length===0)continue;pe=D();pe.positionScreen.copy(X[0]).applyMatrix4(C);var xe=f.mode===THREE.LinePieces?2:1;for(var $=1,ee=X.length;$<ee;$++){pe=D();pe.positionScreen.copy(X[$]).applyMatrix4(C);if(($+1)%xe>0)continue;fe=s[n-2];_.copy(pe.positionScreen);j.copy(fe.positionScreen);if(F(_,j)===true){_.multiplyScalar(1/_.w);j.multiplyScalar(1/j.w);d=B();d.id=f.id;d.v1.positionScreen.copy(_);d.v2.positionScreen.copy(j);d.z=Math.max(_.z,j.z);d.material=f.material;if(f.material.vertexColors===THREE.VertexColors){d.vertexColors[0].copy(f.geometry.colors[$]);d.vertexColors[1].copy(f.geometry.colors[$-1])}b.elements.push(d)}}}}else if(f instanceof THREE.Sprite){w.set(N.elements[12],N.elements[13],N.elements[14],1);w.applyMatrix4(M);var Re=1/w.w;w.z*=Re;if(w.z>=-1&&w.z<=1){m=z();m.id=f.id;m.x=w.x*Re;m.y=w.y*Re;m.z=w.z;m.object=f;m.rotation=f.rotation;m.scale.x=f.scale.x*Math.abs(m.x-(w.x+i.projectionMatrix.elements[0])/(w.w+i.projectionMatrix.elements[12]));m.scale.y=f.scale.y*Math.abs(m.y-(w.y+i.projectionMatrix.elements[5])/(w.w+i.projectionMatrix.elements[13]));m.material=f.material;b.elements.push(m)}}}if(o===true){b.elements.sort(U)}return b};function L(){if(t===i){var e=new THREE.RenderableObject;r.push(e);i++;t++;return e}return r[t++]}function D(){if(n===o){var e=new THREE.RenderableVertex;s.push(e);o++;n++;return e}return s[n++]}function P(){if(c===u){var e=new THREE.RenderableFace;h.push(e);u++;c++;return e}return h[c++]}function B(){if(p===v){var e=new THREE.RenderableLine;f.push(e);v++;p++;return e}return f[p++]}function z(){if(E===y){var e=new THREE.RenderableSprite;g.push(e);y++;E++;return e}return g[E++]}function U(e,t){if(e.z!==t.z){return t.z-e.z}else if(e.id!==t.id){return e.id-t.id}else{return 0}}function F(e,t){var r=0,i=1,a=e.z+e.w,n=t.z+t.w,s=-e.z+e.w,o=-t.z+t.w;if(a>=0&&n>=0&&s>=0&&o>=0){return true}else if(a<0&&n<0||s<0&&o<0){return false}else{if(a<0){r=Math.max(r,a/(a-n))}else if(n<0){i=Math.min(i,a/(a-n))}if(s<0){r=Math.max(r,s/(s-o))}else if(o<0){i=Math.min(i,s/(s-o))}if(i<r){return false}else{e.lerp(t,r);t.lerp(e,1-i);return true}}}};var Sequencer=function(e){this.renderer=null;this.debug_=!!e;this.updateState_=this.STATES_.DONE;this.renderingState_=this.STATES_.DONE;Utils.makeAvailableForDebug("Sequencer",this)};Sequencer.prototype.STATES_={CONTINUOUS:"continuous",DONE:"done",ONCE:"once"};Sequencer.prototype.start=function(){this.raf_()};Sequencer.prototype.stop=function(){cancelAnimationFrame(this.rafId_)};Sequencer.prototype.raf_=function(){this.rafId_=requestAnimationFrame(this.raf_.bind(this));this.log("raf");if(this.updateState_!=this.STATES_.DONE){this.renderer.update();if(this.updateState_==this.STATES_.ONCE){this.updateState_=this.STATES_.DONE}}if(this.renderingState_!=this.STATES_.DONE){this.renderer.draw();if(this.renderingState_==this.STATES_.ONCE){this.renderingState_=this.STATES_.DONE}}};Sequencer.prototype.requestSingleRender=function(){this.log("requestSingleRender");this.renderingState_=this.STATES_.ONCE};Sequencer.prototype.requestContinuousRendering=function(){this.log("requestContinuousRendering");this.renderingState_=this.STATES_.CONTINUOUS};Sequencer.prototype.requestStopRendering=function(){this.log("requestStopRendering");this.renderingState_=this.STATES_.DONE};Sequencer.prototype.requestSingleUpdate=function(){this.log("requestSingleUpdate");this.updateState_=this.UPDATING_STATES_.ONCE};Sequencer.prototype.requestContinuousUpdating=function(){this.log("requestContinuousUpdating");this.updateState_=this.UPDATING_STATES_.CONTINUOUS};Sequencer.prototype.requestContinuousUpdating=function(){this.log("requestContinuousUpdating");this.updateState_=this.UPDATING_STATES_.DONE};Sequencer.prototype.log=function(){if(!this.debug_){return}var e=Array.prototype.slice.call(arguments);e.unshift("Sequencer log -");console.log.apply(console,e)};var Renderer3d=function(e,t,r,i,a,n,s){this.sequencer=e;this.kicker=t;this.data=this.kicker.model.data;this.canvasEl=r;this.canvas2dEl=n;this.blueprintBorderRenderer=new BlueprintBorderRenderer(n);this.mergedCanvasEl=s;this.mergedRenderer=new MergedRenderer(r,n,s);this.imageList=i;this.config=a;this.parts=null;this.rafId=null;this.drawCounter=0;this.models={board:new THREE.Object3D};Utils.makeAvailableForDebug("renderer3d",this)};Renderer3d.prototype.onStateChange=function(e){switch(e){case EditorState.NEW:this.init();break}};Renderer3d.prototype.init=function(){this.scene=EditorScene.getScene();Utils.makeAvailableForDebug("scene",this.scene);this.createKicker();this.createCameras();this.threeRenderer=EditorScene.getRenderer(this.canvasEl);this.setVisibleObjects();this.resize();this.sequencer.start()};Renderer3d.prototype.replaceModel=function(e,t){this.models[e]=t;this.refresh()};Renderer3d.prototype.getModel=function(e){if(!e in this.models){throw new Error("No model exists with name",e)}return this.models[e]};Renderer3d.prototype.renderOnce=function(){this.sequencer.requestSingleRender()};Renderer3d.prototype.renderContinuously=function(){this.sequencer.requestContinuousRendering()};Renderer3d.prototype.stopRendering=function(){this.sequencer.requestStopRendering()};Renderer3d.prototype.update=function(){if(this.orbitControls.enabled&&this.orbitControls.autorotate){this.orbitControls.update()}this.draw()};Renderer3d.prototype.draw=function(){this.threeRenderer.render(this.scene,this.camera);this.blueprintBorderRenderer.render()};Renderer3d.prototype.refresh=function(){this.kicker.refresh();this.createKicker();if(this.data.get("repType")=="2d"){this.prepareCameras()}this.setVisibleObjects();this.sequencer.requestSingleRender()};Renderer3d.prototype.createCameras=function(){this.cameras=EditorScene.createCameras(this.canvasEl,this.kickerObj);this.orbitControls=new THREE.OrbitControls(this.cameras.perspective,this.canvasEl);this.orbitControls.zoomSpeed=.3;this.orbitControls.maxDistance=12;this.orbitControls.minDistance=2.5;Utils.makeAvailableForDebug("orbitControls",this.orbitControls);this.orbitControls.addEventListener("start",this.onOrbitStart.bind(this));this.orbitControls.addEventListener("end",this.onOrbitEnd.bind(this))};Renderer3d.prototype.onOrbitStart=function(e){this.renderContinuously()};Renderer3d.prototype.onOrbitEnd=function(e){this.orbitControls.update();this.renderOnce()};Renderer3d.prototype.updateViz=function(e){for(prop in e){if(!e.hasOwnProperty(prop)){continue}this.data.set(prop,e[prop])}this.setVisibleObjects();this.sequencer.requestSingleRender()};Renderer3d.prototype.setVisibleObjects=function(){var e=this.kicker.getRepresentation3d();var t=this.data;Utils.iterateOverParts(e.parts,function(e){e.setMeshVisibilityForDisplay(t)});this.prepareCameras()};Renderer3d.prototype.pickCamera=function(){if(this.data.get("repType")=="2d"){this.camera=this.cameras.ortho;this.orbitControls.enabled=false}else{this.camera=this.cameras.perspective;this.orbitControls.target.copy(this.cameraTarget.position);this.orbitControls.update();this.orbitControls.enabled=true}Utils.makeAvailableForDebug("camera",this.camera)};Renderer3d.prototype.resize=function(){var e=this.canvasEl.parentElement;this.threeRenderer.setSize(e.clientWidth,e.clientHeight,false);this.prepareCameras();this.blueprintBorderRenderer.resize();this.mergedRenderer.resize();this.sequencer.requestSingleRender()};Renderer3d.prototype.prepareCameras=function(){this.createCameras();this.pickCamera()};Renderer3d.prototype.createKicker=function(){if(this.kickerObj){this.scene.remove(this.kickerObj)}this.kickerObj=EditorScene.createKicker(this.kicker,this.config,this.imageList,this);this.cameraTarget=new THREE.AxisHelper(1);this.kickerObj.add(this.cameraTarget);this.cameraTarget.visible=false;this.cameraTarget.position.x=this.kicker.model.length/2;this.scene.add(this.kickerObj)};Renderer3d.prototype.getDataForSaving=function(){return this.data.getDataForSaving()};Renderer3d.prototype.setUnits=function(e){this.config.units=e;this.kicker.getRepresentation3d().setConfig(this.config);this.refresh()};var BlueprintBorderRenderer=function(e){this.canvasEl=e};BlueprintBorderRenderer.prototype.render=function(){if(!this.canvasEl){return}var e=this.canvasEl.getContext("2d");e.strokeStyle="#f8faff";var t=this.canvasEl.parentElement,r=t.clientWidth,i=t.clientHeight;e.strokeRect(0,0,r,i);var a=4,n=4,s=1,o=10;var l=(r-(n-1)-2*s)/n;for(var c=1,h=n;c<h;c++){var u=l*c|0;e.beginPath();e.moveTo(u,0);e.lineTo(u,o);e.stroke();e.beginPath();e.moveTo(u,i);e.lineTo(u,i-o);e.stroke()}var d=(i-(a-1)-2*s)/a;for(var c=1,h=a;c<h;c++){var p=d*c|0;e.beginPath();e.moveTo(0,p);e.lineTo(o,p);e.stroke();e.beginPath();e.moveTo(r,p);e.lineTo(r-o,p);e.stroke()}};BlueprintBorderRenderer.prototype.resize=function(){var e=this.canvasEl.parentElement;this.canvasEl.width=e.clientWidth;this.canvasEl.height=e.clientHeight};var MergedRenderer=function(e,t,r){this.canvas3dEl=e;this.canvas2dEl=t;this.mergedCanvasEl=r};MergedRenderer.prototype.resize=function(){var e=this.mergedCanvasEl.parentElement;this.mergedCanvasEl.width=e.clientWidth;this.mergedCanvasEl.height=e.clientHeight};MergedRenderer.prototype.getData=function(e){var t=this.mergedCanvasEl.getContext("2d");t.clearRect(0,0,this.mergedCanvasEl.width,this.mergedCanvasEl.height);if(e.fill){t.fillStyle="#3B69D5";t.fillRect(0,0,this.mergedCanvasEl.width,this.mergedCanvasEl.height)}t.drawImage(this.canvas3dEl,10,10);if(e.borders){t.drawImage(this.canvas2dEl,10,10)}return this.mergedCanvasEl.toDataURL()};