<link rel="import" href="../bower_components/polymer/polymer.html">

<script src="../bower_components/threejs/build/three.js"></script>
<script src="../scripts/helvetiker_regular.typeface.js"></script>
<script src="../scripts/config.js"></script>
<script src="../scripts/imagelist.js"></script>
<script src="../scripts/utils.js"></script>
<script src="../scripts/kickereditorview.js"></script>
<script src="../scripts/kickermodel.js"></script>
<script src="../scripts/kicker.js"></script>
<script src="../scripts/ColladaLoader.js"></script> 
<script src="../scripts/THREEx.GeometryUtils.js"></script> 
<script src="../scripts/representation3d.js"></script>
<script src="../scripts/scene.js"></script>
<script src="../scripts/orbitcontrols.js"></script>

<script src="../models/parts/part.js"></script>
<script src="../models/parts/board.js"></script>
<script src="../models/parts/side.js"></script>
<script src="../models/parts/part.js"></script>
<script src="../models/parts/slat.js"></script>
<script src="../models/parts/strut.js"></script>
<script src="../models/parts/surface.js"></script>
<script src="../models/parts/text.js"></script>

<script src="../scripts/renderer3d.js"></script>
<script src="../scripts/blueprintborderrenderer.js"></script>

<dom-module id="bihi-renderer3d">
  <style>
    :host {
      margin-left: 20px;
      flex-grow: 1;
      position: relative;   
    }
    .canvas-container {
      position: absolute;
      box-sizing: border-box;
      top: 10px;
      left: 10px;
      right: 10px;
      bottom: 10px;
    }
    canvas {
      position: absolute;
      /* Dimensions are set in JS. */
    }
    #canvas3d {
      z-index: 1;
    }
    #canvas3d-container {
      /* To account for the 1px border inside the 2d canvas. */
      margin: 1px; 
    }
  </style>

  <template>
    <div class="canvas-container" id="canvas3d-container">
      <canvas id="canvas3d"></canvas>
    </div>
    <div class="canvas-container">
      <canvas id="canvas2d"></canvas>
    </div>
  </template>

</dom-module>

<script>
  Polymer({
    is: "bihi-renderer3d",
    listeners: {
      "renderer-init": "init",
      "renderer-refresh": "refresh",
      "renderer-update-viz": "updateViz"
    },
    properties: {
      initialized: {
        type: Boolean,
        reflectToAttribute: true
      },
      renderer: {type: Object},
      blueprintBorderRenderer: {type: Object}
    },
    init: function() {
      if (this.initialized) {
        return;
      }
      var editorEl = document.querySelector('bihi-editor'),
          canvas3dEl = Polymer.dom(this).node.querySelector('#canvas3d'),
          canvas2dEl = Polymer.dom(this).node.querySelector('#canvas2d'),
          view = new KickerEditorView(editorEl),
          model = new KickerModel(view),
          kicker = new Kicker(model),
          imageList = new ImageList();
      this.renderer = new Renderer3d(kicker, canvas3dEl, imageList, config, canvas2dEl);
      this.initialized = true;

      var resizeTimeoutHandle = null;

      var onResize = (function() {
        if (resizeTimeoutHandle) {
          clearTimeout(resizeTimeoutHandle);
        }
        resizeTimeoutHandle = setTimeout((function() {
          this.renderer.resize();
        }).bind(this), 200);
      }).bind(this);
      window.addEventListener('resize', onResize);
    },
    refresh: function() {
      this.renderer.refresh();
    },
    resize: function() {
      this.renderer.resize();
    },
    updateViz: function(e) {
      this.renderer.updateViz(e.detail);
    }
  });

</script>