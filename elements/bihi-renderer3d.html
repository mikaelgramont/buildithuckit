<link rel="import" href="../bower_components/polymer/polymer.html">

<script src="../bower_components/threejs/build/three.js"></script>
<script src="../fonts/archer_medium_regular.typeface.js"></script>
<script src="../scripts/config.js"></script>
<script src="../scripts/imagelist.js"></script>
<script src="../scripts/utils.js"></script>
<script src="../scripts/kickerio.js"></script>
<script src="../scripts/kickeriofromdom.js"></script>
<script src="../scripts/kickeriofromjson.js"></script>
<script src="../scripts/kickermodel.js"></script>
<script src="../scripts/kicker.js"></script>
<script src="../scripts/ColladaLoader.js"></script> 
<script src="../scripts/THREEx.GeometryUtils.js"></script> 
<script src="../scripts/representation3d.js"></script>
<script src="../scripts/scene.js"></script>
<script src="../scripts/orbitcontrols.js"></script>

<script src="../models/parts/part.js"></script>
<script src="../models/parts/annotation.js"></script>
<script src="../models/parts/arrow.js"></script>
<script src="../models/parts/board.js"></script>
<script src="../models/parts/curvedarrow.js"></script>
<script src="../models/parts/side.js"></script>
<script src="../models/parts/slat.js"></script>
<script src="../models/parts/strut.js"></script>
<script src="../models/parts/surface.js"></script>
<script src="../models/parts/text.js"></script>

<script src="../scripts/sequencer.js"></script>
<script src="../scripts/renderer3d.js"></script>
<script src="../scripts/blueprintborderrenderer.js"></script>

<dom-module id="bihi-renderer3d">
  <style>
    :host {
      margin-left: 20px;
      flex-grow: 1;
      position: relative;   
    }
    .canvas-container {
      position: absolute;
      box-sizing: border-box;
      top: 10px;
      left: 10px;
      right: 10px;
      bottom: 10px;
    }
    canvas {
      position: absolute;
      /* Dimensions are set in JS. */
    }
    #canvas3d {
      z-index: 1;
    }
    #canvas3d-container {
      /* To account for the 1px border inside the 2d canvas. */
      margin: 1px; 
    }
  </style>

  <template>
    <div class="canvas-container" id="canvas3d-container">
      <canvas id="canvas3d"></canvas>
    </div>
    <div class="canvas-container">
      <canvas id="canvas2d"></canvas>
    </div>
  </template>

</dom-module>

<script>
  Polymer({
    is: "bihi-renderer3d",
    listeners: {
      "renderer-init": "init",
      "renderer-refresh": "refresh",
      "renderer-update-viz": "updateViz",
      "renderer-redraw": "renderOnce"
    },
    properties: {
      initialized: {
        type: Boolean,
        reflectToAttribute: true
      },
      renderer: {type: Object},
      blueprintBorderRenderer: {type: Object}
    },
    init: function(e) {
      if (this.initialized) {
        console.log('bihi-renderer3d already initialized');
        return;
      }
      var sequencer = new Sequencer(false),
          canvas3dEl = Polymer.dom(this).node.querySelector('#canvas3d'),
          canvas2dEl = Polymer.dom(this).node.querySelector('#canvas2d'),
          kickerIOFromDOM = new KickerIOFromDOM(
            document.querySelector('bihi-params'),
            document.querySelector('bihi-results'),
            document.querySelector('bihi-representation'),
            document.querySelector('bihi-context'),
            e.detail
          ),
          // kickerIOFromJSON = new KickerIOFromJSON(initialValues),
          model = new KickerModel(kickerIOFromDOM),
          kicker = new Kicker(model),
          imageList = new ImageList();
      this.renderer = new Renderer3d(sequencer, kicker, canvas3dEl, imageList, config, canvas2dEl);
      sequencer.renderer = this.renderer;
      var start = this.start.bind(this);
      setTimeout(function(){
        // Some kind of race condition is causing the canvas element to not
        // be sized correctly unless we push this to the next tick. Sigh.
        start();
      }, 0);

      var resizeTimeoutHandle = null;

      var onResize = (function() {
        if (resizeTimeoutHandle) {
          clearTimeout(resizeTimeoutHandle);
        }
        resizeTimeoutHandle = setTimeout((function() {
          this.renderer.resize();
        }).bind(this), 200);
      }).bind(this);
      window.addEventListener('resize', onResize);
    },
    start: function() {
      this.renderer.init();
      this.initialized = true;
    },
    renderOnce: function() {
      this.renderer.renderOnce();
    },
    refresh: function() {
      this.renderer.refresh();
    },
    resize: function() {
      this.renderer.resize();
    },
    updateViz: function(e) {
      this.renderer.updateViz(e.detail);
    }
  });

</script>