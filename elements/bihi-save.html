<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="bihi-save">
  <style>
    label {
      display: block;
      margin: 10px 0;
    }
    input,
    textarea {
      width: 100%;
    }
    textarea {
      height: 4.5em;
    }
    .button-container {
      margin: 10px 0;
      text-align: right;
    }
  </style>

  <template>
    <div class="container size-2">
      <label for="title">Title</label>
      <input id="title" value="{{title}}">
      <label for="description">Description</label>
      <textarea id="description">{{description}}</textarea>
       <div class="button-container">
        <button id="saveButton" on-click="onSaveButtonClick">Save</button>
      </div>
    </div>
  </template>

</dom-module>

<script>
(function() {
  function post(url, data) {
    var formData = new FormData();
    for (var k in data) {
      formData.append(k, data[k]);
    }
    console.log("formData", formData);

    // Return a new promise.
    return new Promise(function(resolve, reject) {
      // Do the usual XHR stuff
      var req = new XMLHttpRequest();
      req.open('POST', url);

      req.onload = function() {
        // This is called even on 404 etc
        // so check the status
        if (req.status == 200) {
          // Resolve the promise with the response text
          resolve(req.response);
        }
        else {
          // Otherwise reject with the status text
          // which will hopefully be a meaningful error
          reject(Error(req.statusText));
        }
      };

      // Handle network errors
      req.onerror = function() {
        reject(Error("Network Error"));
      };

      // Make the request
      req.send(formData);
    });
  }


  Polymer({
    is: "bihi-save",
    listeners: {
      "on-save": "onSave"
    },
    onSave: function(e) {
      this.$.saveButton.disabled = true;
      this.$.description.disabled = true;
      this.$.title.disabled = true;
    },
    onSaveButtonClick: function(e) {
      // TODO: load up all relevant information into the options object
      var options = {
        description: "some description",
        title: "some title"
      };

      post('./save.php', options).then(function(response) {
        return JSON.parse(response);
      }).then(function(json) {
        console.log("Yey JSON!", json);
      });

      var event = new CustomEvent('renderer-event', {
        detail: {
          type: 'save',
          options: options
        }
      });
      document.body.dispatchEvent(event);            
    },
     properties: {
      id: {
        type: Number,
        reflectToAttribute: true
      }
    }
 
  });
})();
</script>