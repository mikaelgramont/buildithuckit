<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="bihi-editor">
  <style>
    :host {
      display: flex;
      width: 100%;
    };
  </style>

  <template>
    <content></content>
  </template>

</dom-module>

<script>
  Polymer({
    is: "bihi-editor",
    listeners: {
      "parameter-change": "rendererRefresh",
      "units-change": "updateUnits",
      "viz-change": "updateViz",
      "editor-react-to-state-change": "onStateChange",
      "editor-apply-state-change": "applyStateChange"
    },
    ready: function() {
      this.state = new EditorState();
    },
    reset: function() {
      /* TODO: make sure the markup is set correctly here:
        - empty description
        - reset the accordion
        - 
       */
      this.state.setState(EditorState.NEW);
    },
    init: function(initValues, units) {
      var rendererEl = Polymer.dom(this).node.querySelector("bihi-renderer3d");
      rendererEl.init(initValues, units);
      if (initValues.id) {
        this.state.setState(EditorState.READ_ONLY);
      } else {
        this.state.setState(EditorState.READY);
      }
    },
    rendererRefresh: function() {
      var rendererEl = Polymer.dom(this).node.querySelector("bihi-renderer3d");
      this.fire("refresh", {}, rendererEl, false);
    },
    applyStateChange: function(e) {
      console.log("applyStateChange", e.detail.state);
      this.state.setState(e.detail.state, e.detail.data);
    },
    onStateChange: function (e) {
      var rendererEl = Polymer.dom(this).node.querySelector("bihi-renderer3d");
      this.fire("state-change", {state: e.detail.state}, rendererEl, false);

      var saveEl = document.getElementById('save-step');
      var shareEl = document.getElementById('share-step');

      var titleEl = document.getElementById('share-title');
      var descEl = document.getElementById('share-title');

      var accordionEl = document.getElementsByClassName('renderer-accordion')[0];

      if (e.detail.state == EditorState.READ_ONLY &&
          e.detail.previousState != EditorState.READ_ONLY) {
        // The user loaded an existing kicker.
        // Do nothing for now.
      }

      if (e.detail.state == EditorState.READY &&
          e.detail.previousState == EditorState.READ_ONLY) {
        // The user is duplicating a kicker
        console.log("duplicating");
        history.replaceState({}, defaultTitle, window.location.href.split('?')[0]);     

        titleEl.innerText = defaultTitle;
        descEl.innerText = defaultDescription;

        saveEl.classList.remove('hidden');
        shareEl.classList.add('hidden');
        accordionEl.updateFirstLast();
      }

      if (e.detail.state == EditorState.SAVED) {
        // The user just saved a new kicker.

        // Update url. There's a possibility of a self-XSS attack with title and description here. Whatever.
        var data = e.detail.data;
        history.replaceState({}, data.title, window.location.href + '?id=' + data.id);

        titleEl.innerText = data.title;
        descEl.innerText = data.description;

        // Hide save tab, show share tab.
        accordionEl.goToStep(3);
        saveEl.classList.add('hidden');
        shareEl.classList.remove('hidden');
        accordionEl.updateFirstLast();
      }
      },
    updateViz: function(e) {
      var rendererEl = Polymer.dom(this).node.querySelector("bihi-renderer3d");
      this.fire("update-viz", e.detail, rendererEl, false);
    },
    updateUnits: function(e) {
      this.fire("update-units", e.detail, rendererEl, false);
    },
    properties: {
      state: {
        type: Object
      }
    }
  });
</script>
