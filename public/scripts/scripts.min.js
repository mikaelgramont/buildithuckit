var config={model3d:{sides:{steps:30,thickness:.03,extraLength:.1,minHeight:.015},slats:{defaultLength:.015,thickness:.015,space:.01},struts:{side:.08,smallSide:.04,maximumDistance:.3},surface:{thickness:.015}},units:null,UNIT_METERS:"m",UNIT_FEET:"ft",UNIT_DEGREES:"Â°"},EditorState=function(e){this.state_=e?EditorState.READ_ONLY:void 0};EditorState.prototype.setState=function(e,t){t=t||{};var i=[];if(this.state_==EditorState.NEW?i=[EditorState.NEW,EditorState.READY]:this.state_==EditorState.READY?i=[EditorState.NEW,EditorState.SAVED]:this.state_==EditorState.SAVED?i=[EditorState.NEW,EditorState.READY,EditorState.READ_ONLY]:this.state_==EditorState.READ_ONLY&&(i=[EditorState.NEW,EditorState.READY]),-1===i.indexOf(e)&&this.state_)throw new Error('Transition to state from state "'+this.state_+'" to "'+e+'" not allowed.');this.setState_(e,t)},EditorState.prototype.setState_=function(e,t){var i=this.state_;this.state_=e;var r=new CustomEvent("published-state-change",{detail:{state:e,previousState:i,data:t}});document.body.dispatchEvent(r)},EditorState.prototype.getState=function(){return this.state_},EditorState.NEW="new",EditorState.READY="ready",EditorState.SAVED="saved",EditorState.READ_ONLY="read-only";var ImageList=function(){this.images={side:BIHI.lazyLoadingFiles.wood1,slat:BIHI.lazyLoadingFiles.wood2,strut:BIHI.lazyLoadingFiles.wood3}};ImageList.prototype.getImageUrl=function(e){return this.images[e]};var Utils={};Utils.setupUVMapping=function(e,t,r){"undefined"==typeof t&&(t="x"),"undefined"==typeof r&&(r="y");var n=-(1/0),a=1/0,o=-(1/0),s=1/0,c=0,h=0;for(i=0,l=e.vertices.length;i<l;i++)n<e.vertices[i][t]&&(n=e.vertices[i][t]),o<e.vertices[i][r]&&(o=e.vertices[i][r]),a>e.vertices[i][t]&&(a=e.vertices[i][t]),s>e.vertices[i][r]&&(s=e.vertices[i][r]);for(c=n-a,h=o-s,e.faceVertexUvs=[[]],i=0,l=e.faces.length;i<l;i++){var d=e.faces[i],p=[e.vertices[d.a],e.vertices[d.b],e.vertices[d.c]],u=p.map(function(e){return new THREE.Vector2((e[t]+c/2)/(2*c),e[r]/h)});e.faceVertexUvs[0].push(u)}},Utils.iterateOverParts=function(e,t){for(var i in e)e.hasOwnProperty(i)&&(Array.isArray(e[i])?e[i].forEach(function(e){t(e)}):t(e[i],i))},Utils.makeAvailableForDebug=function(e,t){window.debugInfo=window.debugInfo||{},window.debugInfo[e]=t},Utils.createBoxBodyFromMesh=function(e,t){var i=new THREE.BoundingBoxHelper(e,0);i.update();var r=Math.abs((i.box.max.x-i.box.min.x)/2),n=Math.abs((i.box.max.y-i.box.min.y)/2),a=Math.abs((i.box.max.z-i.box.min.z)/2),o=new CANNON.Box(new CANNON.Vec3(r,n,a)),s=new CANNON.RigidBody(t,o);return s},Utils.metersToDumb=function(e){var t=.3048,i=.0253,r=Math.floor(e/t),n=Math.floor(e%t/i);return r+"ft"+n};var KickerIO=function(){this.params=["height","width","angle"],this.results=["arc","radius","length"],this.rep=["repType","textured"],this.context=["annotations","grid","mountainboard","rider"],this["export"]=["fill","borders"],this.save=["description","title","id"],this.supported=this.params.concat(this.results,this.rep,this.context,this["export"],this.save),this.floatValues=["height","width","angle","arc","radius","length"],this.booleanValues=["annotations","grid","mountainboard","rider","fill","borders","textured"],this.saveValues=this.params.concat(this.save,this.rep,this.context,this.save,this["export"])};KickerIO.prototype.init=function(){throw new Error("KickerIO.init not implemented")},KickerIO.prototype.get=function(e){throw new Error("KickerIO.get not implemented")},KickerIO.prototype.set=function(e,t){throw new Error("KickerIO.set not implemented")},KickerIO.prototype.getDataForSaving=function(){var e={},t=this.get.bind(this);return this.saveValues.forEach(function(i){e[i]=t(i)}),e.id&&delete e.id,e};var KickerIOFromDOM=function(e,t,i,r,n,a,o){KickerIO.call(this),this.paramsEl=e,this.resultsEl=t,this.repEl=i,this.contextEl=r,this.exportEl=n,this.saveEl=a,this.init(o)};KickerIOFromDOM.prototype=new KickerIO,KickerIOFromDOM.prototype.init=function(e){if(e)for(name in e)this.set(name,e[name])},KickerIOFromDOM.prototype.get=function(e){switch(e){case"height":case"width":case"angle":return parseFloat(this.paramsEl[e]);case"repType":return this.repEl[e];case"description":case"title":case"id":return this.saveEl[e];case"textured":return this.repEl[e];case"fill":case"borders":return this.exportEl[e];case"annotations":case"grid":case"mountainboard":case"rider":return this.contextEl[e];default:throw new Error("Get not supported:"+e)}},KickerIOFromDOM.prototype.set=function(e,t){if(-1==this.supported.indexOf(e))throw new Error("Set not supported:"+e);var i=this.resultsEl;if(-1!==this.params.indexOf(e)?i=this.paramsEl:-1!==this.rep.indexOf(e)?i=this.repEl:-1!==this.context.indexOf(e)?i=this.contextEl:-1!==this["export"].indexOf(e)?i=this.exportEl:-1!==this.save.indexOf(e)&&(i=this.saveEl),-1!==this.floatValues.indexOf(e))i[e]=parseFloat(t,10).toFixed(2);else if(-1!==this.booleanValues.indexOf(e))switch(t){case 0:case"0":case!1:i[e]=!1;break;case 1:case"1":case!0:i[e]=!0}else i[e]=t};var KickerIOFromJSON=function(e){KickerIO.call(this),"string"==typeof e?this.storage=JSON.parse(JSONString):this.storage=e};KickerIOFromJSON.prototype=new KickerIO,KickerIOFromJSON.prototype.get=function(e){switch(e){case"height":case"width":case"angle":return parseFloat(this.storage[e]);case"repType":case"description":case"id":return this.storage[e];case"annotations":case"borders":case"fill":case"grid":case"mountainboard":case"rider":case"textured":return!!this.storage[e];default:throw new Error("Get not supported:"+e)}},KickerIOFromJSON.prototype.set=function(e,t){if(-1==this.supported.indexOf(e))throw new Error("Set not supported:"+e);-1!==this.floatValues.indexOf(e)?this.storage[e]=t.toFixed(2):this.storage[e]=t};var KickerModel=function(e){this.data=e,this.processDataParameters()};KickerModel.prototype.processDataParameters=function(){this.readData(),this.calculate(),this.refreshData()},KickerModel.prototype.readData=function(){this.height=this.data.get("height"),this.width=this.data.get("width"),this.angle=this.data.get("angle")},KickerModel.prototype.refreshData=function(){this.data.set("radius",this.radius),this.data.set("length",this.length),this.data.set("arc",this.arc)},KickerModel.prototype.calculate=function(){this.radius=this.calculateRadius(this.height,this.angle),this.length=this.calculateLength(this.height,this.angle),this.arc=this.calculateArc(this.radius,this.angle)},KickerModel.prototype.calculateRadius=function(e,t){var i=t*Math.PI/180,r=e/(1-Math.cos(i));return r},KickerModel.prototype.calculateLength=function(e,t){var i=t*Math.PI/180,r=e*Math.sin(i)/(1-Math.cos(i))+config.model3d.sides.extraLength;return r},KickerModel.prototype.calculateArc=function(e,t){var i=e*t*Math.PI/180;return i},KickerModel.prototype.create3dObject=function(e,t,i){var r=this.calculateSidePoints_(this.angle,this.radius,e),n=this.calculateSurfacePoints_(this.angle,this.radius,e,e.model3d.surface.thickness);return this.representation3d=new Representation3D(this.data,r,n,this.length,this.angle,this.arc,this.radius,this.width,this.height,t,e,i),this.representation3d},KickerModel.prototype.calculateSidePoints_=function(e,t,i){var r=i.model3d.sides.minHeight,n=Math.acos(1-r/this.radius),a=this.calculatePoints_(n,r,e,t,i),o=a[a.length-1],s=i.model3d.sides.extraLength;return a.push([o[0]+s,o[1]]),a.push([o[0]+s,0]),a.unshift([a[0][0],0]),a},KickerModel.prototype.calculateSurfacePoints_=function(e,t,r,n){var a=this.calculatePoints_(0,0,e,t,r),o=a.length,s=e*Math.PI/180;for(l=a.length-1,i=l;i>=0;i--){var c=i/o*s;x=a[i][0]-n*Math.sin(c),y=a[i][1]+n*Math.cos(c),a.push([x,y])}return a},KickerModel.prototype.calculatePoints_=function(e,t,i,r,n,a){for(var o,s,c,h=i*Math.PI/180,l=n.model3d.sides.steps,d=[],p=0;l>=p;p++)o=p/l*h,s=r*Math.sin(o),c=r*(1-Math.cos(o)),t>c||d.push([s,c]);return d},KickerModel.prototype.getRepresentation3d=function(){return this.representation3d};var Kicker=function(e){this.model=e};Kicker.prototype.refresh=function(){this.model.processDataParameters()},Kicker.prototype.getRepresentation3d=function(){return this.model.getRepresentation3d()},THREE.ColladaLoader=function(){function e(e,i,r,n){var a=0;if(document.implementation&&document.implementation.createDocument){var o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===o.readyState){if(0===o.status||200===o.status)if(o.responseXML)Fe=i,t(o.responseXML,void 0,e);else if(o.responseText){Fe=i;var s=new DOMParser,c=s.parseFromString(o.responseText,"application/xml");t(c,void 0,e)}else faillCallback?n():console.error("ColladaLoader: Empty or non-existing file ("+e+")")}else 3===o.readyState&&r&&(0===a&&(a=o.getResponseHeader("Content-Length")),r({total:a,loaded:o.responseText.length}))},o.open("GET",e,!0),o.send(null)}else alert("Don't know how to parse XML!")}function t(e,t,i){if(qe=e,t=t||Fe,void 0!==i){var o=i.split("/");o.pop(),_e=(o.length<1?".":o.join("/"))+"/"}r(),xe(),Ke=n("library_images image",k,"image"),Qe=n("library_materials material",J,"material"),Xe=n("library_effects effect",ie,"effect"),We=n("library_geometries geometry",q,"geometry"),Je=n("library_cameras camera",ce,"camera"),Ze=n("library_lights light",le,"light"),Ge=n("library_controllers controller",N,"controller"),Ye=n("library_animations animation",ne,"animation"),Ve=n("library_visual_scenes visual_scene",L,"visual_scene"),De=n("library_kinematics_models kinematics_model",pe,"kinematics_model"),Ie=[],Pe=[],Oe=a(),ze=new THREE.Group;for(var s=0;s<Oe.nodes.length;s++)ze.add(y(Oe.nodes[s]));ze.scale.multiplyScalar(tt),h(),Be=c(),A();var l={scene:ze,morphs:Ie,skins:Pe,animations:je,kinematics:Le,dae:{images:Ke,materials:Qe,cameras:Je,lights:Ze,effects:Xe,geometries:We,controllers:Ge,animations:Ye,visualScenes:Ve,visualScene:Oe,scene:Oe,kinematicsModels:De,kinematicsModel:Be}};return t&&t(l),l}function i(e){$e=e}function r(){var e=qe.querySelectorAll("asset"),t=e[0];if(t&&t.childNodes)for(var i=0;i<t.childNodes.length;i++){var r=t.childNodes[i];switch(r.nodeName){case"unit":var n=r.getAttribute("meter");n&&(tt=parseFloat(n));break;case"up_axis":it=r.textContent.charAt(0)}}}function n(e,t,i){for(var r=qe.querySelectorAll(e),n={},a=0,o=r.length,s=0;o>s;s++){var c=r[s],h=(new t).parse(c);h.id&&0!==h.id.length||(h.id=i+a++),n[h.id]=h}return n}function a(){var e=qe.querySelectorAll("scene instance_visual_scene")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return Ve[t.length>0?t:"visual_scene0"]}return null}function c(){var e=qe.querySelectorAll("instance_kinematics_model")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return De[t.length>0?t:"kinematics_model0"]}return null}function h(){je=[],l(ze)}function l(e){var t=Oe.getChildById(e.colladaId,!0),i=null;if(t&&t.keys){i={fps:60,hierarchy:[{node:t,keys:t.keys,sids:t.sids}],node:e,name:"animation_"+e.name,length:0},je.push(i);for(var r=0,n=t.keys.length;n>r;r++)i.length=Math.max(i.length,t.keys[r].time)}else i={hierarchy:[{keys:[],sids:[]}]};for(var r=0,n=e.children.length;n>r;r++)for(var a=l(e.children[r]),o=0,s=a.hierarchy.length;s>o;o++)i.hierarchy.push({keys:[],sids:[]});return i}function d(){var e,t=1e6,i=-t,r=0;for(var n in Ye){var a=Ye[n];e=e||a.id;for(var o=0;o<a.sampler.length;o++){var s=a.sampler[o];s.create(),t=Math.min(t,s.startTime),i=Math.max(i,s.endTime),r=Math.max(r,s.input.length)}}return{start:t,end:i,frames:r,ID:e}}function p(e,t){var i=t instanceof _?Ge[t.url]:t;if(!i||!i.morph)return void console.log("could not find morph controller!");for(var r=i.morph,n=0;n<r.targets.length;n++){var a=r.targets[n],o=We[a];if(o.mesh&&o.mesh.primitives&&o.mesh.primitives.length){var s=o.mesh.primitives[0].geometry;s.vertices.length===e.vertices.length&&e.morphTargets.push({name:"target_1",vertices:s.vertices})}}e.morphTargets.push({name:"target_Z",vertices:e.vertices})}function u(e,t,i,r){if(e.world=e.world||new THREE.Matrix4,e.localworld=e.localworld||new THREE.Matrix4,e.world.copy(e.matrix),e.localworld.copy(e.matrix),e.channels&&e.channels.length){var n=e.channels[0],a=n.sampler.output[i];a instanceof THREE.Matrix4&&(e.world.copy(a),e.localworld.copy(a),0===i&&e.matrix.copy(a))}r&&e.world.multiplyMatrices(r,e.world),t.push(e);for(var o=0;o<e.nodes.length;o++)u(e.nodes[o],t,i,e.world)}function f(e,t){for(var i=0;i<e.length;i++){var r=e[i],n=-1;if("JOINT"==r.type){for(var a=0;a<t.joints.length;a++)if(r.sid===t.joints[a]){n=a;break}if(n>=0){var o=t.invBindMatrices[n];r.invBindMatrix=o,r.skinningMatrix=new THREE.Matrix4,r.skinningMatrix.multiplyMatrices(r.world,o),r.animatrix=new THREE.Matrix4,r.animatrix.copy(r.localworld),r.weights=[];for(var a=0;a<t.weights.length;a++)for(var s=0;s<t.weights[a].length;s++){var c=t.weights[a][s];c.joint===n&&r.weights.push(c)}}else console.warn("ColladaLoader: Could not find joint '"+r.sid+"'."),r.skinningMatrix=new THREE.Matrix4,r.weights=[]}}}function m(e){var t=[],i=function(e,t,r){var n={};n.name=t.sid,n.parent=e,n.matrix=t.matrix;var a=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];n.matrix.decompose(a[0],a[1],a[2]),n.pos=[a[0].x,a[0].y,a[0].z],n.scl=[a[2].x,a[2].y,a[2].z],n.rotq=[a[1].x,a[1].y,a[1].z,a[1].w],r.push(n);for(var o in t.nodes)i(t.sid,t.nodes[o],r)};return i(-1,e,t),t}function E(e,t,i){var r=[];u(t,r,-1),f(r,i.skin),v=new THREE.Vector3;for(var n=[],a=0;a<e.vertices.length;a++)n.push(new THREE.Vector3);for(a=0;a<r.length;a++)if("JOINT"==r[a].type)for(j=0;j<r[a].weights.length;j++)w=r[a].weights[j],vidx=w.index,weight=w.weight,o=e.vertices[vidx],s=n[vidx],v.x=o.x,v.y=o.y,v.z=o.z,v.applyMatrix4(r[a].skinningMatrix),s.x+=v.x*weight,s.y+=v.y*weight,s.z+=v.z*weight;for(var a=0;a<e.vertices.length;a++)e.vertices[a]=n[a]}function g(e,t,i){var r=Ge[t.url];if(i=void 0!==i?i:40,!r||!r.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!t.skeleton||!t.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");for(var n=d(),a=Oe.getChildById(t.skeleton[0],!0)||Oe.getChildBySid(t.skeleton[0],!0),o=m(a),s=r.skin.joints,c=[],h=0;h<s.length;h++)for(var l=0;l<o.length;l++)o[l].name===s[h]&&(c[h]=o[l]);for(var h=0;h<c.length;h++)for(var l=0;l<c.length;l++)c[h].parent===c[l].name&&(c[h].parent=l);var h,l,p;new THREE.Vector3;for(h=0;h<e.vertices.length;h++)e.vertices[h].applyMatrix4(r.skin.bindShapeMatrix);for(var g=[],v=[],A=r.skin.weights,h=0;h<A.length;h++){var y=new THREE.Vector4(A[h][0]?A[h][0].joint:0,A[h][1]?A[h][1].joint:0,A[h][2]?A[h][2].joint:0,A[h][3]?A[h][3].joint:0),p=new THREE.Vector4(A[h][0]?A[h][0].weight:0,A[h][1]?A[h][1].weight:0,A[h][2]?A[h][2].weight:0,A[h][3]?A[h][3].weight:0);g.push(y),v.push(p)}e.skinIndices=g,e.skinWeights=v,e.bones=c;for(var w={name:n.ID,fps:30,length:n.frames/30,hierarchy:[]},l=0;l<c.length;l++)w.hierarchy.push({parent:c[l].parent,name:c[l].name,keys:[]});for(console.log("ColladaLoader:",n.ID+" has "+c.length+" bones."),E(e,a,r),i=0;i<n.frames;i++){var T=[];u(a,T,i),f(T,r.skin);for(var h=0;h<T.length;h++)for(var l=0;l<w.hierarchy.length;l++)if(w.hierarchy[l].name===T[h].sid){var b={};b.time=i/30,b.matrix=T[h].animatrix,0===i&&(T[h].matrix=b.matrix);var R=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];b.matrix.decompose(R[0],R[1],R[2]),b.pos=[R[0].x,R[0].y,R[0].z],b.scl=[R[2].x,R[2].y,R[2].z],b.rot=R[1],w.hierarchy[l].keys.push(b)}e.animation=w}}function A(){if(Be&&0===Be.joints.length)return void(Le=void 0);var e={},t=function(t,i){var r=i.getAttribute("id"),n=Oe.getChildById(r,!0),a=Be.joints[t];ze.traverse(function(i){i.colladaId==r&&(e[t]={node:i,transforms:n.transforms,joint:a,position:a.zeroPosition})})};Le={joints:Be&&Be.joints,getJointValue:function(t){var i=e[t];return i?i.position:void console.log("getJointValue: joint "+t+" doesn't exist")},setJointValue:function(t,i){var n=e[t];if(n){var a=n.joint;if(i>a.limits.max||i<a.limits.min)console.log("setJointValue: joint "+t+" value "+i+" outside of limits (min: "+a.limits.min+", max: "+a.limits.max+")");else if(a["static"])console.log("setJointValue: joint "+t+" is static");else{var o=n.node,s=a.axis,c=n.transforms,h=new THREE.Matrix4;for(r=0;r<c.length;r++){var l=c[r];if(l.sid&&-1!==l.sid.indexOf("joint"+t))switch(a.type){case"revolute":h.multiply(d.makeRotationAxis(s,THREE.Math.degToRad(i)));break;case"prismatic":h.multiply(d.makeTranslation(s.x*i,s.y*i,s.z*i));break;default:console.warn("setJointValue: unknown joint type: "+a.type)}else{var d=new THREE.Matrix4;switch(l.type){case"matrix":h.multiply(l.obj);break;case"translate":h.multiply(d.makeTranslation(l.obj.x,l.obj.y,l.obj.z));break;case"rotate":h.multiply(d.makeRotationAxis(l.obj,l.angle))}}}var p=h.elements,u=Array.prototype.slice.call(p),f=[u[0],u[4],u[8],u[12],u[1],u[5],u[9],u[13],u[2],u[6],u[10],u[14],u[3],u[7],u[11],u[15]];o.matrix.set.apply(o.matrix,f),o.matrix.decompose(o.position,o.quaternion,o.scale)}}else console.log("setJointValue: joint "+t+" doesn't exist")}};var i=qe.querySelector("scene instance_kinematics_scene");if(i)for(var r=0;r<i.childNodes.length;r++){var n=i.childNodes[r];if(1==n.nodeType)switch(n.nodeName){case"bind_joint_axis":var a=n.getAttribute("target").split("/").pop(),o=n.querySelector("axis param").textContent,s=parseInt(o.split("joint").pop().split(".")[0]),c=qe.querySelector('[sid="'+a+'"]');if(c){var h=c.parentElement;t(s,h)}}}}function y(e,t){var i,r,n,a,o=new THREE.Object3D,s=!1;for(n=0;n<e.controllers.length;n++){var c=Ge[e.controllers[n].url];switch(c.type){case"skin":if(We[c.skin.source]){var h=new P;h.url=c.skin.source,h.instance_material=e.controllers[n].instance_material,e.geometries.push(h),s=!0,i=e.controllers[n]}else if(Ge[c.skin.source]){var l=Ge[c.skin.source];if(r=l,l.morph&&We[l.morph.source]){var h=new P;h.url=l.morph.source,h.instance_material=e.controllers[n].instance_material,e.geometries.push(h)}}break;case"morph":if(We[c.morph.source]){var h=new P;h.url=c.morph.source,h.instance_material=e.controllers[n].instance_material,e.geometries.push(h),r=e.controllers[n]}console.log("ColladaLoader: Morph-controller partially supported.")}}var d={};for(n=0;n<e.geometries.length;n++){var u,f=e.geometries[n],m=f.instance_material,E=We[f.url],v={},A=[],w=0;if(E){if(!E.mesh||!E.mesh.primitives)continue;if(0===o.name.length&&(o.name=E.id),m)for(a=0;a<m.length;a++){var T=m[a],b=Qe[T.target],R=b.instance_effect.url,x=Xe[R].shader,S=x.material;if(E.doubleSided){if(!(T.symbol in d)){var H=S.clone();H.side=THREE.DoubleSide,d[T.symbol]=H}S=d[T.symbol]}S.opacity=S.opacity?S.opacity:1,v[T.symbol]=w,A.push(S),u=S,u.name=null===b.name||""===b.name?b.id:b.name,w++}var M,C=u||new THREE.MeshLambertMaterial({color:14540253,side:E.doubleSided?THREE.DoubleSide:THREE.FrontSide}),k=E.mesh.geometry3js;if(w>1)for(C=new THREE.MeshFaceMaterial(A),a=0;a<k.faces.length;a++){var N=k.faces[a];N.materialIndex=v[N.daeMaterial]}void 0!==i?(g(k,i),k.morphTargets.length>0?(C.morphTargets=!0,C.skinning=!1):(C.morphTargets=!1,C.skinning=!0),M=new THREE.SkinnedMesh(k,C,!1),M.name="skin_"+Pe.length,Pe.push(M)):void 0!==r?(p(k,r),C.morphTargets=!0,M=new THREE.Mesh(k,C),M.name="morph_"+Ie.length,Ie.push(M)):M=k.isLineStrip===!0?new THREE.Line(k):new THREE.Mesh(k,C),o.add(M)}}for(n=0;n<e.cameras.length;n++){var O=e.cameras[n],B=Je[O.url],j=new THREE.PerspectiveCamera(B.yfov,parseFloat(B.aspect_ratio),parseFloat(B.znear),parseFloat(B.zfar));o.add(j)}for(n=0;n<e.lights.length;n++){var L=null,V=e.lights[n],D=Ze[V.url];if(D&&D.technique){var _,I=D.color.getHex(),q=D.intensity,z=D.distance,F=D.falloff_angle;switch(D.technique){case"directional":L=new THREE.DirectionalLight(I,q,z),L.position.set(0,0,1);break;case"point":L=new THREE.PointLight(I,q,z);break;case"spot":L=new THREE.SpotLight(I,q,z,F,_),L.position.set(0,0,1);break;case"ambient":L=new THREE.AmbientLight(I)}}L&&o.add(L)}if(o.name=e.name||e.id||"",o.colladaId=e.id||"",o.layer=e.layer||"",o.matrix=e.matrix,o.matrix.decompose(o.position,o.quaternion,o.scale),et.centerGeometry&&o.geometry){var U=o.geometry.center();U.multiply(o.scale),U.applyQuaternion(o.quaternion),o.position.sub(U)}for(n=0;n<e.nodes.length;n++)o.add(y(e.nodes[n],e));return o}function T(e){for(var t=qe.querySelectorAll("library_nodes node"),i=0;i<t.length;i++){var r=t[i].attributes.getNamedItem("id");if(r&&r.value===e)return t[i]}}function b(e){var t=[],i=1e6,r=-1e6;for(var n in Ye)for(var a=Ye[n],o=0;o<a.channel.length;o++){var s=a.channel[o],c=a.sampler[o],n=s.target.split("/")[0];n==e.id&&(c.create(),s.sampler=c,i=Math.min(i,c.startTime),r=Math.max(r,c.endTime),t.push(s))}return t.length&&(e.startTime=i,e.endTime=r),t}function R(e){if(e.channels&&e.channels.length){for(var t=[],i=[],r=0,n=e.channels.length;n>r;r++){var a,o=e.channels[r],s=o.fullSid,c=o.sampler,h=c.input,l=e.getTransformBySid(o.sid);if(o.arrIndices){a=[];for(var d=0,p=o.arrIndices.length;p>d;d++)a[d]=ke(o.arrIndices[d])}else a=Ne(o.member);if(l){-1===i.indexOf(s)&&i.push(s);for(var d=0,p=h.length;p>d;d++){var u=h[d],f=c.getData(l.type,d,a),m=x(t,u);if(!m){m=new se(u);var E=S(t,u);t.splice(-1===E?t.length:E,0,m)}m.addTarget(s,l,a,f)}}else console.log('Could not find transform "'+o.sid+'" in node '+e.id)}for(var r=0;r<i.length;r++)for(var g=i[r],d=0;d<t.length;d++){var m=t[d];m.hasTarget(g)||H(t,m,d,g)}e.keys=t,e.sids=i}}function x(e,t){for(var i=null,r=0,n=e.length;n>r&&null===i;r++){var a=e[r];if(a.time===t)i=a;else if(a.time>t)break}return i}function S(e,t){for(var i=-1,r=0,n=e.length;n>r&&-1===i;r++){var a=e[r];a.time>=t&&(i=r)}return i}function H(e,t,i,r){var n=C(e,r,i?i-1:0),a=M(e,r,i+1);if(n&&a){var o,s=(t.time-n.time)/(a.time-n.time),c=n.getTarget(r),h=a.getTarget(r).data,l=c.data;if("matrix"===c.type)o=l;else if(l.length){o=[];for(var d=0;d<l.length;++d)o[d]=l[d]+(h[d]-l[d])*s}else o=l+(h-l)*s;t.addTarget(r,c.transform,c.member,o)}}function M(e,t,i){for(;i<e.length;i++){var r=e[i];if(r.hasTarget(t))return r}return null}function C(e,t,i){for(i=i>=0?i:i+e.length;i>=0;i--){var r=e[i];if(r.hasTarget(t))return r}return null}function k(){this.id="",this.init_from=""}function N(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function O(){this.method=null,this.source=null,this.targets=null,this.weights=null}function B(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function L(){this.id="",this.name="",this.nodes=[],this.scene=new THREE.Group}function V(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE.Matrix4}function D(){this.sid="",this.type="",this.data=[],this.obj=null}function _(){this.url="",this.skeleton=[],this.instance_material=[]}function I(){this.symbol="",this.target=""}function P(){this.url="",this.instance_material=[]}function q(){this.id="",this.mesh=null}function z(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function F(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE.Geometry}function U(){F.call(this),this.vcount=[]}function K(){F.call(this),this.vcount=1}function Y(){F.call(this),this.vcount=3}function G(){this.source="",this.count=0,this.stride=0,this.params=[]}function W(){this.input={}}function Q(){this.semantic="",this.offset=0,this.source="",this.set=0}function X(e){this.id=e,this.type=null}function J(){this.id="",this.name="",this.instance_effect=null}function Z(){this.color=new THREE.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function $(e,t){this.type=e,this.effect=t,this.material=null}function ee(e){this.effect=e,this.init_from=null,this.format=null}function te(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function ie(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function re(){this.url=""}function ne(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function ae(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function oe(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function se(e){this.targets=[],this.time=e}function ce(){this.id="",this.name="",this.technique=""}function he(){this.url=""}function le(){this.id="",this.name="",this.technique=""}function de(){this.url=""}function pe(){this.id="",this.name="",this.joints=[],this.links=[]}function ue(){this.sid="",this.name="",this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this["static"]=!1,this.zeroPosition=0,this.middlePosition=0}function fe(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function me(){this.joint="",this.transforms=[],this.links=[]}function Ee(e){var t=e.getAttribute("id");return void 0!=Ue[t]?Ue[t]:(Ue[t]=new X(t).parse(e),Ue[t])}function ge(e){for(var t=ye(e),i=[],r=0,n=t.length;n>r;r++)i.push("true"===t[r]||"1"===t[r]);return i}function ve(e){for(var t=ye(e),i=[],r=0,n=t.length;n>r;r++)i.push(parseFloat(t[r]));return i}function Ae(e){for(var t=ye(e),i=[],r=0,n=t.length;n>r;r++)i.push(parseInt(t[r],10));return i}function ye(e){return e.length>0?we(e).split(/\s+/):[]}function we(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}function Te(e,t,i){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):i}function be(e,t){loader=new THREE.ImageLoader,loader.load(t,function(t){e.image=t,e.needsUpdate=!0})}function Re(e,t){e.doubleSided=!1;var i=t.querySelectorAll("extra double_sided")[0];i&&i&&1===parseInt(i.textContent,10)&&(e.doubleSided=!0)}function xe(){if(et.convertUpAxis!==!0||it===et.upAxis)rt=null;else switch(it){case"X":rt="Y"===et.upAxis?"XtoY":"XtoZ";break;case"Y":rt="X"===et.upAxis?"YtoX":"YtoZ";break;case"Z":rt="X"===et.upAxis?"ZtoX":"ZtoY"}}function Se(e,t){if(et.convertUpAxis===!0&&it!==et.upAxis)switch(rt){case"XtoY":var i=e[0];e[0]=t*e[1],e[1]=i;break;case"XtoZ":var i=e[2];e[2]=e[1],e[1]=e[0],e[0]=i;break;case"YtoX":var i=e[0];e[0]=e[1],e[1]=t*i;break;case"YtoZ":var i=e[1];e[1]=t*e[2],e[2]=i;break;case"ZtoX":var i=e[0];e[0]=e[1],e[1]=e[2],e[2]=i;break;case"ZtoY":var i=e[1];e[1]=e[2],e[2]=t*i}}function He(e,t){if(et.convertUpAxis!==!0||it===et.upAxis)return t;switch(e){case"X":t="XtoY"===rt?-1*t:t;break;case"Y":t="YtoZ"===rt||"YtoX"===rt?-1*t:t;break;case"Z":t="ZtoY"===rt?-1*t:t}return t}function Me(e,t){var i=[e[t],e[t+1],e[t+2]];return Se(i,-1),new THREE.Vector3(i[0],i[1],i[2])}function Ce(e){if(et.convertUpAxis){var t=[e[0],e[4],e[8]];Se(t,-1),e[0]=t[0],e[4]=t[1],e[8]=t[2],t=[e[1],e[5],e[9]],Se(t,-1),e[1]=t[0],e[5]=t[1],e[9]=t[2],t=[e[2],e[6],e[10]],Se(t,-1),e[2]=t[0],e[6]=t[1],e[10]=t[2],t=[e[0],e[1],e[2]],Se(t,-1),e[0]=t[0],e[1]=t[1],e[2]=t[2],t=[e[4],e[5],e[6]],Se(t,-1),e[4]=t[0],e[5]=t[1],e[6]=t[2],t=[e[8],e[9],e[10]],Se(t,-1),e[8]=t[0],e[9]=t[1],e[10]=t[2],t=[e[3],e[7],e[11]],Se(t,-1),e[3]=t[0],e[7]=t[1],e[11]=t[2]}return(new THREE.Matrix4).set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function ke(e){if(e>-1&&3>e){var t=["X","Y","Z"],i={X:0,Y:1,Z:2};e=Ne(t[e]),e=i[e]}return e}function Ne(e){if(et.convertUpAxis)switch(e){case"X":switch(rt){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z"}break;case"Y":switch(rt){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z"}break;case"Z":switch(rt){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y"}}return e}var Oe,Be,je,Le,Ve,De,_e,Ie,Pe,qe=null,ze=null,Fe=null,Ue={},Ke={},Ye={},Ge={},We={},Qe={},Xe={},Je={},Ze={},$e=THREE.SmoothShading,et={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null},tt=1,it="Y",rt=null;return k.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];"init_from"===i.nodeName&&(this.init_from=i.textContent)}return this},N.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"skin":this.skin=(new B).parse(i),this.type=i.nodeName;break;case"morph":this.morph=(new O).parse(i),this.type=i.nodeName}}return this},O.prototype.parse=function(e){var t,i={},r=[];for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(1==n.nodeType)switch(n.nodeName){case"source":var a=(new X).parse(n);i[a.id]=a;break;case"targets":r=this.parseInputs(n);break;default:console.log(n.nodeName)}}for(t=0;t<r.length;t++){var o=r[t],a=i[o.source];switch(o.semantic){case"MORPH_TARGET":this.targets=a.read();break;case"MORPH_WEIGHT":this.weights=a.read()}}return this},O.prototype.parseInputs=function(e){for(var t=[],i=0;i<e.childNodes.length;i++){var r=e.childNodes[i];if(1==r.nodeType)switch(r.nodeName){case"input":t.push((new Q).parse(r))}}return t},B.prototype.parse=function(e){var t,i,r={};this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var n=0;n<e.childNodes.length;n++){var a=e.childNodes[n];if(1==a.nodeType)switch(a.nodeName){case"bind_shape_matrix":var o=ve(a.textContent);this.bindShapeMatrix=Ce(o);break;case"source":var s=(new X).parse(a);r[s.id]=s;break;case"joints":t=a;break;case"vertex_weights":i=a;break;default:console.log(a.nodeName)}}return this.parseJoints(t,r),this.parseWeights(i,r),this},B.prototype.parseJoints=function(e,t){for(var i=0;i<e.childNodes.length;i++){var r=e.childNodes[i];if(1==r.nodeType)switch(r.nodeName){case"input":var n=(new Q).parse(r),a=t[n.source];"JOINT"===n.semantic?this.joints=a.read():"INV_BIND_MATRIX"===n.semantic&&(this.invBindMatrices=a.read())}}},B.prototype.parseWeights=function(e,t){for(var i,r,n=[],a=0;a<e.childNodes.length;a++){var o=e.childNodes[a];if(1==o.nodeType)switch(o.nodeName){case"input":n.push((new Q).parse(o));break;case"v":i=Ae(o.textContent);break;case"vcount":r=Ae(o.textContent)}}for(var s=0,a=0;a<r.length;a++){for(var c=r[a],h=[],l=0;c>l;l++){for(var d={},p=0;p<n.length;p++){var u=n[p],f=i[s+u.offset];switch(u.semantic){case"JOINT":d.joint=f;break;case"WEIGHT":d.weight=t[u.source].data[f]}}h.push(d),s+=n.length}for(var l=0;l<h.length;l++)h[l].index=a;this.weights.push(h)}},L.prototype.getChildById=function(e,t){for(var i=0;i<this.nodes.length;i++){var r=this.nodes[i].getChildById(e,t);if(r)return r}return null},L.prototype.getChildBySid=function(e,t){for(var i=0;i<this.nodes.length;i++){var r=this.nodes[i].getChildBySid(e,t);if(r)return r}return null},L.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"node":this.nodes.push((new V).parse(i))}}return this},V.prototype.getChannelForTransform=function(e){for(var t=0;t<this.channels.length;t++){var i,r,n=this.channels[t],a=n.target.split("/"),o=(a.shift(),a.shift()),s=o.indexOf(".")>=0,c=o.indexOf("(")>=0;if(s)a=o.split("."),o=a.shift(),r=a.shift();else if(c){i=o.split("("),o=i.shift();for(var h=0;h<i.length;h++)i[h]=parseInt(i[h].replace(/\)/,""))}if(o===e)return n.info={sid:o,dotSyntax:s,arrSyntax:c,arrIndices:i},n}return null},V.prototype.getChildById=function(e,t){if(this.id===e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var r=this.nodes[i].getChildById(e,t);if(r)return r}return null},V.prototype.getChildBySid=function(e,t){if(this.sid===e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var r=this.nodes[i].getChildBySid(e,t);if(r)return r}return null},V.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++)if(this.transforms[t].sid===e)return this.transforms[t];return null},V.prototype.parse=function(e){var t;this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),
this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.layer=e.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE.Matrix4;for(var i=0;i<e.childNodes.length;i++){var r=e.childNodes[i];if(1==r.nodeType)switch(r.nodeName){case"node":this.nodes.push((new V).parse(r));break;case"instance_camera":this.cameras.push((new he).parse(r));break;case"instance_controller":this.controllers.push((new _).parse(r));break;case"instance_geometry":this.geometries.push((new P).parse(r));break;case"instance_light":this.lights.push((new de).parse(r));break;case"instance_node":t=r.getAttribute("url").replace(/^#/,"");var n=T(t);n&&this.nodes.push((new V).parse(n));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new D).parse(r));break;case"extra":break;default:console.log(r.nodeName)}}return this.channels=b(this),R(this),this.updateMatrix(),this},V.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},D.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=ve(e.textContent),this.convert(),this},D.prototype.convert=function(){switch(this.type){case"matrix":this.obj=Ce(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);case"translate":Se(this.data,-1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":Se(this.data,1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},D.prototype.apply=function(){var e=new THREE.Matrix4;return function(t){switch(this.type){case"matrix":t.multiply(this.obj);break;case"translate":t.multiply(e.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":t.multiply(e.makeRotationAxis(this.obj,this.angle));break;case"scale":t.scale(this.obj)}}}(),D.prototype.update=function(e,t){var i=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(t)if(1===t.length)switch(t[0]){case 0:this.obj.n11=e[0],this.obj.n21=e[1],this.obj.n31=e[2],this.obj.n41=e[3];break;case 1:this.obj.n12=e[0],this.obj.n22=e[1],this.obj.n32=e[2],this.obj.n42=e[3];break;case 2:this.obj.n13=e[0],this.obj.n23=e[1],this.obj.n33=e[2],this.obj.n43=e[3];break;case 3:this.obj.n14=e[0],this.obj.n24=e[1],this.obj.n34=e[2],this.obj.n44=e[3]}else if(2===t.length){var r="n"+(t[0]+1)+(t[1]+1);this.obj[r]=e}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(e);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=i[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=i[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=THREE.Math.degToRad(e);break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=THREE.Math.degToRad(e[3])}}},_.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1===i.nodeType)switch(i.nodeName){case"skeleton":this.skeleton.push(i.textContent.replace(/^#/,""));break;case"bind_material":for(var r=i.querySelectorAll("instance_material"),n=0;n<r.length;n++){var a=r[n];this.instance_material.push((new I).parse(a))}break;case"extra":}}return this},I.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},P.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType&&"bind_material"===i.nodeName){for(var r=i.querySelectorAll("instance_material"),n=0;n<r.length;n++){var a=r[n];this.instance_material.push((new I).parse(a))}break}}return this},q.prototype.parse=function(e){this.id=e.getAttribute("id"),Re(this,e);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"mesh":this.mesh=new z(this).parse(i);break;case"extra":}}return this},z.prototype.parse=function(e){this.primitives=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"source":Ee(i);break;case"vertices":this.vertices=(new W).parse(i);break;case"linestrips":this.primitives.push((new K).parse(i));break;case"triangles":this.primitives.push((new Y).parse(i));break;case"polygons":this.primitives.push((new F).parse(i));break;case"polylist":this.primitives.push((new U).parse(i))}}if(this.geometry3js=new THREE.Geometry,null===this.vertices)return this;for(var r=Ue[this.vertices.input.POSITION.source].data,t=0;t<r.length;t+=3)this.geometry3js.vertices.push(Me(r,t).clone());for(var t=0;t<this.primitives.length;t++){var n=this.primitives[t];n.setVertices(this.vertices),this.handlePrimitive(n,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},z.prototype.handlePrimitive=function(e,t){if(e instanceof K)return void(t.isLineStrip=!0);var i,r,n,a,o,s,c,h=e.p,l=e.inputs,d=0,p=3,u=0,f=[];for(i=0;i<l.length;i++){n=l[i];var m=n.offset+1;switch(u=m>u?m:u,n.semantic){case"TEXCOORD":f.push(n.set)}}for(var E=0;E<h.length;++E)for(var g=h[E],v=0;v<g.length;){var A=[],y=[],w=null,T=[];for(p=e.vcount?e.vcount.length?e.vcount[d++]:e.vcount:g.length/u,i=0;p>i;i++)for(r=0;r<l.length;r++)switch(n=l[r],s=Ue[n.source],a=g[v+i*u+n.offset],c=s.accessor.params.length,o=a*c,n.semantic){case"VERTEX":A.push(a);break;case"NORMAL":y.push(Me(s.data,o));break;case"TEXCOORD":w=w||{},void 0===w[n.set]&&(w[n.set]=[]),w[n.set].push(new THREE.Vector2(s.data[o],s.data[o+1]));break;case"COLOR":T.push((new THREE.Color).setRGB(s.data[o],s.data[o+1],s.data[o+2]))}if(0===y.length)if(n=this.vertices.input.NORMAL){s=Ue[n.source],c=s.accessor.params.length;for(var b=0,R=A.length;R>b;b++)y.push(Me(s.data,A[b]*c))}else t.calcNormals=!0;if(!w&&(w={},n=this.vertices.input.TEXCOORD)){f.push(n.set),s=Ue[n.source],c=s.accessor.params.length;for(var b=0,R=A.length;R>b;b++)o=A[b]*c,void 0===w[n.set]&&(w[n.set]=[]),w[n.set].push(new THREE.Vector2(s.data[o],1-s.data[o+1]))}if(0===T.length&&(n=this.vertices.input.COLOR)){s=Ue[n.source],c=s.accessor.params.length;for(var b=0,R=A.length;R>b;b++)o=A[b]*c,T.push((new THREE.Color).setRGB(s.data[o],s.data[o+1],s.data[o+2]))}var x,S,H=null,M=[];if(3===p)M.push(new THREE.Face3(A[0],A[1],A[2],y,T.length?T:new THREE.Color));else if(4===p)M.push(new THREE.Face3(A[0],A[1],A[3],[y[0].clone(),y[1].clone(),y[3].clone()],T.length?[T[0],T[1],T[3]]:new THREE.Color)),M.push(new THREE.Face3(A[1],A[2],A[3],[y[1].clone(),y[2].clone(),y[3].clone()],T.length?[T[1],T[2],T[3]]:new THREE.Color));else if(p>4&&et.subdivideFaces){var C=T.length?T:new THREE.Color;for(r=1;p-1>r;)M.push(new THREE.Face3(A[0],A[r],A[r+1],[y[0].clone(),y[r++].clone(),y[r].clone()],C))}if(M.length)for(var b=0,R=M.length;R>b;b++)for(H=M[b],H.daeMaterial=e.material,t.faces.push(H),r=0;r<f.length;r++)x=w[f[r]],S=p>4?[x[0],x[b+1],x[b+2]]:4===p?0===b?[x[0],x[1],x[3]]:[x[1].clone(),x[2],x[3].clone()]:[x[0],x[1],x[2]],void 0===t.faceVertexUvs[r]&&(t.faceVertexUvs[r]=[]),t.faceVertexUvs[r].push(S);else console.log("dropped face with vcount "+p+" for geometry with id: "+t.id);v+=u*p}},F.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source===e.id&&(this.inputs[t].source=e.input.POSITION.source)},F.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=Te(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"input":this.inputs.push((new Q).parse(e.childNodes[t]));break;case"vcount":this.vcount=Ae(i.textContent);break;case"p":this.p.push(Ae(i.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},U.prototype=Object.create(F.prototype),U.prototype.constructor=U,K.prototype=Object.create(F.prototype),K.prototype.constructor=K,Y.prototype=Object.create(F.prototype),Y.prototype.constructor=Y,G.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=Te(e,"count",0),this.stride=Te(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if("param"===i.nodeName){var r={};r.name=i.getAttribute("name"),r.type=i.getAttribute("type"),this.params.push(r)}}return this},W.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++)if("input"===e.childNodes[t].nodeName){var i=(new Q).parse(e.childNodes[t]);this.input[i.semantic]=i}return this},Q.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=Te(e,"set",-1),this.offset=Te(e,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},X.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"bool_array":this.data=ge(i.textContent),this.type=i.nodeName;break;case"float_array":this.data=ve(i.textContent),this.type=i.nodeName;break;case"int_array":this.data=Ae(i.textContent),this.type=i.nodeName;break;case"IDREF_array":case"Name_array":this.data=ye(i.textContent),this.type=i.nodeName;break;case"technique_common":for(var r=0;r<i.childNodes.length;r++)if("accessor"===i.childNodes[r].nodeName){this.accessor=(new G).parse(i.childNodes[r]);break}}}return this},X.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var i=0;i<this.data.length;i+=16){var r=this.data.slice(i,i+16),n=Ce(r);e.push(n)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},J.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if("instance_effect"===e.childNodes[t].nodeName){this.instance_effect=(new re).parse(e.childNodes[t]);break}return this},Z.prototype.isColor=function(){return null===this.texture},Z.prototype.isTexture=function(){return null!=this.texture},Z.prototype.parse=function(e){"transparent"===e.nodeName&&(this.opaque=e.getAttribute("opaque"));for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"color":var r=ve(i.textContent);this.color=new THREE.Color,this.color.setRGB(r[0],r[1],r[2]),this.color.a=r[3];break;case"texture":this.texture=i.getAttribute("texture"),this.texcoord=i.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(i)}}return this},Z.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1],e.childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]));for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[i.nodeName]=parseFloat(i.textContent);break;case"wrapU":case"wrapV":"TRUE"===i.textContent.toUpperCase()?this.texOpts[i.nodeName]=1:this.texOpts[i.nodeName]=parseInt(i.textContent);break;default:this.texOpts[i.nodeName]=i.textContent}}return this},$.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[i.nodeName]=(new Z).parse(i);break;case"bump":var r=i.getAttribute("bumptype");r?"heightfield"===r.toLowerCase()?this.bump=(new Z).parse(i):"normalmap"===r.toLowerCase()?this.normal=(new Z).parse(i):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+r+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new Z).parse(i)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new Z).parse(i));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var n=i.querySelectorAll("float");n.length>0&&(this[i.nodeName]=parseFloat(n[0].textContent))}}return this.create(),this},$.prototype.create=function(){var e={},t=!1;if(void 0!==this.transparency&&void 0!==this.transparent){var i=(this.transparent,(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency);i>0&&(t=!0,e.transparent=!0,e.opacity=1-i)}var r={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var n in this)switch(n){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var a=this[n];if(a instanceof Z)if(a.isTexture()){var o=a.texture,s=this.effect.sampler[o];if(void 0!==s&&void 0!==s.source){var c=this.effect.surface[s.source];if(void 0!==c){var h=Ke[c.init_from];if(h){var l,d=_e+h.init_from,p=THREE.Loader.Handlers.get(d);null!==p?l=p.load(d):(l=new THREE.Texture,be(l,d)),l.wrapS=a.texOpts.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,l.wrapT=a.texOpts.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,l.offset.x=a.texOpts.offsetU,l.offset.y=a.texOpts.offsetV,l.repeat.x=a.texOpts.repeatU,l.repeat.y=a.texOpts.repeatV,e[r[n]]=l,"emission"===n&&(e.emissive=16777215)}}}}else"diffuse"!==n&&t||("emission"===n?e.emissive=a.color.getHex():e[n]=a.color.getHex());break;case"shininess":e[n]=this[n];break;case"reflectivity":e[n]=this[n],e[n]>0&&(e.envMap=et.defaultEnvMap),e.combine=THREE.MixOperation;break;case"index_of_refraction":e.refractionRatio=this[n],1!==this[n]&&(e.envMap=et.defaultEnvMap);break;case"transparency":}switch(e.shading=$e,e.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide,this.type){case"constant":void 0!=e.emissive&&(e.color=e.emissive),this.material=new THREE.MeshBasicMaterial(e);break;case"phong":case"blinn":void 0!=e.diffuse&&(e.color=e.diffuse),this.material=new THREE.MeshPhongMaterial(e);break;case"lambert":default:void 0!=e.diffuse&&(e.color=e.diffuse),this.material=new THREE.MeshLambertMaterial(e)}return this.material},ee.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"init_from":this.init_from=i.textContent;break;case"format":this.format=i.textContent;break;default:console.log("unhandled Surface prop: "+i.nodeName)}}return this},te.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"source":this.source=i.textContent;break;case"minfilter":this.minfilter=i.textContent;break;case"magfilter":this.magfilter=i.textContent;break;case"mipfilter":this.mipfilter=i.textContent;break;case"wrap_s":this.wrap_s=i.textContent;break;case"wrap_t":this.wrap_t=i.textContent;break;default:console.log("unhandled Sampler2D prop: "+i.nodeName)}}return this},ie.prototype.create=function(){return null===this.shader?null:void 0},ie.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),Re(this,e),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(i))}}return this},ie.prototype.parseNewparam=function(e){for(var t=e.getAttribute("sid"),i=0;i<e.childNodes.length;i++){var r=e.childNodes[i];if(1==r.nodeType)switch(r.nodeName){case"surface":this.surface[t]=new ee(this).parse(r);break;case"sampler2D":this.sampler[t]=new te(this).parse(r);break;case"extra":break;default:console.log(r.nodeName)}}},ie.prototype.parseProfileCOMMON=function(e){for(var t,i=0;i<e.childNodes.length;i++){var r=e.childNodes[i];if(1==r.nodeType)switch(r.nodeName){case"profile_COMMON":this.parseProfileCOMMON(r);break;case"technique":t=r;break;case"newparam":this.parseNewparam(r);break;case"image":var n=(new k).parse(r);Ke[n.id]=n;break;case"extra":break;default:console.log(r.nodeName)}}return t},ie.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new $(i.nodeName,this).parse(i);break;case"extra":this.parseExtra(i)}}},ie.prototype.parseExtra=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique":this.parseExtraTechnique(i)}}},ie.prototype.parseExtraTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"bump":this.shader.parse(e)}}},re.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},ne.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"animation":var r=(new ne).parse(i);for(var n in r.source)this.source[n]=r.source[n];for(var a=0;a<r.channel.length;a++)this.channel.push(r.channel[a]),this.sampler.push(r.sampler[a]);break;case"source":var n=(new X).parse(i);this.source[n.id]=n;break;case"sampler":this.sampler.push(new oe(this).parse(i));break;case"channel":this.channel.push(new ae(this).parse(i))}}return this},ae.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");var t=this.target.split("/"),i=(t.shift(),t.shift()),r=i.indexOf(".")>=0,n=i.indexOf("(")>=0;if(r)t=i.split("."),this.sid=t.shift(),this.member=t.shift();else if(n){var a=i.split("(");this.sid=a.shift();for(var o=0;o<a.length;o++)a[o]=parseInt(a[o].replace(/\)/,""));this.arrIndices=a}else this.sid=i;return this.fullSid=i,this.dotSyntax=r,this.arrSyntax=n,this},oe.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"input":this.inputs.push((new Q).parse(i))}}return this},oe.prototype.create=function(){for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e],i=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=i.read();break;case"OUTPUT":this.output=i.read(),this.strideOut=i.accessor.stride;break;case"INTERPOLATION":this.interpolation=i.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(t.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(var e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},oe.prototype.getData=function(e,t,i){var r;if("matrix"===e&&16===this.strideOut)r=this.output[t];else if(this.strideOut>1){r=[],t*=this.strideOut;for(var n=0;n<this.strideOut;++n)r[n]=this.output[t+n];if(3===this.strideOut)switch(e){case"rotate":case"translate":Se(r,-1);break;case"scale":Se(r,1)}else 4===this.strideOut&&"matrix"===e&&Se(r,-1)}else r=this.output[t],i&&"translate"===e&&(r=He(i,r));return r},se.prototype.addTarget=function(e,t,i,r){this.targets.push({sid:e,member:i,transform:t,data:r})},se.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var i=this.targets[t];e&&i.sid!==e||i.transform.update(i.data,i.member)}},se.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},se.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},se.prototype.interpolate=function(e,t){for(var i=0,r=this.targets.length;r>i;i++){var n,a=this.targets[i],o=e.getTarget(a.sid);if("matrix"!==a.transform.type&&o){var s=(t-this.time)/(e.time-this.time),c=o.data,h=a.data;if(0>s&&(s=0),s>1&&(s=1),h.length){n=[];for(var l=0;l<h.length;++l)n[l]=h[l]+(c[l]-h[l])*s}else n=h+(c-h)*s}else n=a.data;a.transform.update(n,a.member)}},ce.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"optics":this.parseOptics(i)}}return this},ce.prototype.parseOptics=function(e){for(var t=0;t<e.childNodes.length;t++)if("technique_common"===e.childNodes[t].nodeName)for(var i=e.childNodes[t],r=0;r<i.childNodes.length;r++)if(this.technique=i.childNodes[r].nodeName,"perspective"===this.technique)for(var n=i.childNodes[r],a=0;a<n.childNodes.length;a++){var o=n.childNodes[a];switch(o.nodeName){case"yfov":this.yfov=o.textContent;break;case"xfov":this.xfov=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}else if("orthographic"===this.technique)for(var s=i.childNodes[r],a=0;a<s.childNodes.length;a++){var o=s.childNodes[a];switch(o.nodeName){case"xmag":this.xmag=o.textContent;break;case"ymag":this.ymag=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}return this},he.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},le.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique_common":this.parseCommon(i);break;case"technique":this.parseTechnique(i)}}return this},le.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++)switch(e.childNodes[t].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[t].nodeName;for(var i=e.childNodes[t],r=0;r<i.childNodes.length;r++){var n=i.childNodes[r];switch(n.nodeName){case"color":var a=ve(n.textContent);this.color=new THREE.Color(0),this.color.setRGB(a[0],a[1],a[2]),this.color.a=a[3];break;case"falloff_angle":this.falloff_angle=parseFloat(n.textContent);break;case"quadratic_attenuation":var o=parseFloat(n.textContent);this.distance=o?Math.sqrt(1/o):0}}}return this},le.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"intensity":this.intensity=parseFloat(i.textContent)}}return this},de.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},pe.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.joints=[],this.links=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique_common":this.parseCommon(i)}}return this},pe.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(e.childNodes[t].nodeName){case"joint":this.joints.push((new ue).parse(i));break;case"link":this.links.push((new fe).parse(i))}}return this},ue.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this["static"]=!1,this.zeroPosition=0,this.middlePosition=0;var t=e.querySelector("axis"),i=ve(t.textContent);this.axis=Me(i,0);var r=e.querySelector("limits min")?parseFloat(e.querySelector("limits min").textContent):-360,n=e.querySelector("limits max")?parseFloat(e.querySelector("limits max").textContent):360;this.limits={min:r,max:n};for(var a=["prismatic","revolute"],o=0;o<a.length;o++){var s=a[o],c=e.querySelector(s);c&&(this.type=s)}return this.limits.min>=this.limits.max&&(this["static"]=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},fe.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.transforms=[],this.attachments=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"attachment_full":this.attachments.push((new me).parse(i));break;case"rotate":case"translate":case"matrix":this.transforms.push((new D).parse(i))}}return this},me.prototype.parse=function(e){this.joint=e.getAttribute("joint").split("/").pop(),this.links=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"link":this.links.push((new fe).parse(i));break;case"rotate":case"translate":case"matrix":this.transforms.push((new D).parse(i))}}return this},{load:e,parse:t,setPreferredShading:i,applySkin:g,geometries:We,options:et}};var THREEx=THREEx||{};THREEx.GeometryUtils=THREEx.GeometryUtils||{},THREEx.GeometryUtils.scale=function(e,t){for(var i=0;i<e.vertices.length;i++){var r=e.vertices[i];r.position.multiplySelf(t)}return e.__dirtyVertices=!0,this},THREEx.GeometryUtils.translate=function(e,t){for(var i=0;i<e.vertices.length;i++){var r=e.vertices[i];r.position.addSelf(t)}return e.__dirtyVertices=!0,this},THREEx.GeometryUtils.middlePoint=function(e){e.computeBoundingBox();var t=new THREE.Vector3;return t.x=(e.boundingBox.x[1]+e.boundingBox.x[0])/2,t.y=(e.boundingBox.y[1]+e.boundingBox.y[0])/2,t.z=(e.boundingBox.z[1]+e.boundingBox.z[0])/2,t},THREEx.GeometryUtils.center=function(e,t,i,r){var n=this.middlePoint(e).negate();return t&&(n.x=0),i&&(n.y=0),r&&(n.z=0),this.translate(e,n)},THREEx.GeometryUtils.attachRightLeft=function(e,t,i){void 0===i&&(i=0),e.computeBoundingBox(),t.computeBoundingBox();var r=e.boundingBox.x[1],n=t.boundingBox.x[0],a=new THREE.Vector3;return a.x=r+-n+i,this.translate(t,a),this},THREE.DeviceOrientationControls=function(){var e=new THREE.Vector3(0,0,1),t=new THREE.Euler,i=new THREE.Quaternion,r=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));this.deviceOrientation={},this.screenOrientation=0,this.onDeviceOrientationChangeEvent=function(e){this.deviceOrientation=e,this.enabled&&this.update()},this.onScreenOrientationChangeEvent=function(e){this.screenOrientation=window.orientation||0,this.enabled&&this.update()},this.updateCamera=function(n,a,o,s){var c=this.getCamera().quaternion;t.set(a,n,-o,"YXZ"),c.setFromEuler(t),c.multiply(r),c.multiply(i.setFromAxisAngle(e,-s))},this.getCamera=function(){return this.renderer.cameras.perspective},this.connect=function(e){this.renderer=e,window.cam=this.getCamera(),this.getCamera().rotation.reorder("YXZ"),this.onScreenOrientationChangeEvent(),window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent.bind(this),!1),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent.bind(this),!1),this.enabled=!0},this.disconnect=function(){window.removeEventListener("orientationchange",this.onScreenOrientationChangeEvent.bind(this),!1),window.removeEventListener("deviceorientation",this.onDeviceOrientationChangeEvent.bind(this),!1),this.enabled=!1},this.update=function(){if(this.enabled){var e=this.deviceOrientation.alpha?THREE.Math.degToRad(this.deviceOrientation.alpha):0,t=this.deviceOrientation.beta?THREE.Math.degToRad(this.deviceOrientation.beta):0,i=this.deviceOrientation.gamma?THREE.Math.degToRad(this.deviceOrientation.gamma):0,r=this.screenOrientation?THREE.Math.degToRad(this.screenOrientation):0;this.updateCamera(e,t,i,r)}}},THREE.StereoEffect=function(e){this.separation=3;var t,i,r=new THREE.Vector3,n=new THREE.Quaternion,a=new THREE.Vector3,o=new THREE.PerspectiveCamera,s=new THREE.PerspectiveCamera;this.setSize=function(r,n){t=r/2,i=n,e.setSize(r,n)},this.render=function(c,h){c.updateMatrixWorld(),void 0===h.parent&&h.updateMatrixWorld(),h.matrixWorld.decompose(r,n,a),o.fov=h.fov,o.aspect=.5*h.aspect,o.near=h.near,o.far=h.far,o.updateProjectionMatrix(),o.position.copy(r),o.quaternion.copy(n),o.translateX(-this.separation),s.near=h.near,s.far=h.far,s.projectionMatrix=o.projectionMatrix,s.position.copy(r),s.quaternion.copy(n),s.translateX(this.separation),e.setViewport(0,0,2*t,i),e.clear(),e.setViewport(0,0,t,i),e.render(c,o),e.setViewport(t,0,t,i),e.render(c,s)}};var Representation3D=function(e,t,i,r,n,a,o,s,c,h,l,d){var p=new THREE.Vector3(0,0,s/2);this.data=e,this.parts={},this.imageList=h,this.sidePoints=t,this.surfaceSidePoints=i,this.renderer=d,this.config=l,this.parts.grid=this.buildGrid(),this.parts.sideR=this.buildSide(this.sidePoints,p,h),this.parts.sideL=this.buildSide(this.sidePoints,p.negate(),h),this.parts.struts=this.buildStruts(r,s,n,a,o),this.parts.surface=this.buildSurface(this.surfaceSidePoints,s),this.parts.board=this.buildBoard(r,s,c);var u=t.slice(0);u.splice(u.length-2);var f=this.buildAnnotations(r,s,o,c,a,n,u);for(key in f)this.parts[key]=f[key];Utils.makeAvailableForDebug("parts",this.parts)};Representation3D.prototype.getParts=function(){return this.parts},Representation3D.prototype.buildGrid=function(){return new Grid},Representation3D.prototype.buildSide=function(e,t,i){var r=new Side(e,t,i);return r},Representation3D.prototype.buildStruts=function(e,t,i,r,n){for(var a,o,s=this.config,c=[],h=t,l=Math.ceil(r/s.model3d.struts.maximumDistance),d=l,p=s.model3d.struts.side,u=(s.model3d.sides.extraLength,s.model3d.sides.minHeight),f=(Math.acos(1-u/n),p/(2*n));d;){var m=i*d/l,E=m*Math.PI/180-f,g=n*(1-Math.cos(E));if(p>g&&(p=s.model3d.struts.smallSide),p>g)break;o=new THREE.Vector3(0,0,0),a=new Strut(h,p,n,E,o,this.imageList),c.push(a),d--}return p=s.model3d.struts.side,o=new THREE.Vector3(e-p,p,0),a=new Strut(h,p,null,null,o,this.imageList),c.push(a),o=new THREE.Vector3(2*e/3,p,0),a=new Strut(h,p,null,null,o,this.imageList),c.push(a),c},Representation3D.prototype.buildSurface=function(e,t){var i=t+2*this.config.model3d.sides.thickness/60,r=new Surface(e,i,this.imageList);return r},Representation3D.prototype.buildSlats=function(e,t,i,r){var n,a,o,s,c,h=this.config,l=h.model3d.slats.defaultLength,d=h.model3d.slats.thickness,p=[],u=0,f=i,m=Math.ceil(f/l),E=0,g=[];for(E=m;E;)u=t*E/m,n=u*Math.PI/180,g.push(u),a=l,f-=a,o=r*Math.sin(n),s=r*(1-Math.cos(n)),c=new THREE.Vector3(o,s,0),p.push(new Slat(e+.125,a,d,u,c,this.imageList)),E--;return p},Representation3D.prototype.buildAnnotations=function(e,t,i,r,n,a,o){var s=this.config,c=.2,h=c,l=new THREE.MeshBasicMaterial({color:16777215}),d=new THREE.LineBasicMaterial({color:16777215,linewidth:2}),p=a*Math.PI/180,u=2,f=e+c*Math.cos(p)-s.model3d.sides.extraLength,m=r+c*Math.sin(p);return{length:new Annotation(Annotation.types.STRAIGHT,{name:"length",origin:new THREE.Vector3(0,-c,t/2),length:e,text:this.getHumanReadableDimension_(e,s.units),textDistance:h,rotation:new THREE.Euler(0,0,0,"XYZ"),material:l,lineMaterial:d,hasStartTip:!0,hasEndTip:!0,switchTextPosition:!1}),width:new Annotation(Annotation.types.STRAIGHT,{name:"width",origin:new THREE.Vector3(f-.02,m,-t/2),length:t,text:this.getHumanReadableDimension_(t,s.units),textDistance:h,rotation:new THREE.Euler(0,-Math.PI/2,0,"XYZ"),material:l,lineMaterial:d,hasStartTip:!0,hasEndTip:!0,switchTextPosition:!0,visibilityFunction:function(e){return"3d"==e.get("repType")&&e.get("annotations")}}),height:new Annotation(Annotation.types.STRAIGHT,{name:"height",origin:new THREE.Vector3(e+c,0,t/2),length:r,text:this.getHumanReadableDimension_(r,s.units),textDistance:h,rotation:new THREE.Euler(0,0,Math.PI/2,"XYZ"),material:l,lineMaterial:d,hasStartTip:!0,hasEndTip:!0,switchTextPosition:!1}),radius:new Annotation(Annotation.types.STRAIGHT,{name:"radius",origin:new THREE.Vector3(0,c,-t/2),length:u-c,text:this.getHumanReadableDimension_(i,s.units),textDistance:h,rotation:new THREE.Euler(0,0,Math.PI/2,"XYZ"),material:l,lineMaterial:d,hasStartTip:!0,hasEndTip:!1,switchTextPosition:!1}),arc:new Annotation(Annotation.types.CURVED,{name:"arc",origin:new THREE.Vector3(0,0,-t/2),
arc:n,angle:a,radius:i,text:this.getHumanReadableDimension_(n,s.units),distance:c,textDistance:h,material:l,lineMaterial:d}),angle:new Annotation(Annotation.types.ANGLE,{name:"angle",origin:new THREE.Vector3(f,m,t/2),angle:a,text:this.getHumanReadableDimension_(a,s.UNIT_DEGREES),cornerSide:.25,textDistance:.1,material:l,lineMaterial:d})}},Representation3D.prototype.getHumanReadableDimension_=function(e,t){if(t==config.UNIT_METERS)return e.toFixed(2)+"m";if(t==config.UNIT_DEGREES)return e.toFixed(0)+"Â°";if(t==config.UNIT_FEET)return Utils.metersToDumb(e);throw new Error("Unit '"+t+"' not supported")},Representation3D.prototype.buildBoard=function(e,t,i){var r=new Board(e,t,i,this.renderer);return r},Representation3D.prototype.setConfig=function(e){this.config=e};var EditorScene=function(){};EditorScene.createCameras=function(e,t){var i=e.parentElement,r=EditorScene.createPerspectiveCamera_(i),n=EditorScene.createOrthoCamera_(i,t);return{perspective:r,ortho:n}},EditorScene.createPerspectiveCamera_=function(e){var t=e.clientWidth/e.clientHeight,i=new THREE.PerspectiveCamera(50,t,1,1e3);return i.position.copy(new THREE.Vector3(-.95,1.64,3.85)),i},EditorScene.createOrthoCamera_=function(e,t){var i,r,n=e.clientWidth/e.clientHeight,a=new BoundingBoxHelper(t),o=.1;a.update(!0);var s=(1+o)*Math.ceil(a.box.max.x-a.box.min.x),c=(1+o)*Math.ceil(a.box.max.y-a.box.min.y),h=(a.box.max.x+a.box.min.x)/2,l=(a.box.max.y+a.box.min.y)/2;s>c?(i=s,r=i/n):(r=c,i=r*n);var d=r,p={viewSize:d,aspectRatio:n,left:h-i/2,right:h+i/2,top:l+r/2,bottom:l-r/2,near:-10,far:10},u=new THREE.OrthographicCamera(p.left,p.right,p.top,p.bottom,p.near,p.far);return u},EditorScene.getScene=function(){var e=new THREE.Scene,t=new THREE.DirectionalLight(16777215);t.position.set(300,10,300),e.add(t);var i=new THREE.DirectionalLight(16777215);return i.position.set(-100,200,-120),e.add(i),e},EditorScene.createKicker=function(e,t,i,r){var n=new THREE.Object3D,a=e.model.create3dObject(t,i,r);return Utils.iterateOverParts(a.parts,function(e){for(a in e.meshes)e.meshes[a]&&n.add(e.meshes[a])}),n},EditorScene.getRenderer=function(e){var t,i={antialias:!0,canvas:e,alpha:!0,preserveDrawingBuffer:!0};return t=window.WebGLRenderingContext?new THREE.WebGLRenderer(i):new THREE.CanvasRenderer(i),t.setPixelRatio(window.devicePixelRatio),t},THREE.OrbitControls=function(e,t){function i(){return 2*Math.PI/60/60*u.autoRotateSpeed}function r(){return Math.pow(.95,u.zoomSpeed)}function n(e){if(u.enabled!==!1){if(e.preventDefault(),0===e.button){if(u.noRotate===!0)return;O=N.ROTATE,m.set(e.clientX,e.clientY)}else if(1===e.button){if(u.noZoom===!0)return;O=N.DOLLY,b.set(e.clientX,e.clientY)}else if(2===e.button){if(u.noPan===!0)return;O=N.PAN,v.set(e.clientX,e.clientY)}u.domElement.addEventListener("mousemove",a,!1),u.domElement.addEventListener("mouseup",o,!1),u.domElement.addEventListener("mouseout",s,!1),u.dispatchEvent(V)}}function a(e){if(u.enabled!==!1){e.preventDefault();var t=u.domElement===document?u.domElement.body:u.domElement;if(O===N.ROTATE){if(u.noRotate===!0)return;E.set(e.clientX,e.clientY),g.subVectors(E,m),u.rotateLeft(2*Math.PI*g.x/t.clientWidth*u.rotateSpeed),u.rotateUp(2*Math.PI*g.y/t.clientHeight*u.rotateSpeed),m.copy(E)}else if(O===N.DOLLY){if(u.noZoom===!0)return;R.set(e.clientX,e.clientY),x.subVectors(R,b),x.y>0?u.dollyIn():u.dollyOut(),b.copy(R)}else if(O===N.PAN){if(u.noPan===!0)return;A.set(e.clientX,e.clientY),y.subVectors(A,v),u.pan(y.x,y.y),v.copy(A)}u.update()}}function o(){u.enabled!==!1&&(u.domElement.removeEventListener("mousemove",a,!1),u.domElement.removeEventListener("mouseup",o,!1),u.domElement.removeEventListener("mouseout",s,!1),u.dispatchEvent(D),O=N.NONE)}function s(){u.enabled!==!1&&(u.domElement.removeEventListener("mousemove",a,!1),u.domElement.removeEventListener("mouseup",o,!1),u.domElement.removeEventListener("mouseout",s,!1),u.dispatchEvent(D),O=N.NONE)}function c(e){if(u.enabled!==!1&&u.noZoom!==!0){e.preventDefault(),e.stopPropagation();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail),t>0?u.dollyOut():u.dollyIn(),u.update(),u.dispatchEvent(V),u.dispatchEvent(D)}}function h(e){if(u.enabled!==!1&&u.noKeys!==!0&&u.noPan!==!0)switch(e.keyCode){case u.keys.UP:u.pan(0,u.keyPanSpeed),u.update();break;case u.keys.BOTTOM:u.pan(0,-u.keyPanSpeed),u.update();break;case u.keys.LEFT:u.pan(u.keyPanSpeed,0),u.update();break;case u.keys.RIGHT:u.pan(-u.keyPanSpeed,0),u.update()}}function l(e){if(u.enabled!==!1){switch(e.touches.length){case 1:if(u.noRotate===!0)return;O=N.TOUCH_ROTATE,m.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(u.noZoom===!0)return;O=N.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,r=Math.sqrt(t*t+i*i);b.set(0,r);break;case 3:if(u.noPan===!0)return;O=N.TOUCH_PAN,v.set(e.touches[0].pageX,e.touches[0].pageY);break;default:O=N.NONE}u.dispatchEvent(V)}}function d(e){if(u.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=u.domElement===document?u.domElement.body:u.domElement;switch(e.touches.length){case 1:if(u.noRotate===!0)return;if(O!==N.TOUCH_ROTATE)return;E.set(e.touches[0].pageX,e.touches[0].pageY),g.subVectors(E,m),u.rotateLeft(2*Math.PI*g.x/t.clientWidth*u.rotateSpeed),u.rotateUp(2*Math.PI*g.y/t.clientHeight*u.rotateSpeed),m.copy(E),u.update();break;case 2:if(u.noZoom===!0)return;if(O!==N.TOUCH_DOLLY)return;var i=e.touches[0].pageX-e.touches[1].pageX,r=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(i*i+r*r);R.set(0,n),x.subVectors(R,b),x.y>0?u.dollyOut():u.dollyIn(),b.copy(R),u.update();break;case 3:if(u.noPan===!0)return;if(O!==N.TOUCH_PAN)return;A.set(e.touches[0].pageX,e.touches[0].pageY),y.subVectors(A,v),u.pan(y.x,y.y),v.copy(A),u.update();break;default:O=N.NONE}}}function p(){u.enabled!==!1&&(u.dispatchEvent(D),O=N.NONE)}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var u=this,f=1e-6,m=new THREE.Vector2,E=new THREE.Vector2,g=new THREE.Vector2,v=new THREE.Vector2,A=new THREE.Vector2,y=new THREE.Vector2,w=new THREE.Vector3,T=new THREE.Vector3,b=new THREE.Vector2,R=new THREE.Vector2,x=new THREE.Vector2,S=0,H=0,M=1,C=new THREE.Vector3,k=new THREE.Vector3,N={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},O=N.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone();var B=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),j=B.clone().inverse(),L={type:"change"},V={type:"start"},D={type:"end"};this.rotateLeft=function(e){void 0===e&&(e=i()),H-=e},this.rotateUp=function(e){void 0===e&&(e=i()),S-=e},this.panLeft=function(e){var t=this.object.matrix.elements;w.set(t[0],t[1],t[2]),w.multiplyScalar(-e),C.add(w)},this.panUp=function(e){var t=this.object.matrix.elements;w.set(t[4],t[5],t[6]),w.multiplyScalar(e),C.add(w)},this.pan=function(e,t){var i=u.domElement===document?u.domElement.body:u.domElement;if(void 0!==u.object.fov){var r=u.object.position,n=r.clone().sub(u.target),a=n.length();a*=Math.tan(u.object.fov/2*Math.PI/180),u.panLeft(2*e*a/i.clientHeight),u.panUp(2*t*a/i.clientHeight)}else void 0!==u.object.top?(u.panLeft(e*(u.object.right-u.object.left)/i.clientWidth),u.panUp(t*(u.object.top-u.object.bottom)/i.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(e){void 0===e&&(e=r()),M/=e},this.dollyOut=function(e){void 0===e&&(e=r()),M*=e},this.update=function(){var e=this.object.position;T.copy(e).sub(this.target),T.applyQuaternion(B);var t=Math.atan2(T.x,T.z),r=Math.atan2(Math.sqrt(T.x*T.x+T.z*T.z),T.y);this.autoRotate&&this.rotateLeft(i()),t+=H,r+=S,r=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,r)),r=Math.max(f,Math.min(Math.PI-f,r));var n=T.length()*M;n=Math.max(this.minDistance,Math.min(this.maxDistance,n)),this.target.add(C),T.x=n*Math.sin(r)*Math.sin(t),T.y=n*Math.cos(r),T.z=n*Math.sin(r)*Math.cos(t),T.applyQuaternion(j),e.copy(this.target).add(T),this.object.lookAt(this.target),H=0,S=0,M=1,C.set(0,0,0),k.distanceToSquared(this.object.position)>f&&(this.dispatchEvent(L),k.copy(this.object.position))},this.reset=function(){O=N.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.update()},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",n,!1),this.domElement.addEventListener("mousewheel",c,!1),this.domElement.addEventListener("DOMMouseScroll",c,!1),this.domElement.addEventListener("touchstart",l,!1),this.domElement.addEventListener("touchend",p,!1),this.domElement.addEventListener("touchmove",d,!1),window.addEventListener("keydown",h,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype);var Part=function(){this.meshes={"2d":null,"3d":null}};Part.prototype.setMeshVisibilityForDisplay=function(e){var t=e.get("repType");for(rep in this.meshes)this.meshes[rep]&&(this.meshes[rep].visible=!1);"2d"!=t&&e.get("textured")?this.meshes["3d"]&&(this.meshes["3d"].visible=!0):this.meshes["2d"]&&(this.meshes["2d"].visible=!0),this.edges&&(this.edges.material.linewidth="2d"==t?2:1)},Part.prototype.createGhostFor=function(e){var t=Math.PI,i=new THREE.Object3D;return this.edges=new THREE.EdgesHelper(e,16317183,t),i.add(this.edges),i},Part.prototype.getTexture=function(e){return THREE.ImageUtils.crossOrigin="anonymous",THREE.ImageUtils.loadTexture(e,void 0,this.requestRedraw_.bind(this))},Part.prototype.requestRedraw_=function(){var e=new CustomEvent("renderer-event",{detail:{type:"redraw"}});document.body.dispatchEvent(e)};var Angle=function(e,t,i,r){this.origin=e,this.angleDeg=t,this.angleRad=t*Math.PI/180,this.material=r;var n=new THREE.Object3D;n.add(this.createCorner_(i));var a=.6*i;n.add(this.createArc_(a,12)),this.mesh=n};Angle.prototype.createCorner_=function(e){var t=new THREE.Geometry;t.vertices=[new THREE.Vector3(e,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(e*Math.cos(this.angleRad),e*Math.sin(this.angleRad),0)];var i=new THREE.Line(t,this.material);return i.name="angleCorner",i},Angle.prototype.createArc_=function(e,t){for(var i=new THREE.Geometry,r=0;t>=r;r++)i.vertices.push(new THREE.Vector3(e*Math.cos(this.angleRad*r/t),e*Math.sin(this.angleRad*r/t),0));var n=new THREE.Line(i,this.material);return n.name="angleArc",n};var Annotation=function(e,t){Part.call(this);var i;switch(t.visibilityFunction?this.visibilityFunction_=t.visibilityFunction:this.visibilityFunction_=null,e){case Annotation.types.STRAIGHT:i=this.getStraight_(t);break;case Annotation.types.CURVED:i=this.getCurved_(t);break;case Annotation.types.ANGLE:i=this.getAngle_(t);break;default:throw new Error("Annotation type not supported: "+e)}this.meshes["3d"]=null,this.meshes["2d"]=i};Annotation.prototype=new Part,Annotation.prototype.setMeshVisibilityForDisplay=function(e){var t;t=this.visibilityFunction_?this.visibilityFunction_(e):e.get("annotations"),this.meshes["2d"].visible=t},Annotation.prototype.getStraight_=function(e){var t=new THREE.Object3D;t.name=e.name;var i=new Arrow(e.length,e.lineMaterial,e.hasStartTip,e.hasEndTip),r=new Text(e.text,e.material),n=(e.switchTextPosition?1:-1)*e.textDistance;return r.mesh.position.copy(new THREE.Vector3(e.length/2+r.offsetX,n,0)),t.add(i.mesh),t.add(r.mesh),t.position.copy(e.origin),t.rotation.copy(e.rotation),t},Annotation.prototype.getCurved_=function(e){var t=new THREE.Object3D;t.name=e.name;var i=new CurvedArrow(e.arc,e.angle,e.radius,e.distance,e.lineMaterial),r=i.points;t.add(i.mesh);var n=new Text(e.text,e.material);t.add(n.mesh);var a=e.angle*Math.PI/180;return n.mesh.rotation.z=a/2,n.mesh.position.x=(r[0][0]+r[r.length-1][0])/2+n.offsetX/2,n.mesh.position.y=(r[0][1]+r[r.length-1][1])/2-.15,t.position.copy(e.origin),t},Annotation.prototype.getAngle_=function(e){var t=new THREE.Object3D;t.name=e.name;var i=new Angle(e.origin,e.angle,e.cornerSide,e.lineMaterial);t.add(i.mesh);var r=new Text(e.text,e.material);return r.mesh.position.copy(new THREE.Vector3(e.cornerSide,e.textDistance,0)),t.add(r.mesh),t.position.copy(e.origin),t},Annotation.types={STRAIGHT:"STRAIGHT",CURVED:"CURVED",ANGLE:"ANGLE"};var Arrow=function(e,t,i,r){this.start=new THREE.Vector3(0,0,0),this.end=new THREE.Vector3(e,0,0),this.material=t;var n=new THREE.Object3D,a=.1;if(i){var o=this.createStartTip(a,t);n.add(o)}var s=this.createLine();if(n.add(s),r){var c=this.createEndTip(a,e,t);n.add(c)}this.mesh=n};Arrow.prototype.createLine=function(){var e=new THREE.Geometry;e.vertices.push(this.start),e.vertices.push(this.end);var t=new THREE.Line(e,this.material);return t},Arrow.prototype.createStartTip=function(e,t){var i=new THREE.Vector3(e,-e/2,0),r=new THREE.Vector3(0,0,0),n=new THREE.Vector3(e,e/2,0),a=new THREE.Geometry;a.vertices.push(i),a.vertices.push(r),a.vertices.push(n);var o=new THREE.Line(a,t);return o},Arrow.prototype.createEndTip=function(e,t,i){var r=new THREE.Vector3(-e+t,-e/2,0),n=new THREE.Vector3(t,0,0),a=new THREE.Vector3(-e+t,e/2,0),o=new THREE.Geometry;o.vertices.push(r),o.vertices.push(n),o.vertices.push(a);var s=new THREE.Line(o,i);return s};var Board=function(e,t,i,r){Part.call(this),this.length=e,this.width=t,this.height=i,this.renderer=r,this.createMeshes()};Board.prototype=new Part,Board.prototype.createMeshes=function(){var e=this.renderer.getModel("board");if(!e.name){var t=new THREE.ColladaLoader;t.options.convertUpAxis=!0,t.load(BIHI.lazyLoadingFiles.board,this.onBoardLoaded.bind(this))}var i=.5,r=.1;z=this.width/2+1,e.position.set(i,r,z),e.scale.set(.5,.5,.5),e.rotation.set(0,10*Math.PI/64,0),this.meshes["3d"]=e,this.meshes["2d"]=e},Board.prototype.onBoardLoaded=function(e){var t=e.scene;t.name="mountainboard",this.renderer.replaceModel("board",t),this.createMeshes()},Board.prototype.setMeshVisibilityForDisplay=function(e){var t=e.get("repType");this.meshes["2d"].visible=!1,this.meshes["3d"].visible="3d"==t&&e.get("mountainboard")};var CurvedArrow=function(e,t,i,r,n){var a=5,o=this.calculatePoints(a,t,i,r),s=new THREE.Object3D,c=.05,h=this.createStartTip(o[0],c,n);s.add(h);var l=this.createLine(o,n);s.add(l);var d=this.createEndTip(o[o.length-1],c,e-.05,t+a,n);s.add(d),this.mesh=s,this.points=o};CurvedArrow.prototype.createLine=function(e,t){var i=new THREE.Geometry;e.forEach(function(e){i.vertices.push(new THREE.Vector3(e[0],e[1],0))});var r=new THREE.Line(i,t);return r},CurvedArrow.prototype.createStartTip=function(e,t,i){var r=new THREE.Vector3(t+e[0],-t/2+e[1],0),n=new THREE.Vector3(0+e[0],0+e[1],0),a=new THREE.Vector3(t+e[0],t/2+e[1],0),o=new THREE.Geometry;o.vertices.push(r),o.vertices.push(n),o.vertices.push(a);var s=new THREE.Line(o,i);return s},CurvedArrow.prototype.createEndTip=function(e,t,i,r,n){var a=r*Math.PI/180,o=new THREE.Euler(0,0,a,"XYZ"),s=new THREE.Geometry;s.vertices.push(new THREE.Vector3(-t,-t/2,0)),s.vertices.push(new THREE.Vector3(0,0,0)),s.vertices.push(new THREE.Vector3(-t,+t/2,0)),s.vertices.forEach(function(t){t.applyEuler(o),t.add(new THREE.Vector3(e[0],e[1]))});var c=new THREE.Line(s,n);return c},CurvedArrow.prototype.calculatePoints=function(e,t,i,r){for(var n,a,o,s=[],c=i-r,h=config.model3d.sides.extraLength,l=e*Math.PI/180,d=t*Math.PI/180,p=20,u=0;p>=u;u++)n=u/p*(d-l)+l,a=c*Math.sin(n),o=c*(1-Math.cos(n)),s.push([a,o]);return s.forEach(function(e){e[0]-=h,e[1]+=r}),s};var Grid=function(e,t){Part.call(this),this.meshes["2d"]=null,this.meshes["3d"]=this.createGrid_()};Grid.prototype=new Part,Grid.prototype.setMeshVisibilityForDisplay=function(e){this.meshes["3d"].visible=e.get("grid")&&"3d"==e.get("repType")},Grid.prototype.createGrid_=function(){var e=new THREE.GridHelper(100,1);return e.setColors(16317183,67653),e.name="grid",e};var Side=function(e,t,i){Part.call(this),this.points=e,this.imageList=i;var r=this.createMesh(e,t);this.meshes["3d"]=r,this.meshes["2d"]=this.createGhostFor(r)};Side.prototype=new Part,Side.prototype.createMesh=function(e,t){var i=this.buildGeometry(e,t),r=this.getTexture(this.imageList.getImageUrl("side")),n=new THREE.MeshLambertMaterial({map:r}),a=new THREE.Mesh(i,n);return a.name="Side",a.randomId=100*Math.random(),a},Side.prototype.buildGeometry=function(e,t){var i,r,n=new THREE.Shape;for(n.moveTo(e[0][0],e[0][1]),i=1,r=e.length;r>i;i++)n.lineTo(e[i][0],e[i][1]);var a={amount:config.model3d.sides.thickness,bevelSize:0,bevelSegments:1,bevelThickness:0},o=new THREE.ExtrudeGeometry(n,a);Utils.setupUVMapping(o);var s=new THREE.Vector3;return s.z=-config.model3d.sides.thickness/2,s=s.add(t),o.vertices.forEach(function(e){e.add(s)}),o};var Slat=function(e,t,i,r,n,a){this.length=t,this.thickness=i,this.imageList=a,this.mesh=this.createMesh(e,t,i,60);var o=Math.PI*r/180;this.mesh.rotateOnAxis(new THREE.Vector3(0,0,1),o),this.mesh.position=n};Slat.prototype.createMesh=function(e,t,i,r){var n=this.buildGeometry(e,t,i,r),a=new THREE.MeshLambertMaterial({map:this.getTexture(this.imageList.getImageUrl("slat"))}),o=new THREE.Mesh(n,a);return o.name="Slat",o},Slat.prototype.buildGeometry=function(e,t,i,r){var n=config.model3d.slats.space,a=(t-n)*r,o=i*r;z=e*r;var s=new THREE.BoxGeometry(a,o,z),c=new THREE.Vector3(-a/2,o/2,0);return s.vertices.forEach(function(e){e.add(c)}),s};var Strut=function(e,t,i,r,n,a){Part.call(this),this.thickness=t,this.imageList=a;var o=this.createMesh(e,t,i,r,n);this.meshes["3d"]=o,this.meshes["2d"]=this.createGhostFor(o)};Strut.prototype=new Part,Strut.prototype.createMesh=function(e,t,i,r,n){var a=this.buildGeometry(e,t),o=new THREE.MeshLambertMaterial({map:this.getTexture(this.imageList.getImageUrl("strut"))}),s=new THREE.Mesh(a,o);return s.name="Strut",i&&this.positionByAngle(s,i,r),n&&this.applyOffset(s,n),s},Strut.prototype.buildGeometry=function(e,t){var i=new THREE.BoxGeometry(t,t,e);return i},Strut.prototype.positionByAngle=function(e,t,i){var r=new THREE.Vector3(0,-t-this.thickness/2,0),n=new THREE.Vector3(0,t,0);e.geometry.vertices.forEach(function(e){e.add(r);var t=new THREE.Matrix4;t.set(Math.cos(-i),Math.sin(-i),0,0,-Math.sin(-i),Math.cos(-i),0,0,0,0,1,0,0,0,0,1),e.applyMatrix4(t),e.add(n)})},Strut.prototype.applyOffset=function(e,t){e.geometry.vertices.forEach(function(e){e.add(t)})};var Surface=function(e,t,i){Part.call(this),this.points=e.slice(0),this.width=t,this.imageList=i;var r=this.createMesh(this.points,t+2*config.model3d.sides.thickness);this.meshes["3d"]=r,this.meshes["2d"]=this.createGhostFor(r)};Surface.prototype=new Part,Surface.prototype.createMesh=function(e,t){var i=this.buildGeometry(e,t),r=this.getTexture(this.imageList.getImageUrl("side")),n=new THREE.MeshLambertMaterial({map:r}),a=new THREE.Mesh(i,n);return a.name="Surface",a},Surface.prototype.buildGeometry=function(e,t){var i=new THREE.Shape;i.moveTo(e[0][0],e[0][1]);for(var r=1,n=e.length;n>r;r++)i.lineTo(e[r][0],e[r][1]);var a={amount:t,bevelSize:0,bevelSegments:1,bevelThickness:0},o=new THREE.ExtrudeGeometry(i,a),s=new THREE.Vector3(0,0,-t/2);return o.vertices.forEach(function(e){e.add(s)}),Utils.setupUVMapping(o,"z","y"),o};var Text=function(e,t){this.mesh=this.createMesh(e,t)};Text.prototype.createMesh=function(e,t){var i=this.buildGeometry(e),r=new THREE.Mesh(i,t);r.name="Text -  - "+e;var n=i.boundingBox,a=n.max.sub(n.min);return this.offsetX=-a.x/2,this.offsetY=-a.y/2,r},Text.prototype.buildGeometry=function(e){var t=new THREE.TextGeometry(e,{size:.15,height:0,font:"archer medium"});return t.computeBoundingBox(),t},Box=function(e,t){THREE.Box3.call(this,e,t)},Box.prototype=Object.create(THREE.Box3.prototype),Box.prototype.constructor=Box,Box.prototype.setFromObject=function(){var e=new THREE.Vector3;return function(t,i){var r=this;return t.updateMatrixWorld(!0),this.makeEmpty(),t.traverse(function(t){if(!i||t.visible){var n=t.geometry;if(void 0!==n)if(n instanceof THREE.Geometry)for(var a=n.vertices,o=0,s=a.length;s>o;o++)e.copy(a[o]),e.applyMatrix4(t.matrixWorld),r.expandByPoint(e);else if(n instanceof THREE.BufferGeometry&&void 0!==n.attributes.position)for(var c=n.attributes.position.array,o=0,s=c.length;s>o;o+=3)e.set(c[o],c[o+1],c[o+2]),e.applyMatrix4(t.matrixWorld),r.expandByPoint(e)}}),this}}(),BoundingBoxHelper=function(e,t){var i=void 0!==t?t:8947848;this.object=e,this.box=new Box,THREE.Mesh.call(this,new THREE.BoxGeometry(1,1,1),new THREE.MeshBasicMaterial({color:i,wireframe:!0}))},BoundingBoxHelper.prototype=Object.create(THREE.Mesh.prototype),BoundingBoxHelper.prototype.constructor=THREE.BoundingBoxHelper,BoundingBoxHelper.prototype.update=function(e){this.box.setFromObject(this.object,e),this.box.size(this.scale),this.box.center(this.position)},THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(e,t){},this.setValues(e)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;return THREE.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.program=this.program,e},THREE.CanvasRenderer=function(e){function t(){Ae.setRGB(0,0,0),ye.setRGB(0,0,0),we.setRGB(0,0,0);for(var e=0,t=R.length;t>e;e++){var i=R[e],r=i.color;i instanceof THREE.AmbientLight?Ae.add(r):i instanceof THREE.DirectionalLight?ye.add(r):i instanceof THREE.PointLight&&we.add(r)}}function i(e,t,i){for(var r=0,n=R.length;n>r;r++){var a=R[r];if(fe.copy(a.color),a instanceof THREE.DirectionalLight){var o=Te.setFromMatrixPosition(a.matrixWorld).normalize(),s=t.dot(o);if(0>=s)continue;s*=a.intensity,i.add(fe.multiplyScalar(s))}else if(a instanceof THREE.PointLight){var o=Te.setFromMatrixPosition(a.matrixWorld),s=t.dot(Te.subVectors(o,e).normalize());if(0>=s)continue;if(s*=0==a.distance?1:1-Math.min(e.distanceTo(o)/a.distance,1),0==s)continue;s*=a.intensity,i.add(fe.multiplyScalar(s))}}}function r(e,t,i){u(i.opacity),f(i.blending);var r=t.scale.x*G,n=t.scale.y*W,a=.5*Math.sqrt(r*r+n*n);if(ve.min.set(e.x-a,e.y-a),ve.max.set(e.x+a,e.y+a),i instanceof THREE.SpriteMaterial){var o=i.map;if(null!==o&&void 0!==o.image){o.hasEventListener("update",h)===!1&&(o.image.width>0&&l(o),o.addEventListener("update",h));var s=me[o.id];A(void 0!==s?s:"rgba( 0, 0, 0, 1 )");var c=o.image,d=c.width*o.offset.x,p=c.height*o.offset.y,m=c.width*o.repeat.x,E=c.height*o.repeat.y,g=r/m,y=n/E;ee.save(),ee.translate(e.x,e.y),0!==i.rotation&&ee.rotate(i.rotation),ee.translate(-r/2,-n/2),ee.scale(g,y),ee.translate(-d,-p),ee.fillRect(d,p,m,E),ee.restore()}else A(i.color.getStyle()),ee.save(),ee.translate(e.x,e.y),0!==i.rotation&&ee.rotate(i.rotation),ee.scale(r,-n),ee.fillRect(-.5,-.5,1,1),ee.restore()}else i instanceof THREE.SpriteCanvasMaterial&&(v(i.color.getStyle()),A(i.color.getStyle()),ee.save(),ee.translate(e.x,e.y),0!==i.rotation&&ee.rotate(i.rotation),ee.scale(r,n),i.program(ee),ee.restore())}function n(e,t,i,r){if(u(r.opacity),f(r.blending),ee.beginPath(),ee.moveTo(e.positionScreen.x,e.positionScreen.y),ee.lineTo(t.positionScreen.x,t.positionScreen.y),r instanceof THREE.LineBasicMaterial){if(m(r.linewidth),E(r.linecap),g(r.linejoin),r.vertexColors!==THREE.VertexColors)v(r.color.getStyle());else{var n=i.vertexColors[0].getStyle(),a=i.vertexColors[1].getStyle();if(n===a)v(n);else{try{var o=ee.createLinearGradient(e.positionScreen.x,e.positionScreen.y,t.positionScreen.x,t.positionScreen.y);o.addColorStop(0,n),o.addColorStop(1,a)}catch(s){o=n}v(o)}}ee.stroke(),ve.expandByScalar(2*r.linewidth)}else r instanceof THREE.LineDashedMaterial&&(m(r.linewidth),E(r.linecap),g(r.linejoin),v(r.color.getStyle()),y([r.dashSize,r.gapSize]),ee.stroke(),ve.expandByScalar(2*r.linewidth),y([]))}function a(e,t,r,n,a,h,l,p){if(z.info.render.vertices+=3,z.info.render.faces++,u(p.opacity),f(p.blending),C=e.positionScreen.x,k=e.positionScreen.y,N=t.positionScreen.x,O=t.positionScreen.y,B=r.positionScreen.x,j=r.positionScreen.y,o(C,k,N,O,B,j),(p instanceof THREE.MeshLambertMaterial||p instanceof THREE.MeshPhongMaterial)&&null===p.map)pe.copy(p.color),ue.copy(p.emissive),p.vertexColors===THREE.FaceColors&&pe.multiply(l.color),de.copy(Ae),be.copy(e.positionWorld).add(t.positionWorld).add(r.positionWorld).divideScalar(3),i(be,l.normalModel,de),de.multiply(pe).add(ue),p.wireframe===!0?s(de,p.wireframeLinewidth,p.wireframeLinecap,p.wireframeLinejoin):c(de);else if(p instanceof THREE.MeshBasicMaterial||p instanceof THREE.MeshLambertMaterial||p instanceof THREE.MeshPhongMaterial)if(null!==p.map){var m=p.map.mapping;m===THREE.UVMapping&&(L=l.uvs,d(C,k,N,O,B,j,L[n].x,L[n].y,L[a].x,L[a].y,L[h].x,L[h].y,p.map))}else null!==p.envMap?p.envMap.mapping===THREE.SphericalReflectionMapping&&(Re.copy(l.vertexNormalsModel[n]).applyMatrix3(xe),V=.5*Re.x+.5,D=.5*Re.y+.5,Re.copy(l.vertexNormalsModel[a]).applyMatrix3(xe),_=.5*Re.x+.5,I=.5*Re.y+.5,Re.copy(l.vertexNormalsModel[h]).applyMatrix3(xe),P=.5*Re.x+.5,q=.5*Re.y+.5,d(C,k,N,O,B,j,V,D,_,I,P,q,p.envMap)):(de.copy(p.color),p.vertexColors===THREE.FaceColors&&de.multiply(l.color),p.wireframe===!0?s(de,p.wireframeLinewidth,p.wireframeLinecap,p.wireframeLinejoin):c(de));else p instanceof THREE.MeshDepthMaterial?(de.r=de.g=de.b=1-w(e.positionScreen.z*e.positionScreen.w,x.near,x.far),p.wireframe===!0?s(de,p.wireframeLinewidth,p.wireframeLinecap,p.wireframeLinejoin):c(de)):p instanceof THREE.MeshNormalMaterial?(Re.copy(l.normalModel).applyMatrix3(xe),de.setRGB(Re.x,Re.y,Re.z).multiplyScalar(.5).addScalar(.5),p.wireframe===!0?s(de,p.wireframeLinewidth,p.wireframeLinecap,p.wireframeLinejoin):c(de)):(de.setRGB(1,1,1),p.wireframe===!0?s(de,p.wireframeLinewidth,p.wireframeLinecap,p.wireframeLinejoin):c(de))}function o(e,t,i,r,n,a){ee.beginPath(),ee.moveTo(e,t),ee.lineTo(i,r),ee.lineTo(n,a),ee.closePath()}function s(e,t,i,r){m(t),E(i),g(r),v(e.getStyle()),ee.stroke(),ve.expandByScalar(2*t)}function c(e){A(e.getStyle()),ee.fill()}function h(e){l(e.target)}function l(e){if(!(e instanceof THREE.CompressedTexture)){var t=e.wrapS===THREE.RepeatWrapping,i=e.wrapT===THREE.RepeatWrapping,r=e.image,n=document.createElement("canvas");n.width=r.width,n.height=r.height;var a=n.getContext("2d");a.setTransform(1,0,0,-1,0,r.height),a.drawImage(r,0,0),me[e.id]=ee.createPattern(n,t===!0&&i===!0?"repeat":t===!0&&i===!1?"repeat-x":t===!1&&i===!0?"repeat-y":"no-repeat")}}function d(e,t,i,r,n,a,o,s,c,d,p,u,f){if(!(f instanceof THREE.DataTexture)){f.hasEventListener("update",h)===!1&&(void 0!==f.image&&f.image.width>0&&l(f),f.addEventListener("update",h));var m=me[f.id];if(void 0===m)return A("rgba(0,0,0,1)"),void ee.fill();A(m);var E,g,v,y,w,T,b,R,x=f.offset.x/f.repeat.x,S=f.offset.y/f.repeat.y,H=f.image.width*f.repeat.x,M=f.image.height*f.repeat.y;o=(o+x)*H,s=(s+S)*M,c=(c+x)*H,d=(d+S)*M,p=(p+x)*H,u=(u+S)*M,i-=e,r-=t,n-=e,a-=t,c-=o,d-=s,p-=o,u-=s,b=c*u-p*d,0!==b&&(R=1/b,E=(u*i-d*n)*R,g=(u*r-d*a)*R,v=(c*n-p*i)*R,y=(c*a-p*r)*R,w=e-E*o-v*s,T=t-g*o-y*s,ee.save(),ee.transform(E,g,v,y,w,T),ee.fill(),ee.restore())}}function p(e,t,i){var r,n=t.x-e.x,a=t.y-e.y,o=n*n+a*a;0!==o&&(r=i/Math.sqrt(o),n*=r,a*=r,t.x+=n,t.y+=a,e.x-=n,e.y-=a)}function u(e){re!==e&&(ee.globalAlpha=e,re=e)}function f(e){ne!==e&&(e===THREE.NormalBlending?ee.globalCompositeOperation="source-over":e===THREE.AdditiveBlending?ee.globalCompositeOperation="lighter":e===THREE.SubtractiveBlending&&(ee.globalCompositeOperation="darker"),ne=e)}function m(e){se!==e&&(ee.lineWidth=e,se=e)}function E(e){ce!==e&&(ee.lineCap=e,ce=e)}function g(e){he!==e&&(ee.lineJoin=e,he=e)}function v(e){ae!==e&&(ee.strokeStyle=e,ae=e)}function A(e){oe!==e&&(ee.fillStyle=e,oe=e)}function y(e){le.length!==e.length&&(ee.setLineDash(e),le=e)}console.log("THREE.CanvasRenderer",THREE.REVISION);var w=THREE.Math.smoothstep;e=e||{};var T,b,R,x,S,H,M,C,k,N,O,B,j,L,V,D,_,I,P,q,z=this,F=new THREE.Projector,U=void 0!==e.canvas?e.canvas:document.createElement("canvas"),K=U.width,Y=U.height,G=Math.floor(K/2),W=Math.floor(Y/2),Q=0,X=0,J=K,Z=Y,$=1,ee=U.getContext("2d",{alpha:e.alpha===!0}),te=new THREE.Color(0),ie=e.alpha===!0?0:1,re=1,ne=0,ae=null,oe=null,se=null,ce=null,he=null,le=[],de=(new THREE.RenderableVertex,new THREE.RenderableVertex,new THREE.Color),pe=(new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color),ue=new THREE.Color,fe=new THREE.Color,me={},Ee=new THREE.Box2,ge=new THREE.Box2,ve=new THREE.Box2,Ae=new THREE.Color,ye=new THREE.Color,we=new THREE.Color,Te=new THREE.Vector3,be=new THREE.Vector3,Re=new THREE.Vector3,xe=new THREE.Matrix3;void 0===ee.setLineDash&&(ee.setLineDash=function(){}),this.domElement=U,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getPixelRatio=function(){return $},this.setPixelRatio=function(e){$=e},this.setSize=function(e,t,i){K=e*$,Y=t*$,U.width=K,U.height=Y,G=Math.floor(K/2),W=Math.floor(Y/2),i!==!1&&(U.style.width=e+"px",U.style.height=t+"px"),Ee.min.set(-G,-W),Ee.max.set(G,W),ge.min.set(-G,-W),ge.max.set(G,W),re=1,ne=0,ae=null,oe=null,se=null,ce=null,he=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,r){Q=e*$,X=t*$,J=i*$,Z=r*$},this.setScissor=function(){},this.enableScissorTest=function(){},this.setClearColor=function(e,t){te.set(e),ie=void 0!==t?t:1,ge.min.set(-G,-W),ge.max.set(G,W)},this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return te},this.getClearAlpha=function(){return ie},this.getMaxAnisotropy=function(){return 0},this.clear=function(){ge.empty()===!1&&(ge.intersect(Ee),ge.expandByScalar(2),ge.min.x=ge.min.x+G,ge.min.y=-ge.min.y+W,ge.max.x=ge.max.x+G,ge.max.y=-ge.max.y+W,1>ie&&ee.clearRect(0|ge.min.x,0|ge.max.y,ge.max.x-ge.min.x|0,ge.min.y-ge.max.y|0),ie>0&&(f(THREE.NormalBlending),u(1),A("rgba("+Math.floor(255*te.r)+","+Math.floor(255*te.g)+","+Math.floor(255*te.b)+","+ie+")"),ee.fillRect(0|ge.min.x,0|ge.max.y,ge.max.x-ge.min.x|0,ge.min.y-ge.max.y|0)),ge.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,i){if(i instanceof THREE.Camera==!1)return void console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");this.autoClear===!0&&this.clear(),z.info.render.vertices=0,z.info.render.faces=0,ee.setTransform(J/K,0,0,-Z/Y,Q,Y-X),ee.translate(G,W),T=F.projectScene(e,i,this.sortObjects,this.sortElements),b=T.elements,R=T.lights,x=i,xe.getNormalMatrix(i.matrixWorldInverse),t();for(var o=0,s=b.length;s>o;o++){var c=b[o],h=c.material;if(void 0!==h&&0!==h.opacity){if(ve.makeEmpty(),c instanceof THREE.RenderableSprite)S=c,S.x*=G,S.y*=W,r(S,c,h);else if(c instanceof THREE.RenderableLine)S=c.v1,H=c.v2,S.positionScreen.x*=G,S.positionScreen.y*=W,H.positionScreen.x*=G,H.positionScreen.y*=W,ve.setFromPoints([S.positionScreen,H.positionScreen]),Ee.isIntersectionBox(ve)===!0&&n(S,H,c,h);else if(c instanceof THREE.RenderableFace){if(S=c.v1,H=c.v2,M=c.v3,S.positionScreen.z<-1||S.positionScreen.z>1)continue;if(H.positionScreen.z<-1||H.positionScreen.z>1)continue;if(M.positionScreen.z<-1||M.positionScreen.z>1)continue;S.positionScreen.x*=G,S.positionScreen.y*=W,H.positionScreen.x*=G,H.positionScreen.y*=W,M.positionScreen.x*=G,M.positionScreen.y*=W,h.overdraw>0&&(p(S.positionScreen,H.positionScreen,h.overdraw),p(H.positionScreen,M.positionScreen,h.overdraw),p(M.positionScreen,S.positionScreen,h.overdraw)),ve.setFromPoints([S.positionScreen,H.positionScreen,M.positionScreen]),Ee.isIntersectionBox(ve)===!0&&a(S,H,M,0,1,2,c,h)}ge.union(ve)}}ee.setTransform(1,0,0,1,0,0)};
},THREE.SoftwareRenderer=function(e){function t(){for(var e=l*d*4,t=0;e>t;t+=4)w[t]=255*k.r|0,w[t+1]=255*k.g|0,w[t+2]=255*k.b|0,w[t+3]=255;H.fillStyle=k.getStyle(),H.fillRect(0,0,l,d)}function i(e,t){var i=0,r=0,n=255*e.color.r,a=255*e.color.g,o=255*e.color.b,s=new Uint8Array(768);if(t){for(;204>i;)s[r++]=Math.min(i*n/204,255),s[r++]=Math.min(i*a/204,255),s[r++]=Math.min(i*o/204,255),++i;for(;256>i;)s[r++]=Math.min(n+(i-204)*(255-n)/82,255),s[r++]=Math.min(a+(i-204)*(255-a)/82,255),s[r++]=Math.min(o+(i-204)*(255-o)/82,255),++i}else for(;256>i;)s[r++]=Math.min(i*n/255,255),s[r++]=Math.min(i*a/255,255),s[r++]=Math.min(i*o/255,255),++i;return s}function r(e,t,i,r,n,a,o,s,c){var h=4*i,l=C[c.map.id];if(l.data){var d=l.width,p=c.transparent,u=d-1,f=l.data,m=4*((a*d&u)*d+(n*d&u));if(p){var E=f[m+3]*c.opacity,g=(f[m]<<16)+(f[m+1]<<8)+f[m+2];if(250>E){var v=(e[h]<<16)+(e[h+1]<<8)+e[h+2];g=g*E+v*(1-E)}e[h]=(16711680&g)>>16,e[h+1]=(65280&g)>>8,e[h+2]=255&g,e[h+3]=255*c.opacity}else e[h]=f[m],e[h+1]=f[m+1],e[h+2]=f[m+2],e[h+3]=255*c.opacity,t[i]=r}}function n(e,t,i,r,n,a,o,s,c){var h=4*i,l=C[c.map.id];if(l.data){var d=l.width,p=c.transparent,u=3*(o>0?~~o:0),f=d-1,m=l.data,E=4*((a*d&f)*d+(n*d&f));if(p){var g=m[E+3]*c.opacity,v=(c.palette[u]*m[E]<<16)+(c.palette[u+1]*m[E+1]<<8)+c.palette[u+2]*m[E+2];if(250>g){var A=e[h]<<24+e[h+1]<<16+e[h+2]<<8;v=v*g+A*(1-g)}e[h]=(16711680&v)>>16,e[h+1]=(65280&v)>>8,e[h+2]=255&v,e[h+3]=255*c.opacity}else e[h]=c.palette[u]*m[E]>>8,e[h+1]=c.palette[u+1]*m[E+1]>>8,e[h+2]=c.palette[u+2]*m[E+2]>>8,e[h+3]=255*c.opacity,t[i]=r}}function a(e){var t=e.target;t.removeEventListener("update",a),delete M[t.id]}function o(e){var t=e.id,o=M[t];if(void 0===M[t]){if(e.addEventListener("update",a),e instanceof THREE.MeshBasicMaterial||e instanceof THREE.MeshLambertMaterial||e instanceof THREE.MeshPhongMaterial||e instanceof THREE.SpriteMaterial){e instanceof THREE.MeshLambertMaterial?e.palette||(e.palette=i(e,!1)):e instanceof THREE.MeshPhongMaterial&&(e.palette||(e.palette=i(e,!0)));var s;if(e.map){var c=new THREE.SoftwareRenderer.Texture;c.fromImage(e.map.image),e.map.addEventListener("update",function(e){c.fromImage(e.target.image)}),C[e.map.id]=c,o=e instanceof THREE.MeshBasicMaterial||e instanceof THREE.SpriteMaterial?r:n}else s=e.vertexColors===THREE.FaceColors?["var colorOffset = offset * 4;","buffer[ colorOffset ] = face.color.r * 255;","buffer[ colorOffset + 1 ] = face.color.g * 255;","buffer[ colorOffset + 2 ] = face.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n"):["var colorOffset = offset * 4;","buffer[ colorOffset ] = material.color.r * 255;","buffer[ colorOffset + 1 ] = material.color.g * 255;","buffer[ colorOffset + 2 ] = material.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n"),o=new Function("buffer, depthBuf, offset, depth, u, v, n, face, material",s)}else{var s=["var colorOffset = offset * 4;","buffer[ colorOffset ] = u * 255;","buffer[ colorOffset + 1 ] = v * 255;","buffer[ colorOffset + 2 ] = 0;","buffer[ colorOffset + 3 ] = 255;","depthBuf[ offset ] = depth;"].join("\n");o=new Function("buffer, depthBuf, offset, depth, u, v",s)}M[t]=o}return o}function s(e,t,i,r,n,a,o,s,h){if(!(e.z<-1||e.z>1||t.z<-1||t.z>1||i.z<-1||i.z>1)){var u,y,b,S,H,M,C=e.x*f+g|0,k=t.x*f+g|0,D=i.x*f+g|0,z=e.y*m+v|0,F=t.y*m+v|0,U=i.y*m+v|0,K=e.z*E+A|0,Y=t.z*E+A|0,G=i.z*E+A|0,W=!1;r&&n&&a&&(W=!0,u=r.x,y=1-r.y,b=n.x,S=1-n.y,H=a.x,M=1-a.y);var Q,X,J,Z,$,ee,te=!1;s.vertexNormalsModel&&(te=!0,Q=s.vertexNormalsModel[0],X=s.vertexNormalsModel[1],J=s.vertexNormalsModel[2],Z=255*Q.z,$=255*X.z,ee=255*J.z);var ie=C-k,re=F-z,ne=k-D,ae=U-F,oe=D-C,se=z-U,ce=Math.max(Math.min(C,k,D)+j>>B,0),he=Math.min(Math.max(C,k,D)+j>>B,l),le=Math.max(Math.min(z,F,U)+j>>B,0),de=Math.min(Math.max(z,F,U)+j>>B,d);_=Math.min(ce,_),P=Math.max(he,P),I=Math.min(le,I),q=Math.max(de,q);var pe=V;ce&=~(pe-1),le&=~(pe-1);var ue=ce<<B,fe=le<<B,me=re*(ue-C)+ie*(fe-z),Ee=ae*(ue-k)+ne*(fe-F),ge=se*(ue-D)+oe*(fe-U);(re>0||0==re&&ie>0)&&me++,(ae>0||0==ae&&ne>0)&&Ee++,(se>0||0==se&&oe>0)&&ge++,me=me-1>>B,Ee=Ee-1>>B,ge=ge-1>>B;var ve=K-Y,Ae=G-K,ye=1/(ie*se-oe*re),we=ye*(ve*se-Ae*re),Te=ye*(ve*oe-ie*Ae),be=K+(ue-C)*we+(fe-z)*Te|0,Re=1<<B;we=we*Re|0,Te=Te*Re|0;var xe,Se,He,Me;if(W){var Ce=u-b,ke=H-u,Ne=ye*(Ce*se-ke*re),Oe=ye*(Ce*oe-ie*ke),Be=y-S,je=M-y;xe=ye*(Be*se-je*re),Se=ye*(Be*oe-ie*je),He=u+(ue-C)*Ne+(fe-z)*Oe,Me=y+(ue-C)*xe+(fe-z)*Se,Ne*=Re,Oe*=Re,xe*=Re,Se*=Re}var Le,Ve;if(te){var De=Z-$,_e=ee-Z,Ie=ye*(De*se-_e*re),Le=ye*(De*oe-ie*_e);Ve=Z+(ue-C)*Ie+(fe-z)*Le,Ie*=Re,Le*=Re}var Pe=pe-1,qe=0,ze=0,Fe=0,Ue=0,Ke=0,Ye=0,Ge=0,We=0;ie>=0?ze-=Pe*ie:qe-=Pe*ie,re>=0?ze-=Pe*re:qe-=Pe*re,ne>=0?Ue-=Pe*ne:Fe-=Pe*ne,ae>=0?Ue-=Pe*ae:Fe-=Pe*ae,oe>=0?Ye-=Pe*oe:Ke-=Pe*oe,se>=0?Ye-=Pe*se:Ke-=Pe*se,we>=0?We+=Pe*we:Ge+=Pe*we,Te>=0?We+=Pe*Te:Ge+=Pe*Te;var Qe,Xe,Je=l-pe,Ze=me,$e=Ee,et=ge,tt=be,it=-pe,rt=it*re,nt=it*ae,at=it*se,ot=it*we;W&&(Qe=it*Ne,Xe=it*xe);var st;te&&(st=it*Ie);for(var ct=ce,ht=le;de>ht;ht+=pe){for(;ct>=ce&&he>ct&&Ze>=ze&&$e>=Ue&&et>=Ye;)ct+=it,Ze+=rt,$e+=nt,et+=at,tt+=ot,W&&(He+=Qe,Me+=Xe),te&&(Ve+=st);for(it=-it,rt=-rt,nt=-nt,at=-at,ot=-ot,W&&(Qe=-Qe,Xe=-Xe),te&&(st=-st);;){if(ct+=it,Ze+=rt,$e+=nt,et+=at,tt+=ot,W&&(He+=Qe,Me+=Xe),te&&(Ve+=st),ce>ct||ct>=he)break;if(ze>Ze){if(0>rt)break}else if(Ue>$e){if(0>nt)break}else if(Ye>et){if(0>at)break}else{var lt=ct>>L,dt=ht>>L,pt=lt+dt*p,ut=tt+Ge;if(!(R[pt]<ut)){var ft=x[pt];ft&O&&c(lt,dt),x[pt]=ft&~(N|O);var mt=ct+ht*l;if(Ze>=qe&&$e>=Fe&&et>=Ke){var Et=tt+We;R[pt]=Math.min(R[pt],Et);var gt,vt,At=Ze,yt=$e,wt=tt;W&&(gt=He,vt=Me);var Tt;te&&(Tt=Ve);for(var bt=0;pe>bt;bt++){var Rt,xt,St=At,Ht=yt,Mt=wt;W&&(Rt=gt,xt=vt);var Ct;te&&(Ct=Tt);for(var kt=0;pe>kt;kt++){var Nt=Mt;Nt<T[mt]&&o(w,T,mt,Nt,Rt,xt,Ct,s,h),St+=re,Ht+=ae,Mt+=we,W&&(Rt+=Ne,xt+=xe),te&&(Ct+=Ie),mt++}At+=ie,yt+=ne,wt+=Te,W&&(gt+=Oe,vt+=Se),te&&(Tt+=Le),mt+=Je}}else{var gt,vt,At=Ze,yt=$e,Ot=et,wt=tt;W&&(gt=He,vt=Me);var Tt;te&&(Tt=Ve);for(var bt=0;pe>bt;bt++){var Rt,xt,St=At,Ht=yt,Bt=Ot,Mt=wt;W&&(Rt=gt,xt=vt);var Ct;te&&(Ct=Tt);for(var kt=0;pe>kt;kt++){if((St|Ht|Bt)>=0){var Nt=Mt;Nt<T[mt]&&o(w,T,mt,Nt,Rt,xt,Ct,s,h)}St+=re,Ht+=ae,Bt+=se,Mt+=we,W&&(Rt+=Ne,xt+=xe),te&&(Ct+=Ie),mt++}At+=ie,yt+=ne,Ot+=oe,wt+=Te,W&&(gt+=Oe,vt+=Se),te&&(Tt+=Le),mt+=Je}}}}}Ze+=pe*ie,$e+=pe*ne,et+=pe*oe,tt+=pe*Te,W&&(He+=pe*Oe,Me+=pe*Se),te&&(Ve+=pe*Le)}}}function c(e,t){for(var i=e*V+t*V*l,r=4*i,n=l-V,a=4*n,o=0;V>o;o++){for(var s=0;V>s;s++)T[i++]=D,w[r++]=255*k.r|0,w[r++]=255*k.g|0,w[r++]=255*k.b|0,w[r++]=255;i+=n,r+=a}}function h(){for(var e=0,t=0;u>t;t++)for(var i=0;p>i;i++)x[e]&O&&(c(i,t),x[e]=N),e++}console.log("THREE.SoftwareRenderer",THREE.REVISION),e=e||{};var l,d,p,u,f,m,E,g,v,A,y,w,T,b,R,x,S=void 0!==e.canvas?e.canvas:document.createElement("canvas"),H=S.getContext("2d",{alpha:e.alpha===!0}),M={},C={},k=new THREE.Color(0),N=1,O=2,B=4,j=(1<<B)-1,L=3,V=1<<L,D=1<<24,_=1/0,I=1/0,P=0,q=0,z=1/0,F=1/0,U=0,K=0,Y=new THREE.Projector,G=new THREE.Vector3,W=new THREE.Vector3,Q=new THREE.Vector3,X=new THREE.Vector2,J=new THREE.Vector2,Z=new THREE.Vector2;this.domElement=S,this.autoClear=!0,this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.setClearColor=function(e,i){k.set(e),t()},this.setPixelRatio=function(){},this.setSize=function(e,i){p=Math.floor(e/V),u=Math.floor(i/V),l=p*V,d=u*V;var r=1<<B;f=r*l/2,m=-r*d/2,E=D/2,g=r*l/2+.5,v=r*d/2+.5,A=D/2+.5,S.width=l,S.height=d,H.fillStyle=k.getStyle(),H.fillRect(0,0,l,d),y=H.getImageData(0,0,l,d),w=y.data,T=new Int32Array(w.length/4),b=p*u,R=new Int32Array(b),x=new Uint8Array(b);for(var n=0,a=T.length;a>n;n++)T[n]=D;for(var n=0;b>n;n++)x[n]=N;t()},this.setSize(S.width,S.height),this.clear=function(){_=1/0,I=1/0,P=0,q=0;for(var e=0;b>e;e++)R[e]=D,x[e]=x[e]&N?N:O},this.render=function(e,t){this.autoClear===!0&&this.clear();for(var i=Y.projectScene(e,t,!1,!1),r=i.elements,n=0,a=r.length;a>n;n++){var c=r[n],l=c.material,d=o(l);if(c instanceof THREE.RenderableFace)c.uvs?s(c.v1.positionScreen,c.v2.positionScreen,c.v3.positionScreen,c.uvs[0],c.uvs[1],c.uvs[2],d,c,l):s(c.v1.positionScreen,c.v2.positionScreen,c.v3.positionScreen,null,null,null,d,c,l);else if(c instanceof THREE.RenderableSprite){var p=.5*c.scale.x,u=.5*c.scale.y;G.copy(c),G.x-=p,G.y+=u,W.copy(c),W.x-=p,W.y-=u,Q.copy(c),Q.x+=p,Q.y+=u,l.map?(X.set(0,1),J.set(0,0),Z.set(1,1),s(G,W,Q,X,J,Z,d,c,l)):s(G,W,Q,null,null,null,d,c,l),G.copy(c),G.x+=p,G.y+=u,W.copy(c),W.x-=p,W.y-=u,Q.copy(c),Q.x+=p,Q.y-=u,l.map?(X.set(1,1),J.set(0,0),Z.set(1,0),s(G,W,Q,X,J,Z,d,c,l)):s(G,W,Q,null,null,null,d,c,l)}}h();var f=Math.min(_,z),m=Math.min(I,F),E=Math.max(P,U)-f,g=Math.max(q,K)-m;f!==1/0&&H.putImageData(y,0,0,f,m,E,g),z=_,F=I,U=P,K=q}},THREE.SoftwareRenderer.Texture=function(){var e;this.fromImage=function(t){if(!(!t||t.width<=0||t.height<=0)){void 0===e&&(e=document.createElement("canvas"));var i=t.width>t.height?t.width:t.height;i=THREE.Math.nextPowerOfTwo(i),e.width==i&&e.height==i||(e.width=i,e.height=i);var r=e.getContext("2d");r.clearRect(0,0,i,i),r.drawImage(t,0,0,i,i);var n=r.getImageData(0,0,i,i);this.data=n.data,this.width=i,this.height=i,this.srcUrl=t.src}}},THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null},THREE.Projector=function(){function e(){if(c===A){var e=new THREE.RenderableObject;return v.push(e),A++,c++,e}return v[c++]}function t(){if(l===w){var e=new THREE.RenderableVertex;return y.push(e),w++,l++,e}return y[l++]}function i(){if(p===b){var e=new THREE.RenderableFace;return T.push(e),b++,p++,e}return T[p++]}function r(){if(f===x){var e=new THREE.RenderableLine;return R.push(e),x++,f++,e}return R[f++]}function n(){if(E===H){var e=new THREE.RenderableSprite;return S.push(e),H++,E++,e}return S[E++]}function a(e,t){return e.z!==t.z?t.z-e.z:e.id!==t.id?e.id-t.id:0}function o(e,t){var i=0,r=1,n=e.z+e.w,a=t.z+t.w,o=-e.z+e.w,s=-t.z+t.w;return n>=0&&a>=0&&o>=0&&s>=0?!0:0>n&&0>a||0>o&&0>s?!1:(0>n?i=Math.max(i,n/(n-a)):0>a&&(r=Math.min(r,n/(n-a))),0>o?i=Math.max(i,o/(o-s)):0>s&&(r=Math.min(r,o/(o-s))),i>r?!1:(e.lerp(t,i),t.lerp(e,1-r),!0))}var s,c,h,l,d,p,u,f,m,E,g,v=[],A=0,y=[],w=0,T=[],b=0,R=[],x=0,S=[],H=0,M={objects:[],lights:[],elements:[]},C=new THREE.Vector3,k=new THREE.Vector4,N=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),O=new THREE.Box3,B=new Array(3),j=(new Array(4),new THREE.Matrix4),L=new THREE.Matrix4,V=new THREE.Matrix4,D=new THREE.Matrix3,_=new THREE.Frustum,I=new THREE.Vector4,P=new THREE.Vector4;this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pickingRay=function(e,t){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var q=function(){var e=[],n=[],a=null,o=null,s=new THREE.Matrix3,c=function(t){a=t,o=a.material,s.getNormalMatrix(a.matrixWorld),e.length=0,n.length=0},l=function(e){var t=e.position,i=e.positionWorld,r=e.positionScreen;i.copy(t).applyMatrix4(g),r.copy(i).applyMatrix4(L);var n=1/r.w;r.x*=n,r.y*=n,r.z*=n,e.visible=r.x>=-1&&r.x<=1&&r.y>=-1&&r.y<=1&&r.z>=-1&&r.z<=1},p=function(e,i,r){h=t(),h.position.set(e,i,r),l(h)},f=function(t,i,r){e.push(t,i,r)},m=function(e,t){n.push(e,t)},E=function(e,t,i){return e.visible===!0||t.visible===!0||i.visible===!0?!0:(B[0]=e.positionScreen,B[1]=t.positionScreen,B[2]=i.positionScreen,N.isIntersectionBox(O.setFromPoints(B)))},v=function(e,t,i){return(i.positionScreen.x-e.positionScreen.x)*(t.positionScreen.y-e.positionScreen.y)-(i.positionScreen.y-e.positionScreen.y)*(t.positionScreen.x-e.positionScreen.x)<0},A=function(e,t){var i=y[e],n=y[t];u=r(),u.id=a.id,u.v1.copy(i),u.v2.copy(n),u.z=(i.positionScreen.z+n.positionScreen.z)/2,u.material=a.material,M.elements.push(u)},w=function(t,r,c){var h=y[t],l=y[r],p=y[c];if(E(h,l,p)!==!1&&(o.side===THREE.DoubleSide||v(h,l,p)===!0)){d=i(),d.id=a.id,d.v1.copy(h),d.v2.copy(l),d.v3.copy(p),d.z=(h.positionScreen.z+l.positionScreen.z+p.positionScreen.z)/3;for(var u=0;3>u;u++){var f=3*arguments[u],m=d.vertexNormalsModel[u];m.set(e[f],e[f+1],e[f+2]),m.applyMatrix3(s).normalize();var g=2*arguments[u],A=d.uvs[u];A.set(n[g],n[g+1])}d.vertexNormalsLength=3,d.material=a.material,M.elements.push(d)}};return{setObject:c,projectVertex:l,checkTriangleVisibility:E,checkBackfaceCulling:v,pushVertex:p,pushNormal:f,pushUv:m,pushLine:A,pushTriangle:w}},z=new q;this.projectScene=function(h,v,A,w){p=0,f=0,E=0,M.elements.length=0,h.autoUpdate===!0&&h.updateMatrixWorld(),void 0===v.parent&&v.updateMatrixWorld(),j.copy(v.matrixWorldInverse.getInverse(v.matrixWorld)),L.multiplyMatrices(v.projectionMatrix,j),_.setFromMatrix(L),c=0,M.objects.length=0,M.lights.length=0,h.traverseVisible(function(t){if(t instanceof THREE.Light)M.lights.push(t);else if(t instanceof THREE.Mesh||t instanceof THREE.Line||t instanceof THREE.Sprite){if(t.material.visible===!1)return;t.frustumCulled!==!1&&_.intersectsObject(t)!==!0||(s=e(),s.id=t.id,s.object=t,C.setFromMatrixPosition(t.matrixWorld),C.applyProjection(L),s.z=C.z,M.objects.push(s))}}),A===!0&&M.objects.sort(a);for(var T=0,b=M.objects.length;b>T;T++){var R=M.objects[T].object,x=R.geometry;if(z.setObject(R),g=R.matrixWorld,l=0,R instanceof THREE.Mesh){if(x instanceof THREE.BufferGeometry){var S=x.attributes,H=x.offsets;if(void 0===S.position)continue;for(var N=S.position.array,O=0,B=N.length;B>O;O+=3)z.pushVertex(N[O],N[O+1],N[O+2]);if(void 0!==S.normal)for(var q=S.normal.array,O=0,B=q.length;B>O;O+=3)z.pushNormal(q[O],q[O+1],q[O+2]);if(void 0!==S.uv)for(var F=S.uv.array,O=0,B=F.length;B>O;O+=2)z.pushUv(F[O],F[O+1]);if(void 0!==S.index){var U=S.index.array;if(H.length>0)for(var T=0;T<H.length;T++)for(var K=H[T],Y=K.index,O=K.start,B=K.start+K.count;B>O;O+=3)z.pushTriangle(U[O]+Y,U[O+1]+Y,U[O+2]+Y);else for(var O=0,B=U.length;B>O;O+=3)z.pushTriangle(U[O],U[O+1],U[O+2])}else for(var O=0,B=N.length/3;B>O;O+=3)z.pushTriangle(O,O+1,O+2)}else if(x instanceof THREE.Geometry){var G=x.vertices,W=x.faces,Q=x.faceVertexUvs[0];D.getNormalMatrix(g);for(var X=R.material,J=X instanceof THREE.MeshFaceMaterial,Z=J===!0?R.material:null,$=0,ee=G.length;ee>$;$++){var te=G[$];if(C.copy(te),X.morphTargets===!0)for(var ie=x.morphTargets,re=R.morphTargetInfluences,ne=0,ae=ie.length;ae>ne;ne++){var oe=re[ne];if(0!==oe){var se=ie[ne],ce=se.vertices[$];C.x+=(ce.x-te.x)*oe,C.y+=(ce.y-te.y)*oe,C.z+=(ce.z-te.z)*oe}}z.pushVertex(C.x,C.y,C.z)}for(var he=0,le=W.length;le>he;he++){var de=W[he],X=J===!0?Z.materials[de.materialIndex]:R.material;if(void 0!==X){var pe=X.side,ue=y[de.a],fe=y[de.b],me=y[de.c];if(z.checkTriangleVisibility(ue,fe,me)!==!1){var Ee=z.checkBackfaceCulling(ue,fe,me);if(pe!==THREE.DoubleSide){if(pe===THREE.FrontSide&&Ee===!1)continue;if(pe===THREE.BackSide&&Ee===!0)continue}d=i(),d.id=R.id,d.v1.copy(ue),d.v2.copy(fe),d.v3.copy(me),d.normalModel.copy(de.normal),Ee!==!1||pe!==THREE.BackSide&&pe!==THREE.DoubleSide||d.normalModel.negate(),d.normalModel.applyMatrix3(D).normalize();for(var ge=de.vertexNormals,ve=0,Ae=Math.min(ge.length,3);Ae>ve;ve++){var ye=d.vertexNormalsModel[ve];ye.copy(ge[ve]),Ee!==!1||pe!==THREE.BackSide&&pe!==THREE.DoubleSide||ye.negate(),ye.applyMatrix3(D).normalize()}d.vertexNormalsLength=ge.length;var we=Q[he];if(void 0!==we)for(var Te=0;3>Te;Te++)d.uvs[Te].copy(we[Te]);d.color=de.color,d.material=X,d.z=(ue.positionScreen.z+fe.positionScreen.z+me.positionScreen.z)/3,M.elements.push(d)}}}}}else if(R instanceof THREE.Line){if(x instanceof THREE.BufferGeometry){var S=x.attributes;if(void 0!==S.position){for(var N=S.position.array,O=0,B=N.length;B>O;O+=3)z.pushVertex(N[O],N[O+1],N[O+2]);if(void 0!==S.index)for(var U=S.index.array,O=0,B=U.length;B>O;O+=2)z.pushLine(U[O],U[O+1]);else for(var be=R.mode===THREE.LinePieces?2:1,O=0,B=N.length/3-1;B>O;O+=be)z.pushLine(O,O+1)}}else if(x instanceof THREE.Geometry){V.multiplyMatrices(L,g);var G=R.geometry.vertices;if(0===G.length)continue;ue=t(),ue.positionScreen.copy(G[0]).applyMatrix4(V);for(var be=R.mode===THREE.LinePieces?2:1,$=1,ee=G.length;ee>$;$++)ue=t(),ue.positionScreen.copy(G[$]).applyMatrix4(V),($+1)%be>0||(fe=y[l-2],I.copy(ue.positionScreen),P.copy(fe.positionScreen),o(I,P)===!0&&(I.multiplyScalar(1/I.w),P.multiplyScalar(1/P.w),u=r(),u.id=R.id,u.v1.positionScreen.copy(I),u.v2.positionScreen.copy(P),u.z=Math.max(I.z,P.z),u.material=R.material,R.material.vertexColors===THREE.VertexColors&&(u.vertexColors[0].copy(R.geometry.colors[$]),u.vertexColors[1].copy(R.geometry.colors[$-1])),M.elements.push(u)))}}else if(R instanceof THREE.Sprite){k.set(g.elements[12],g.elements[13],g.elements[14],1),k.applyMatrix4(L);var Re=1/k.w;k.z*=Re,k.z>=-1&&k.z<=1&&(m=n(),m.id=R.id,m.x=k.x*Re,m.y=k.y*Re,m.z=k.z,m.object=R,m.rotation=R.rotation,m.scale.x=R.scale.x*Math.abs(m.x-(k.x+v.projectionMatrix.elements[0])/(k.w+v.projectionMatrix.elements[12])),m.scale.y=R.scale.y*Math.abs(m.y-(k.y+v.projectionMatrix.elements[5])/(k.w+v.projectionMatrix.elements[13])),m.material=R.material,M.elements.push(m))}}return w===!0&&M.elements.sort(a),M}};var Sequencer=function(e){this.renderer=null,this.debug_=!!e,this.updateState_=this.STATES_.DONE,this.renderingState_=this.STATES_.DONE,Utils.makeAvailableForDebug("Sequencer",this)};Sequencer.prototype.STATES_={CONTINUOUS:"continuous",DONE:"done",ONCE:"once"},Sequencer.prototype.start=function(){this.raf_()},Sequencer.prototype.stop=function(){cancelAnimationFrame(this.rafId_)},Sequencer.prototype.raf_=function(){this.rafId_=requestAnimationFrame(this.raf_.bind(this)),this.log("raf"),this.updateState_!=this.STATES_.DONE&&(this.renderer.update(),this.updateState_==this.STATES_.ONCE&&(this.updateState_=this.STATES_.DONE)),this.renderingState_!=this.STATES_.DONE&&(this.renderer.draw(),this.renderingState_==this.STATES_.ONCE&&(this.renderingState_=this.STATES_.DONE))},Sequencer.prototype.requestSingleRender=function(){this.log("requestSingleRender"),this.renderingState_=this.STATES_.ONCE},Sequencer.prototype.requestContinuousRendering=function(){this.log("requestContinuousRendering"),this.renderingState_=this.STATES_.CONTINUOUS},Sequencer.prototype.isContinuouslyRendering=function(){return this.renderingState_==this.STATES_.CONTINUOUS},Sequencer.prototype.requestStopRendering=function(){this.log("requestStopRendering"),this.renderingState_=this.STATES_.DONE},Sequencer.prototype.requestSingleUpdate=function(){this.log("requestSingleUpdate"),this.updateState_=this.STATES_.ONCE},Sequencer.prototype.requestContinuousUpdating=function(){this.log("requestContinuousUpdating"),this.updateState_=this.STATES_.CONTINUOUS},Sequencer.prototype.requestStopUpdating=function(){this.log("requestStopUpdating"),this.updateState_=this.STATES_.DONE},Sequencer.prototype.log=function(){if(this.debug_){var e=Array.prototype.slice.call(arguments);e.unshift("Sequencer log -"),console.log.apply(console,e)}};var Renderer3d=function(e,t,i,r,n,a,o){this.sequencer=e,this.kicker=t,this.data=this.kicker.model.data,this.canvasEl=i,this.canvas2dEl=a,this.blueprintBorderRenderer=new BlueprintBorderRenderer(a),this.mergedCanvasEl=o,this.mergedRenderer=new MergedRenderer(i,a,o),this.imageList=r,this.config=n,this.parts=null,this.rafId=null,this.drawCounter=0,this.VRstate=!1,this.elapsedTime=0,this.VRCameraTarget=new THREE.Vector3(1.5,.5,0),this.VRCameraTimeConstant=5e-4,this.models={board:new THREE.Object3D},Utils.makeAvailableForDebug("renderer3d",this)};Renderer3d.prototype.onStateChange=function(e){switch(e){case EditorState.NEW:this.init()}},Renderer3d.prototype.init=function(){this.scene=EditorScene.getScene(),Utils.makeAvailableForDebug("scene",this.scene),this.createKicker(),this.createCameras(),this.VRControls=new THREE.DeviceOrientationControls,this.threeRenderer=EditorScene.getRenderer(this.canvasEl),this.stereoRenderer=new THREE.StereoEffect(this.threeRenderer),this.onVRStateUpdate(),this.setVisibleObjects(),this.resize(),this.sequencer.start()},Renderer3d.prototype.setVRState=function(e){this.VRstate=e,this.onVRStateUpdate()},Renderer3d.prototype.onVRStateUpdate=function(){this.VRstate?(this.elapsedTime=0,this.VRControls.connect(this),this.orbitControls.enabled=!1,this.threeRenderer.autoClear=!1,this.renderContinuously(),this.sequencer.requestContinuousUpdating()):(this.VRControls.disconnect(),this.orbitControls.enabled=!0,this.threeRenderer.autoClear=!0,this.stopRendering(),this.sequencer.requestStopUpdating())},Renderer3d.prototype.replaceModel=function(e,t){this.models[e]=t,this.refresh()},Renderer3d.prototype.getModel=function(e){if(!e in this.models)throw new Error("No model exists with name",e);return this.models[e]},Renderer3d.prototype.renderOnce=function(){this.sequencer.isContinuouslyRendering()||this.sequencer.requestSingleRender()},Renderer3d.prototype.renderContinuously=function(){this.sequencer.requestContinuousRendering()},Renderer3d.prototype.stopRendering=function(){this.sequencer.requestStopRendering()},Renderer3d.prototype.update=function(){this.VRstate||this.orbitControls.enabled&&this.orbitControls.autorotate&&(console.log("calling orbitControls.update"),this.orbitControls.update())},Renderer3d.prototype.draw=function(){this.VRstate?this.stereoRenderer.render(this.scene,this.camera):this.threeRenderer.render(this.scene,this.camera),this.blueprintBorderRenderer.render()},Renderer3d.prototype.refresh=function(){this.kicker.refresh(),this.createKicker(),"2d"==this.data.get("repType")&&this.prepareCameras(),this.setVisibleObjects(),this.renderOnce()},Renderer3d.prototype.createCameras=function(){this.cameras=EditorScene.createCameras(this.canvasEl,this.kickerObj),this.orbitControls=new THREE.OrbitControls(this.cameras.perspective,this.canvasEl),this.orbitControls.zoomSpeed=.3,this.orbitControls.maxDistance=12,this.orbitControls.minDistance=2.5,Utils.makeAvailableForDebug("orbitControls",this.orbitControls),this.orbitControls.addEventListener("start",this.onOrbitStart.bind(this)),this.orbitControls.addEventListener("end",this.onOrbitEnd.bind(this))},Renderer3d.prototype.onOrbitStart=function(e){this.renderContinuously()},Renderer3d.prototype.onOrbitEnd=function(e){this.orbitControls.update(),this.renderOnce()},Renderer3d.prototype.updateViz=function(e){for(prop in e)e.hasOwnProperty(prop)&&this.data.set(prop,e[prop]);this.setVisibleObjects(),this.renderOnce()},Renderer3d.prototype.setVisibleObjects=function(){var e=this.kicker.getRepresentation3d(),t=this.data;Utils.iterateOverParts(e.parts,function(e){e.setMeshVisibilityForDisplay(t)}),this.prepareCameras()},Renderer3d.prototype.pickCamera=function(){"2d"==this.data.get("repType")?(this.camera=this.cameras.ortho,this.orbitControls.enabled=!1):(this.camera=this.cameras.perspective,this.orbitControls.target.copy(this.cameraTarget.position),this.orbitControls.update(),this.orbitControls.enabled=!this.VRstate),Utils.makeAvailableForDebug("camera",this.camera)},Renderer3d.prototype.resize=function(){var e=this.canvasEl.parentElement;this.threeRenderer.setSize(e.clientWidth,e.clientHeight,!1),this.stereoRenderer.setSize(e.clientWidth,e.clientHeight,!1),this.stereoRenderer.separation=.03175,this.prepareCameras(),this.blueprintBorderRenderer.resize(),this.mergedRenderer.resize(),this.renderOnce()},Renderer3d.prototype.prepareCameras=function(){this.createCameras(),this.pickCamera()},Renderer3d.prototype.createKicker=function(){this.kickerObj&&this.scene.remove(this.kickerObj),this.kickerObj=EditorScene.createKicker(this.kicker,this.config,this.imageList,this),this.cameraTarget=new THREE.AxisHelper(1),this.kickerObj.add(this.cameraTarget),this.cameraTarget.visible=!1,this.cameraTarget.position.x=this.kicker.model.length/2,this.scene.add(this.kickerObj)},Renderer3d.prototype.getDataForSaving=function(){return this.data.getDataForSaving()},Renderer3d.prototype.setUnits=function(e){this.config.units=e,this.kicker.getRepresentation3d().setConfig(this.config),this.refresh()};var BlueprintBorderRenderer=function(e){this.canvasEl=e};BlueprintBorderRenderer.prototype.render=function(){if(this.canvasEl){var e=this.canvasEl.getContext("2d");e.strokeStyle="#f8faff";var t=this.canvasEl.parentElement,i=t.clientWidth,r=t.clientHeight;e.strokeRect(0,0,i,r);for(var n=4,a=4,o=1,s=10,c=(i-(a-1)-2*o)/a,h=1,l=a;l>h;h++){var d=c*h|0;e.beginPath(),e.moveTo(d,0),e.lineTo(d,s),e.stroke(),e.beginPath(),e.moveTo(d,r),e.lineTo(d,r-s),e.stroke()}for(var p=(r-(n-1)-2*o)/n,h=1,l=n;l>h;h++){var u=p*h|0;e.beginPath(),e.moveTo(0,u),e.lineTo(s,u),e.stroke(),e.beginPath(),e.moveTo(i,u),e.lineTo(i-s,u),e.stroke()}}},BlueprintBorderRenderer.prototype.resize=function(){var e=this.canvasEl.parentElement;this.canvasEl.width=e.clientWidth,this.canvasEl.height=e.clientHeight};var MergedRenderer=function(e,t,i){this.canvas3dEl=e,this.canvas2dEl=t,this.mergedCanvasEl=i};MergedRenderer.prototype.resize=function(){var e=this.mergedCanvasEl.parentElement;this.mergedCanvasEl.width=e.clientWidth*window.devicePixelRatio,this.mergedCanvasEl.height=e.clientHeight*window.devicePixelRatio},MergedRenderer.prototype.getData=function(e){var t=this.mergedCanvasEl.getContext("2d");return t.clearRect(0,0,this.mergedCanvasEl.width,this.mergedCanvasEl.height),e.fill&&(t.fillStyle="#3B69D5",t.fillRect(0,0,this.mergedCanvasEl.width,this.mergedCanvasEl.height)),t.drawImage(this.canvas3dEl,10,10),e.borders&&t.drawImage(this.canvas2dEl,10,10,this.mergedCanvasEl.width-20,this.mergedCanvasEl.height-20),this.mergedCanvasEl.toDataURL()};var WakeLock=function(){function e(e,t){return"data:"+e+";base64,"+t}function t(){var t=document.createElement("video");t.addEventListener("ended",function(){console.log("video end, restart"),t.play()}),this.request=function(){t.paused&&(console.log("video start"),t.src=e("video/webm","GkXfowEAAAAAAAAfQoaBAUL3gQFC8oEEQvOBCEKChHdlYm1Ch4ECQoWBAhhTgGcBAAAAAAAH4xFNm3RALE27i1OrhBVJqWZTrIHfTbuMU6uEFlSua1OsggEwTbuMU6uEHFO7a1OsggfG7AEAAAAAAACkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAVSalmAQAAAAAAAEUq17GDD0JATYCNTGF2ZjU2LjQwLjEwMVdBjUxhdmY1Ni40MC4xMDFzpJAGSJTMbsLpDt/ySkipgX1fRImIQO1MAAAAAAAWVK5rAQAAAAAAADuuAQAAAAAAADLXgQFzxYEBnIEAIrWcg3VuZIaFVl9WUDmDgQEj44OEO5rKAOABAAAAAAAABrCBsLqBkB9DtnUBAAAAAAAAo+eBAKOmgQAAgKJJg0IAAV4BHsAHBIODCoAACmH2MAAAZxgz4dPSTFi5JACjloED6ACmAECSnABMQAADYAAAWi0quoCjloEH0ACmAECSnABNwAADYAAAWi0quoCjloELuACmAECSnABNgAADYAAAWi0quoCjloEPoACmAECSnABNYAADYAAAWi0quoCjloETiACmAECSnABNIAADYAAAWi0quoAfQ7Z1AQAAAAAAAJTnghdwo5aBAAAApgBAkpwATOAAA2AAAFotKrqAo5aBA+gApgBAkpwATMAAA2AAAFotKrqAo5aBB9AApgBAkpwATIAAA2AAAFotKrqAo5aBC7gApgBAkpwATEAAA2AAAFotKrqAo5aBD6AApgDAkpwAQ2AAA2AAAFotKrqAo5aBE4gApgBAkpwATCAAA2AAAFotKrqAH0O2dQEAAAAAAACU54Iu4KOWgQAAAKYAQJKcAEvAAANgAABaLSq6gKOWgQPoAKYAQJKcAEtgAANgAABaLSq6gKOWgQfQAKYAQJKcAEsAAANgAABaLSq6gKOWgQu4AKYAQJKcAEqAAANgAABaLSq6gKOWgQ+gAKYAQJKcAEogAANgAABaLSq6gKOWgROIAKYAQJKcAEnAAANgAABaLSq6gB9DtnUBAAAAAAAAlOeCRlCjloEAAACmAECSnABJgAADYAAAWi0quoCjloED6ACmAECSnABJIAADYAAAWi0quoCjloEH0ACmAMCSnABDYAADYAAAWi0quoCjloELuACmAECSnABI4AADYAAAWi0quoCjloEPoACmAECSnABIoAADYAAAWi0quoCjloETiACmAECSnABIYAADYAAAWi0quoAfQ7Z1AQAAAAAAAJTngl3Ao5aBAAAApgBAkpwASCAAA2AAAFotKrqAo5aBA+gApgBAkpwASAAAA2AAAFotKrqAo5aBB9AApgBAkpwAR8AAA2AAAFotKrqAo5aBC7gApgBAkpwAR4AAA2AAAFotKrqAo5aBD6AApgBAkpwAR2AAA2AAAFotKrqAo5aBE4gApgBAkpwARyAAA2AAAFotKrqAH0O2dQEAAAAAAACU54J1MKOWgQAAAKYAwJKcAENgAANgAABaLSq6gKOWgQPoAKYAQJKcAEbgAANgAABaLSq6gKOWgQfQAKYAQJKcAEagAANgAABaLSq6gKOWgQu4AKYAQJKcAEaAAANgAABaLSq6gKOWgQ+gAKYAQJKcAEZAAANgAABaLSq6gKOWgROIAKYAQJKcAEYAAANgAABaLSq6gB9DtnUBAAAAAAAAlOeCjKCjloEAAACmAECSnABF4AADYAAAWi0quoCjloED6ACmAECSnABFwAADYAAAWi0quoCjloEH0ACmAECSnABFoAADYAAAWi0quoCjloELuACmAECSnABFgAADYAAAWi0quoCjloEPoACmAMCSnABDYAADYAAAWi0quoCjloETiACmAECSnABFYAADYAAAWi0quoAfQ7Z1AQAAAAAAAJTngqQQo5aBAAAApgBAkpwARUAAA2AAAFotKrqAo5aBA+gApgBAkpwARSAAA2AAAFotKrqAo5aBB9AApgBAkpwARQAAA2AAAFotKrqAo5aBC7gApgBAkpwARQAAA2AAAFotKrqAo5aBD6AApgBAkpwAROAAA2AAAFotKrqAo5aBE4gApgBAkpwARMAAA2AAAFotKrqAH0O2dQEAAAAAAACU54K7gKOWgQAAAKYAQJKcAESgAANgAABaLSq6gKOWgQPoAKYAQJKcAESAAANgAABaLSq6gKOWgQfQAKYAwJKcAENgAANgAABaLSq6gKOWgQu4AKYAQJKcAERgAANgAABaLSq6gKOWgQ+gAKYAQJKcAERAAANgAABaLSq6gKOWgROIAKYAQJKcAEQgAANgAABaLSq6gB9DtnUBAAAAAAAAlOeC0vCjloEAAACmAECSnABEIAADYAAAWi0quoCjloED6ACmAECSnABEAAADYAAAWi0quoCjloEH0ACmAECSnABD4AADYAAAWi0quoCjloELuACmAECSnABDwAADYAAAWi0quoCjloEPoACmAECSnABDoAADYAAAWi0quoCjloETiACmAECSnABDgAADYAAAWi0quoAcU7trAQAAAAAAABG7j7OBALeK94EB8YIBd/CBAw=="),t.play())},this.release=function(){console.log("video pause"),t.pause(),t.src=""}}function i(){var e=null;this.request=function(){e||(e=setInterval(function(){window.location=window.location,setTimeout(window.stop,0)},3e4))},this.release=function(){e&&(clearInterval(e),e=null)}}var r=navigator.userAgent||navigator.vendor||window.opera;return r.match(/iPhone/i)||r.match(/iPod/i)?i:t}();